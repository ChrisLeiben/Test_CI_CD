///$tab Main
SET ThousandSep=' ';
SET DecimalSep='.';
SET MoneyThousandSep=',';
SET MoneyDecimalSep='.';
SET NumFormat='# ##0;-# ##0';
SET MoneyFormat='# ##0 €;-# ##0 €';
SET TimeFormat='h:mm:ss TT';
SET DateFormat='DD/MM/YYYY';
SET TimestampFormat='DD/MM/YYYY h:mm:ss[.fff]';
SET FirstWeekDay=6;
SET BrokenWeeks=1;
SET ReferenceDay=0;
SET FirstMonthOfYear=1;
SET CollationLocale='en-US';
SET CreateSearchIndexOnReload=0;
SET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';
SET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';
SET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';
SET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';
SET NumericalAbbreviation='3:k;6:M;9:G;12:T;15:P;18:E;21:Z;24:Y;-3:m;-6:μ;-9:n;-12:p;-15:f;-18:a;-21:z;-24:y';

//SET v_FolderQVD_Path  = 'lib://AG - DEV - QVD:DataFiles/';
SET v_FolderQVD_Path  = 'lib://AG - TEST - QVD:DataFiles/';
//SET v_FolderQVD_Path  = 'lib://AG - UAT - QVD:DataFiles/';
//SET v_FolderQVD_Path  = 'lib://AG - PROD - QVD:DataFiles/';

//SET v_FolderQVD_Path_Store  = 'lib://AG - DEV - QVD:DataFiles/';
SET v_FolderQVD_Path_Store  = 'lib://AG - TEST - QVD:DataFiles/';
//SET v_FolderQVD_Path_Store  = 'lib://AG - UAT - QVD:DataFiles/';
//SET v_FolderQVD_Path_Store  = 'lib://AG - PROD - QVD:DataFiles/';
///$tab Variables
SET v_FolderQVDSource_Path  = 'lib://AG - DEV - Sources:DataFiles/';

// Variables
$(Include=[$(v_FolderQVDSource_Path)Variables Libellés.qvs]);

SET v_Environment = 'prod';

/// LINKS ///

SET v_EntityName_Account      = 'account';
SET v_EntityName_Finance      = 'new_finance';
SET v_EntityName_Affaire      = 'ard_affaire';
SET v_EntityName_Contact      = 'contact';
SET v_EntityName_Operation    = 'new_operation';
//SET v_EntityName_Activity     = 'activitypointer';
SET v_EntityName_Appointment  = 'appointment';
SET v_EntityName_Email    	  = 'email';
SET v_EntityName_phonecall    = 'phonecall';
SET v_EntityName_Tag          = 'ard_tag';
SET v_EntityName_Actionnariat = 'new_actionnariat';

SET v_URL_Standard 		 = 'https://ag-$(v_Environment).crm12.dynamics.com';
SET v_URL_Standard_Start = '$(v_URL_Standard)/main.aspx?pagetype=entityrecord&etn=';
SET v_URL_Standard_End 	 = '&id=';

LET vDateFicalOffsetMonth = 3;

// v1.1 - Manage current year to get last CA and EBIT 
LET v_Current_YearStart = (Year(Today())*10000)+100+1;
LET v_Current_Year = Year(Today());
LET v_2014_Year  = 2000;           //  modification 05/09/2019, acienne valeur 2014;//*10000)+100+1;


///$tab Reload Entities
SET sEntityALL = 'ALL';
SET sEntityAccount = 'Account';
SET sEntityActivite = 'Activite';
SET sEntityActionnariat = 'Actionnariat';
SET sEntityActivityParty = 'ActivityParty';
SET sEntityAffaire = 'Affaire';
SET sEntityAffaire_Contact_Intermediaire = 'Affaire_Contact_Intermediaire';
SET sEntityAffaire_Process_Stage = 'Affaire_Process_Stage';
SET sEntityContact = 'Contact';
SET sEntityFinance = 'Finance';
SET sEntityFonds = 'Fonds';
SET sEntityFonds_Concerne = 'Fonds_Concerne';
SET sEntityOperation = 'Operation';
SET sEntitySystemUser = 'SystemUser';
SET sEntityConnectionAllObjects = 'Dim_Connection_AllObjects';
SET sEntityConnection_Roles = 'Connection_Roles';
SET sEntityStringMap = 'StringMap';
SET sEntityTags = 'Tags';
SET sEntityTag_Attribution = 'Tag_Attribution';
SET sEntityVehicle = 'Vehicle';

SET sListEntities = '$(sEntityALL)';
SET QVDFILE_EXTRACT=$(v_FolderQVD_Path)Reload_Times.qvd;
SET QVDFILE_TRANSFO=$(v_FolderQVD_Path_Store)ReloadTimeTransfo.qvd;

ReloadTimeTransfo:
Load
	num(now())	as LastReloadTime
// 	44663	as LastReloadTime
AutoGenerate 1;

IF FileSize('$(QVDFILE_EXTRACT)') > 0 and FileSize('$(QVDFILE_TRANSFO)') > 0 THEN

	LastReloadTimeTransfo:
    NoConcatenate
	Load
		LastReloadTime
	From [$(v_FolderQVD_Path_Store)ReloadTimeTransfo.qvd]
	(qvd);
	
	LET sLastReloadTimeTransfo = Peek('LastReloadTime',-1,'LastReloadTimeTransfo');
	
	EntitiesFile:
	LOAD Distinct
	    Field
	FROM [$(v_FolderQVD_Path)Reload_Times.qvd]
	(qvd)
    Where num(DateTime) >= '$(sLastReloadTimeTransfo)'
    ;

	Entities:
    Load
    	Concat(DISTINCT Field, ', ')	as ListEntities
	Resident EntitiesFile;
    
    LET sListEntities = Peek('ListEntities',-1,'Entities');
    
    Drop Table LastReloadTimeTransfo;
    Drop Table EntitiesFile;
    Drop Table Entities;

END IF

SET sListEntities = '$(sEntityALL)';
// SET sListEntities = '$(sEntityTags)';

///$tab Preparation 20
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*','*$(sEntityFinance)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityOperation)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	Account:
	Load
		accountid,
	    accountcategorycode,
	    accountcategorycode_FormattedValue,
	    name,
	    description,
	    new_objet,
	    ard_secteurcode,
	    ard_secteurcode_FormattedValue,
	    new_datedecreation,
	    ConvertToLocalTime(createdon,'Paris')	as createdon,
        ConvertToLocalTime(modifiedon,'Paris')	as modifiedon,
	    ConvertToLocalTime(ard_formmodifiedon,'Paris')	as ard_formmodifiedon,
	    _ard_formmodifiedbyid_value_FormattedValue,
        _createdby_value_FormattedValue,
        _modifiedby_value_FormattedValue,
	    address1_city,
	    ard_address1_country,
	    ard_address1_country_FormattedValue,
	    new_commentairestatut,
	    ard_straddress1latitude,
	    ard_straddress1longitude,
	    _ownerid_value_FormattedValue,
	    _new_gerant2id_value_FormattedValue,
	    _new_gerant3id_value_FormattedValue,
	    _new_analysteid_value_FormattedValue,
        entityimage_url,
      	ard_datafeed
	FROM [$(v_FolderQVD_Path)Account.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityOperation)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	Affaire:
	Load
		ard_affaireid,
	    _ard_societeid_value,
	    ard_statutaffairecode,
	    ard_dateouverture,
      	ard_datafeed
	FROM [$(v_FolderQVD_Path)Affaire.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityOperation)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	Contact:
	LOAD
	    contactid,
	    _parentcustomerid_value,
        ConvertToLocalTime(modifiedon, 'Paris') as modifiedon,
      	ard_datafeed
	FROM [$(v_FolderQVD_Path)Contact.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

	Contact_Actionnariat:
	LOAD
	    contactid,
	    _parentcustomerid_value,
	    fullname,
	    address1_city,
	    ard_address1_country_FormattedValue,
		ard_straddress1latitude,
	    ard_straddress1longitude,
	    ard_avoirdate,
	    _ownerid_value_FormattedValue,
	    _ard_gerant2id_value_FormattedValue,
	    _ard_gerant3id_value_FormattedValue,
	    emailaddress1,
		jobtitle,
        birthdate,
	    telephone1,
	    _ard_formmodifiedbyid_value_FormattedValue,
	    ConvertToLocalTime(ard_formmodifiedon, 'Paris') as ard_formmodifiedon,
        ConvertToLocalTime(createdon, 'Paris') as createdon,
        _createdby_value_FormattedValue,
		description,
	    mobilephone,
	    ard_lienurl,
	    ard_lienlinkedinurl,
        entityimage_url,
      	ard_datafeed
	FROM [$(v_FolderQVD_Path)Contact.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityActionnariat)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	SystemUser:
	LOAD
		systemuserid,
	    fullname,
	    ard_qlikname,
	    ard_qliktypecode
	FROM [$(v_FolderQVD_Path)SystemUser.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntityOperation)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	Tag_Attribution:
	Load
		_ard_tagid_value,
	    ard_tagattributionid,
	    _ard_affaireid_value,
	    _ard_contactid_value,
	    _ard_accountid_value,
        ConvertToLocalTime(createdon, 'Paris') as createdon,
	    ConvertToLocalTime(modifiedon, 'Paris') as modifiedon,
	    _modifiedby_value_FormattedValue
	FROM [$(v_FolderQVD_Path)Tag_Attribution.qvd]
	(qvd);

	Tags:
	LOAD
	    ard_tagid,
	    ard_name,
	    ard_description,
	    ard_isperimeteraffaire_FormattedValue,
	    ard_isperimetercontact_FormattedValue,
	    ard_isperimetersociete_FormattedValue,
	    ConvertToLocalTime(createdon, 'Paris') as createdon,
	    ConvertToLocalTime(modifiedon, 'Paris') as modifiedon,
        _ard_gerant1id_value,
        _ard_gerant1id_value_FormattedValue
	FROM [$(v_FolderQVD_Path)Tags.qvd]
	(qvd);

End If


///$tab Mappings
Parametre:
LOAD * INLINE [
	#Cle_Parametre, Parametre, Code, Libelle
	Dummy, Dummy, Dummy, Dummy
];

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	// Map 20 Activite
	
	Map_Gerant_Short:
	Mapping Load
	    fullname,
	    ard_qlikname
	Resident SystemUser;
    
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Gerant_Short/' & fullname & '/' & ard_qlikname		as #Cle_Parametre,
//     	'Map_Gerant_Short'										as Parametre,
// 	    fullname												as Code,
// 	    ard_qlikname											as Libelle
// 	Resident SystemUser
//     Where not Exists(#Cle_Parametre, 'Map_Gerant_Short/' & fullname & '/' & ard_qlikname);
	
	Map_Gerant_Type_Activite:
	Mapping Load
	    fullname,
	    ard_qliktypecode
	Resident SystemUser;
    
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Gerant_Type_Activite/' & fullname & '/' & ard_qliktypecode		as #Cle_Parametre,
//     	'Map_Gerant_Type_Activite'											as Parametre,
// 	    fullname															as Code,
// 	    ard_qlikname														as Libelle
// 	Resident SystemUser
//     Where not Exists(#Cle_Parametre, 'Map_Gerant_Type_Activite/' & fullname & '/' & ard_qlikname);
	
	Map_Gerant_Type:
	Mapping LOAD
	    attributevalue,
	    value
	FROM [$(v_FolderQVD_Path)StringMap.qvd]
	(qvd)
	Where attributename = 'ard_qliktypecode';
    
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Gerant_Type/' & attributevalue & '/' & value		as #Cle_Parametre,
//     	'Map_Gerant_Type'										as Parametre,
// 	    attributevalue											as Code,
// 	    value													as Libelle
// 	FROM [$(v_FolderQVD_Path)StringMap.qvd]
// 	(qvd)
// 	Where attributename = 'ard_qliktypecode'
//     and not Exists(#Cle_Parametre, 'Map_Gerant_Type/' & attributevalue & '/' & value);
    
    tmp_Population:
	LOAD * INLINE [
		Libellé, Population
		'$(vCategorieSocieteScope)', '$(vTypePointTarget)'
		'$(vCategorieSocietePortefeuille)', '$(vTypePointTarget)'
		'$(vCategorieSocieteFicheACompleter)', '$(vTypePointTarget)'
		'$(vCategorieSocieteHorsScope)', '$(vTypePointTarget)'
		'$(vCategorieSocieteSortiePortefeuille)', '$(vTypePointTarget)'
		'$(vCategorieSocieteAudit)', '$(vTypePointAdvisor)'
		'$(vCategorieSocieteAutre)', '$(vTypePointAdvisor)'
		'$(vCategorieSocieteAvocat)', '$(vTypePointAdvisor)'
		'$(vCategorieSocieteBanque)', '$(vTypePointAdvisor)'
		'$(vCategorieSocieteMnA)', '$(vTypePointAdvisor)'
		'$(vCategorieSocieteFondsScript)', '$(vTypePointFund)'
		'$(vCategorieSocieteClient)', '$(vTypePointLPs)'
	];
    
    Map_Population:
	Mapping LOAD
    	*
	Resident tmp_Population;
        
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Population/' & Libellé & '/' & Population		as #Cle_Parametre,
    	'Map_Population'									as Parametre,
	    Libellé												as Code,
	    Population											as Libelle
	Resident tmp_Population
	Where not Exists(#Cle_Parametre, 'Map_Population/' & Libellé & '/' & Population);
    
    Drop Table tmp_Population;

EndIf

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityConnectionAllObjects)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

	// Map 20 Affaires
	
	Map_Logo_Account:
	Mapping Load
		accountid,
		entityimage_url    
	Resident Account;
        
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Logo_Account/' & accountid & '/' & entityimage_url		as #Cle_Parametre,
//     	'Map_Logo_Account'											as Parametre,
// 		accountid													as Code,
// 		entityimage_url    											as Libelle
// 	Resident Account
// 	Where not Exists(#Cle_Parametre, 'Map_Logo_Account/' & accountid & '/' & entityimage_url);
	
	Map_Code_Origine_Affaire:
	Mapping Load
		value,
		attributevalue    
	FROM
	[$(v_FolderQVD_Path)StringMap.qvd]
	(qvd)
	Where langid = '1036'
	and attributename = 'ard_origineaffairecode';
        
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Code_Origine_Affaire/' & value & '/' & attributevalue		as #Cle_Parametre,
//     	'Map_Code_Origine_Affaire'										as Parametre,
// 		value															as Code,
// 		attributevalue    												as Libelle
// 	FROM
// 	[$(v_FolderQVD_Path)StringMap.qvd]
// 	(qvd)
// 	Where langid = '1036'
// 	and attributename = 'ard_origineaffairecode'
// 	and not Exists(#Cle_Parametre, 'Map_Code_Origine_Affaire/' & value & '/' & attributevalue);
	
	Map_Code_Statut_Affaire:
	Mapping Load
		value,
		attributevalue    
	FROM
	[$(v_FolderQVD_Path)StringMap.qvd]
	(qvd)
	Where langid = '1036'
	and attributename = 'ard_statutaffairecode';
        
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Code_Statut_Affaire/' & value & '/' & attributevalue		as #Cle_Parametre,
//     	'Map_Code_Statut_Affaire'										as Parametre,
// 		value															as Code,
// 		attributevalue    												as Libelle
// 	FROM
// 	[$(v_FolderQVD_Path)StringMap.qvd]
// 	(qvd)
// 	Where langid = '1036'
// 	and attributename = 'ard_statutaffairecode'
// 	and not Exists(#Cle_Parametre, 'Map_Code_Statut_Affaire/' & value & '/' & attributevalue);

	Statut_Origine_Impossible:
	NoConcatenate
	LOAD * INLINE [
	    Statut, Origine
	    '$(vStatutAffaireQualification)', '$(vOrigineAffaireMnA)'
	    '$(vStatutAffaireAContacter)', '$(vOrigineAffaireMnA)'
	    '$(vStatutAffaireASuivre)', '$(vOrigineAffaireMnA)'
	    '$(vStatutAffaireLongShot)', '$(vOrigineAffaireMnA)'
	    '$(vStatutAffaireQualification)', '$(vOrigineAffaireCoInvestissement)'
	    '$(vStatutAffaireAContacter)', '$(vOrigineAffaireCoInvestissement)'
	    '$(vStatutAffaireARelancer)', '$(vOrigineAffaireCoInvestissement)'
	    '$(vStatutAffaireQualification)', '$(vOrigineAffaireReinvestissement)'
	    '$(vStatutAffaireAContacter)', '$(vOrigineAffaireReinvestissement)'
	    '$(vStatutAffaireARelancer)', '$(vOrigineAffaireReinvestissement)'
	    '$(vStatutAffaireQualification)', '$(vOrigineAffaireSortie)'
	    '$(vStatutAffaireAContacter)', '$(vOrigineAffaireSortie)'
	    '$(vStatutAffaireARelancer)', '$(vOrigineAffaireSortie)'
	    '$(vStatutAffaireASuivre)', '$(vOrigineAffaireSortie)'
	    '$(vStatutAffaireLongShot)', '$(vOrigineAffaireSortie)'
	    '$(vStatutAffaireQualification)', '$(vOrigineAffaireMarche)'
	    '$(vStatutAffaireAContacter)', '$(vOrigineAffaireMarche)'
	    '$(vStatutAffaireARelancer)', '$(vOrigineAffaireMarche)'
	    '$(vStatutAffaireOuvert)', '$(vOrigineAffaireMarche)'
	    '$(vStatutAffaireASuivre)', '$(vOrigineAffaireMarche)'
	];
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Statut_Origine_Impossible/' & Statut & '/' & Origine		as #Cle_Parametre,
    	'Statut_Origine_Impossible'									as Parametre,
		Statut														as Code,
		Origine    													as Libelle
	Resident Statut_Origine_Impossible
	Where not Exists(#Cle_Parametre, 'Statut_Origine_Impossible/' & Statut & '/' & Origine);
	
	Map_Statut_Origine_Impossible:
	MAPPING LOAD
	    ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & ApplyMap('Map_Code_Origine_Affaire',Origine)		as Cle_Combinaison,
	    1																									as Flag_Impossible
	Resident Statut_Origine_Impossible;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Statut_Origine_Impossible/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & ApplyMap('Map_Code_Origine_Affaire',Origine) & '/1'		as #Cle_Parametre,
    	'Map_Statut_Origine_Impossible'																														as Parametre,
		ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & ApplyMap('Map_Code_Origine_Affaire',Origine)														as Code,
		1    																																				as Libelle
	Resident Statut_Origine_Impossible
	Where not Exists(#Cle_Parametre, 'Map_Statut_Origine_Impossible/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & ApplyMap('Map_Code_Origine_Affaire',Origine) & '/1');
	
	Drop Table Statut_Origine_Impossible;
	
	Statut_Etape_Impossible:
	NoConcatenate
	LOAD * INLINE [
		Statut, Etape
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire100)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire200)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire300)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire400)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire500)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire520)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire600)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire700)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire800)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire900)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire910)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire912)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire920)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireQualification)', '$(vEtapeAffaire941)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire100)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire200)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire300)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire400)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire500)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire520)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire600)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire700)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire800)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire900)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire910)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire912)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire920)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireAContacter)', '$(vEtapeAffaire941)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire200)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire300)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire400)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire500)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire520)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire600)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire700)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire800)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire900)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire910)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire912)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire920)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireARelancer)', '$(vEtapeAffaire941)'
	    '$(vStatutAffaireOuvert)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireOuvert)', '$(vEtapeAffaire941)'
	    '$(vStatutAffaireASuivre)', '$(vEtapeAffaire500)'
	    '$(vStatutAffaireASuivre)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireASuivre)', '$(vEtapeAffaire941)'
	    '$(vStatutAffaireLongShot)', '$(vEtapeAffaire500)'
	    '$(vStatutAffaireLongShot)', '$(vEtapeAffaire940)'
	    '$(vStatutAffaireLongShot)', '$(vEtapeAffaire941)'
	];
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Statut_Etape_Impossible/' & Statut & '/' & Etape			as #Cle_Parametre,
    	'Statut_Etape_Impossible'									as Parametre,
		Statut														as Code,
		Etape    													as Libelle
	Resident Statut_Etape_Impossible
	Where not Exists(#Cle_Parametre, 'Statut_Etape_Impossible/' & Statut & '/' & Etape);
	
	Map_Statut_Etape_Impossible:
	MAPPING LOAD
	    ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Etape		as Cle_Combinaison,
	    1																as Flag_Impossible
	Resident Statut_Etape_Impossible;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Statut_Etape_Impossible/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Etape & '/1'		as #Cle_Parametre,
    	'Map_Statut_Etape_Impossible'																			as Parametre,
		ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Etape												as Code,
		1    																									as Libelle
	Resident Statut_Etape_Impossible
	Where not Exists(#Cle_Parametre, 'Map_Statut_Etape_Impossible/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Etape & '/1');
	
	Drop Table Statut_Etape_Impossible;
	
	Phase_Statut_Impossible:
	NoConcatenate
	Load * Inline [
		Phase, Statut
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireAContacter)'
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireARelancer)'
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireOuvert)'
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireASuivre)'
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireLongShot)'
	    '$(vAffairePhasePreQualification)', '$(vStatutAffaireFerme)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireAContacter)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireARelancer)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireOuvert)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireASuivre)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireLongShot)'
	    '$(vAffairePhaseValidation)', '$(vStatutAffaireFerme)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireQualification)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireARelancer)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireOuvert)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireASuivre)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireLongShot)'
	    '$(vAffairePhasePriseContact)', '$(vStatutAffaireFerme)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireQualification)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireAContacter)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireOuvert)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireASuivre)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireLongShot)'
	    '$(vAffairePhaseRelance)', '$(vStatutAffaireFerme)'
	    '$(vAffairePhaseTermine)', '$(vStatutAffaireQualification)'
	    '$(vAffairePhaseTermine)', '$(vStatutAffaireAContacter)'
	    '$(vAffairePhaseTermine)', '$(vStatutAffaireARelancer)'
	];
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Phase_Statut_Impossible/' & Phase & '/' & Statut			as #Cle_Parametre,
    	'Phase_Statut_Impossible'									as Parametre,
		Phase														as Code,
		Statut    													as Libelle
	Resident Phase_Statut_Impossible
	Where not Exists(#Cle_Parametre, 'Phase_Statut_Impossible/' & Phase & '/' & Statut);
	
	Map_Phase_Statut_Impossible:
	MAPPING LOAD
	    Phase & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut)		as Cle_Combinaison,
	    1																as Flag_Impossible
	Resident Phase_Statut_Impossible;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Phase_Statut_Impossible/' & Phase & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/1'	as #Cle_Parametre,
    	'Map_Phase_Statut_Impossible'																		as Parametre,
		Phase & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut)											as Code,
		1    																								as Libelle
	Resident Phase_Statut_Impossible
	Where not Exists(#Cle_Parametre, 'Map_Phase_Statut_Impossible/' & Phase & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/1');
	
	Drop Table Phase_Statut_Impossible;
	
	Map_Phase_Affaire:
	Mapping LOAD
		_bpf_ard_affaireid_value				as Affaire_Id,
	    _activestageid_value_FormattedValue		as ActiveStageIdName
	FROM [$(v_FolderQVD_Path)Affaire_Process_Stage.qvd]
	(qvd);
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Phase_Affaire/' & _bpf_ard_affaireid_value & '/' & _activestageid_value_FormattedValue		as #Cle_Parametre,
//     	'Map_Phase_Affaire'																				as Parametre,
// 		_bpf_ard_affaireid_value																		as Code,
// 		_activestageid_value_FormattedValue    															as Libelle
// 	FROM [$(v_FolderQVD_Path)Affaire_Process_Stage.qvd]
// 	(qvd)
// 	Where not Exists(#Cle_Parametre, 'Map_Phase_Affaire/' & _bpf_ard_affaireid_value & '/' & _activestageid_value_FormattedValue);
	
	Map_Workflow_Affaire:
	Mapping LOAD
		_bpf_ard_affaireid_value	as Affaire_Id,
	    statuscode_FormattedValue	as statuscodename
	FROM [$(v_FolderQVD_Path)Affaire_Process_Stage.qvd]
	(qvd);
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Workflow_Affaire/' & _bpf_ard_affaireid_value & '/' & statuscode_FormattedValue	as #Cle_Parametre,
//     	'Map_Workflow_Affaire'																	as Parametre,
// 		_bpf_ard_affaireid_value																as Code,
// 		statuscode_FormattedValue    															as Libelle
// 	FROM [$(v_FolderQVD_Path)Affaire_Process_Stage.qvd]
// 	(qvd)
// 	Where not Exists(#Cle_Parametre, 'Map_Workflow_Affaire/' & _bpf_ard_affaireid_value & '/' & statuscode_FormattedValue);
	
	Categorie_Statut_Impossible:
	NoConcatenate
	Load * Inline [
		Catégorie, Statut, Check
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireQualification)', 2
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireQualification)', 2
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireQualification)', 2
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireQualification)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireAContacter)', 2
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireAContacter)', 2
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireAContacter)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireARelancer)', 2
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireARelancer)', 2
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireARelancer)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireOuvert)', 2
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireOuvert)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireASuivre)', 2
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireASuivre)', 2
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireASuivre)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireLongShot)', 2
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireLongShot)', 2
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireLongShot)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireFerme)', 2
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteMnA)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteAudit)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteAvocat)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteBanque)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteAutre)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireQualification)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireAContacter)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireARelancer)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireOuvert)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireASuivre)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireLongShot)', 1
	    '$(vCategorieSocieteDianeCRM)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteDianeHorsScope)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteFicheACompleter)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteScope)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteHorsScope)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocietePortefeuille)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteSortiePortefeuille)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteClient)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteReseauAXA)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteChasseurTete)', '$(vStatutAffaireFerme)', 1
	    '$(vCategorieSocieteFondsScript)', '$(vStatutAffaireFerme)', 1
	];
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Categorie_Statut_Impossible/' & Catégorie & '/' & Statut		as #Cle_Parametre,
    	'Categorie_Statut_Impossible'									as Parametre,
		Catégorie														as Code,
		Statut    														as Libelle
	Resident Categorie_Statut_Impossible
	Where not Exists(#Cle_Parametre, 'Categorie_Statut_Impossible/' & Catégorie & '/' & Statut);
	
	Map_Categorie_Societe:
	Mapping Load
		accountid,
	    accountcategorycode_FormattedValue
	Resident Account;
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Categorie_Societe/' & accountid & '/' & accountcategorycode_FormattedValue		as #Cle_Parametre,
//     	'Map_Categorie_Societe'																as Parametre,
// 		accountid																			as Code,
// 		accountcategorycode_FormattedValue    												as Libelle
// 	Resident Account
// 	Where not Exists(#Cle_Parametre, 'Map_Categorie_Societe/' & accountid & '/' & accountcategorycode_FormattedValue);
    
    Tmp_Population_Categorie:
    Load * Inline [
    	Categorie, Population
        '$(vCategorieSocieteScope)', '$(vPopulationTargets)'
        '$(vCategorieSocietePortefeuille)', '$(vPopulationTargets)'
        '$(vCategorieSocieteFicheACompleter)', '$(vPopulationTargets)'
        '$(vCategorieSocieteHorsScope)', '$(vPopulationTargets)'
        '$(vCategorieSocieteSortiePortefeuille)', '$(vPopulationTargets)'
        '$(vCategorieSocieteAudit)', '$(vPopulationAdvisors)'
        '$(vCategorieSocieteAutre)', '$(vPopulationAdvisors)'
        '$(vCategorieSocieteAvocat)', '$(vPopulationAdvisors)'
        '$(vCategorieSocieteBanque)', '$(vPopulationAdvisors)'
        '$(vCategorieSocieteMnA)', '$(vPopulationAdvisors)'
        '$(vCategorieSocieteFondsScript)', '$(vPopulationFunds)'
        '$(vCategorieSocieteClient)', '$(vPopulationLPs)'
	];
	
	Map_Population_Categorie:
	Mapping load
    	*
	Resident Tmp_Population_Categorie;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Population_Categorie/' & Categorie & '/' & Population		as #Cle_Parametre,
    	'Map_Population_Categorie'										as Parametre,
		Categorie														as Code,
		Population    													as Libelle
	Resident Tmp_Population_Categorie
	Where not Exists(#Cle_Parametre, 'Map_Population_Categorie/' & Categorie & '/' & Population);
    
    Drop Table Tmp_Population_Categorie;
	
	Map_Categorie_Statut_Impossible:
	MAPPING LOAD
	    Catégorie & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut)	as Cle_Combinaison,
	    Check															as Flag_Impossible
	Resident Categorie_Statut_Impossible;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Categorie_Statut_Impossible/' & Catégorie & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Check		as #Cle_Parametre,
    	'Map_Categorie_Statut_Impossible'																					as Parametre,
		Catégorie & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut)														as Code,
		Check    																											as Libelle
	Resident Categorie_Statut_Impossible
	Where not Exists(#Cle_Parametre, 'Map_Categorie_Statut_Impossible/' & Catégorie & '/' & ApplyMap('Map_Code_Statut_Affaire',Statut) & '/' & Check);
	
	Drop Table Categorie_Statut_Impossible;
    
	Map_Type_Gerant:
	Mapping LOAD
	    fullname as Gerant,
	    if(ard_qliktypecode=173090000, '2', if(ard_qliktypecode=173090001,'1')) as User_Id_QlikType
	Resident SystemUser;
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Type_Gerant/' & fullname & '/' & Check									as #Cle_Parametre,
//     	'Map_Type_Gerant'															as Parametre,
// 		fullname																	as Code,
// 		if(ard_qliktypecode=173090000, '2', if(ard_qliktypecode=173090001,'1'))    	as Libelle
// 	Resident SystemUser
// 	Where not Exists(#Cle_Parametre, 'Map_Type_Gerant/' & fullname & '/' & if(ard_qliktypecode=173090000, '2', if(ard_qliktypecode=173090001,'1')));
	
	Map_Gerant_Actif:
	Mapping LOAD
	    fullname as Gerant,
	    1 as Gerant_Actif
	Resident SystemUser
	Where ard_qliktypecode=173090001;
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Gerant_Actif/' & fullname & '/1'	as #Cle_Parametre,
//     	'Map_Gerant_Actif'						as Parametre,
// 		fullname								as Code,
// 		1    									as Libelle
// 	Resident SystemUser
// 	Where ard_qliktypecode=173090001
// 	and not Exists(#Cle_Parametre, 'Map_Gerant_Actif/' & fullname & '/1');
	
	Map_SocieteHorsScope:
	Mapping Load
		accountid,
	    1			as Flag_Hors_Scope
	Resident Account
	Where accountcategorycode_FormattedValue = '$(vCategorieSocieteHorsScope)';
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_SocieteHorsScope/' & accountid & '/1'	as #Cle_Parametre,
//     	'Map_SocieteHorsScope'						as Parametre,
// 		accountid									as Code,
// 		1    										as Libelle
// 	Resident Account
//     Where accountcategorycode_FormattedValue = '$(vCategorieSocieteHorsScope)'
// 	and not Exists(#Cle_Parametre, 'Map_SocieteHorsScope/' & accountid & '/1');
	
	Map_Affaire_Contact_Intermediaire:
	Mapping LOAD
	     ard_affaireid, 
	     contactid
	FROM
	[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd] (qvd);
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Affaire_Contact_Intermediaire/' & ard_affaireid & '/' & contactid		as #Cle_Parametre,
//     	'Map_Affaire_Contact_Intermediaire'											as Parametre,
// 		ard_affaireid																as Code,
// 		contactid    																as Libelle
// 	FROM
// 	[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd]
//     (qvd)
// 	where not Exists(#Cle_Parametre, 'Map_SocieteHorsScope/' & ard_affaireid & '/' & contactid);
        
	// Ajout le 25/04/22 pour boutons "Topics"
	
	Map_Modif_Societe:
	Mapping Load
		accountid,
	    ard_formmodifiedon
	Resident Account;
	
//     // Parametre
//     Concatenate(Parametre)
//     Load Distinct
//     	'Map_Modif_Societe/' & accountid & '/' & ard_formmodifiedon		as #Cle_Parametre,
//     	'Map_Modif_Societe'												as Parametre,
// 		accountid														as Code,
// 		ard_formmodifiedon    											as Libelle
// 	FROM
// 	[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd]
//     (qvd)
// 	where not Exists(#Cle_Parametre, 'Map_Modif_Societe/' & accountid & '/' & ard_formmodifiedon);
	
// 	Tags_Map:
// 	LOAD
// 	    ard_tagid,
// 	    modifiedon
// 	Resident Tags
// 	where ard_isperimeteraffaire_FormattedValue='$(vLibOui)'
// 	or ard_isperimetersociete_FormattedValue='$(vLibOui)';
	
// 	Left Join(Tags_Map)
// 	LOAD
// 	    _ard_tagid_value 			as ard_tagId,
// 	    _ard_affaireid_value,
// 	    modifiedon					as ModifiedOn_Affaire
// 	Resident Tag_Attribution;
	
// 	Left Join(Tags_Map)
// 	LOAD
// 	    _ard_tagid_value 			as ard_tagId,
// 	    _ard_accountid_value,
// 	    modifiedon					as ModifiedOn_Account
// 	Resident Tag_Attribution;
	
// 	Map_Modif_Tag_Affaire:
// 	Mapping LOAD
// 	    _ard_affaireid_value,
// 	    max(modifiedon)				as ModifiedOn
// 	Resident Tags_Map
// 	Group By _ard_affaireid_value;
	
// 	Map_Modif_Tag_Societe:
// 	Mapping LOAD
// 	    _ard_accountid_value,
// 	    max(modifiedon)				as ModifiedOn
// 	Resident Tags_Map
// 	Group By _ard_accountid_value;
	
	Map_Modif_Tag_Attribution_Affaire:
	Mapping LOAD
	    _ard_affaireid_value,
	    rangemax(max(modifiedon),max(createdon))		as ModifiedOn_Affaire
	Resident Tag_Attribution
	Group By _ard_affaireid_value;
	
	Map_Modif_Tag_Attribution_Societe:
	Mapping LOAD
	    _ard_accountid_value,
	    rangemax(max(modifiedon),max(createdon))		as ModifiedOn_Account
	Resident Tag_Attribution
	Group By _ard_accountid_value;
	
// 	Drop Table Tags_Map;

	Activite_Map:
    Load
    	_regardingobjectid_value,
	    modifiedon,
        activitytypecode
	FROM [$(v_FolderQVD_Path)Activite.qvd]
	(qvd);
	
	Activite:
	LOAD
	    _regardingobjectid_value	as RegardingObjectId,
	    max(modifiedon)				as ModifiedOn
	Resident Activite_Map
	WHERE activitytypecode = '$(vActivityTypeCodeAppointment)' OR activitytypecode = '$(vActivityTypeCodePhoneCall)' or activitytypecode = '$(vActivityTypeCodeEmail)'
	Group By _regardingobjectid_value;
    
    Drop Table Activite_Map;
	
	Left Join(Activite)
	load
		_parentcustomerid_value		as RegardingObjectId,
		contactid 					as Con_Id
	Resident Contact;
	
	Left Join(Activite)
	load
		RegardingObjectId		as Con_Id,
		ModifiedOn				as Con_Modified_On
	Resident Activite;
	
	Map_Modif_Activite:
	Mapping LOAD
	    RegardingObjectId,
	    rangemax(max(ModifiedOn),max(Con_Modified_On))			as Last_Modif
	Resident Activite
	Group By RegardingObjectId;
	
	Drop Table Activite;
	
// 	Affaire_Contact_Intermediaire:
// 	LOAD 
// 	     ard_affaireid				as Interm_Id_Affaire, 
// 	     contactid					as Interm_Id
// 	FROM
// 	[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd] (qvd);
	
// 	join(Affaire_Contact_Intermediaire)
// 	load
// 		contactid 														as Interm_Id,
// 		_parentcustomerid_value											as Interm_Id_Societe,
// 	    ApplyMap('Map_Modif_Societe',_parentcustomerid_value,Null())	as Modif_Soc_Interm,
// 	    modifiedon														as Modif_Con_Interm
// 	Resident Contact;
	
// 	Map_Modif_Soc_Interm:
// 	Mapping Load
// 		Interm_Id_Affaire,
// 	    max(Modif_Soc_Interm)		as Last_Modif_Soc_Interm
// 	Resident Affaire_Contact_Intermediaire
// 	Group By Interm_Id_Affaire;
	
// 	Map_Modif_Con_Interm:
// 	Mapping Load
// 		Interm_Id_Affaire,
// 	    max(Modif_Con_Interm)		as Last_Modif_Con_Interm
// 	Resident Affaire_Contact_Intermediaire
// 	Group By Interm_Id_Affaire;
	
// 	Drop Table Affaire_Contact_Intermediaire;
    
	Map_Created_Connection:
	Mapping Load
	    _record1id_value,
		createdon
	FROM [$(v_FolderQVD_Path)Dim_Connection_AllObjects.qvd]
	(qvd);
	
End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

	// Map 20 Affaire Contact Intermediaire || 20 Societe
    
	
	Tmp_Secteur_Societe:
	load * inline  [
	Secteur,	Alias
	'$(vSecteurAgro)',	'$(vSecteurShortAgro)'
	'$(vSecteurAutoAeroNaval)',	'$(vSecteurShortAutoAeroNaval)'
	'$(vSecteurBioTech)',	'$(vSecteurShortBioTech)'
	'$(vSecteurDistribution)',	'$(vSecteurShortDistribution)'
	'$(vSecteurElectronique)',	'$(vSecteurShortElectronique)'
	'$(vSecteurEnergie)',	'$(vSecteurShortEnergie)'
	'$(vSecteurCleanTech)',	'$(vSecteurShortCleanTech)'
	'$(vSecteurImmoBTP)',	'$(vSecteurShortImmoBTP)'
	'$(vSecteurWeb)',	'$(vSecteurShortWeb)'
	'$(vSecteurLogiciel)',	'$(vSecteurShortLogiciel)'
	'$(vSecteurCommodities)',	'$(vSecteurShortCommodities)'
	'$(vSecteurMediaMarketingTMT)',	'$(vSecteurShortMediaMarketingTMT)'
	'$(vSecteurIndustrie)',	'$(vSecteurShortIndustrie)'
	'$(vSecteurPharma)',	'$(vSecteurShortPharma)'
	'$(vSecteurSanteBeaute)',	'$(vSecteurShortSanteBeaute)'
	'$(vSecteurConsommation)',	'$(vSecteurShortConsommation)'
	'$(vSecteurConseil)',	'$(vSecteurShortConseil)'
	'$(vSecteurFIGFinTech)',	'$(vSecteurShortFIGFinTech)'
	'$(vSecteurServicesIT)',	'$(vSecteurShortServicesIT)'
	'$(vSecteurTextileModeLuxe)',	'$(vSecteurShortTextileModeLuxe)'
	'$(vSecteurHospitality)',	'$(vSecteurShortHospitality)'
	'$(vSecteurTransportLogistique)',	'$(vSecteurShortTransportLogistique)'
    '$(vSecteurEducation)',    '$(vSecteurShortEducation)'
    '$(vSecteurGaming)',    '$(vSecteurShortGaming)'
	];
	
	Map_Secteur_Societe:
	Mapping load
    	*
	Resident Tmp_Secteur_Societe;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Secteur_Societe/' & Secteur & '/' & Alias		as #Cle_Parametre,
    	'Map_Secteur_Societe'								as Parametre,
		Secteur												as Code,
		Alias    											as Libelle
	Resident Tmp_Secteur_Societe
	Where not Exists(#Cle_Parametre, 'Map_Secteur_Societe/' & Secteur & '/' & Alias);
    
    Drop Table Tmp_Secteur_Societe;

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityActivite)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then
	
	// Map 20 Contact
	
	Activity:
	Load
		_regardingobjectid_value	as RegardingObjectId,
	    activitytypecode			as ActivityTypeCode
	FROM [$(v_FolderQVD_Path)Activite.qvd]
	(qvd)
	;
	
	Map_Activity_Email:
	Mapping Load Distinct
		RegardingObjectId,
	    1					as TopEmail
	Resident Activity
	WHERE ActivityTypeCode = '$(vActivityTypeCodeEmail)';
	
	Map_Activity_RdvCall:
	Mapping Load Distinct
		RegardingObjectId,
	    1					as TopRdvCall
	Resident Activity
	WHERE ActivityTypeCode = '$(vActivityTypeCodeAppointment)'
	or ActivityTypeCode = '$(vActivityTypeCodePhoneCall)';
	
	Drop Table Activity;
	
	Tmp_Categorie_Concernant_Contact:
	Load * Inline [
	    CatégorieSociete, Check
	    '$(vCategorieSocieteDianeCRM)', 1
	    '$(vCategorieSocieteDianeHorsScope)', 1
	    '$(vCategorieSocieteFicheACompleter)', 2
	    '$(vCategorieSocieteScope)', 2
	    '$(vCategorieSocieteHorsScope)', 2
	    '$(vCategorieSocietePortefeuille)', 2
	    '$(vCategorieSocieteSortiePortefeuille)', 2
	    '$(vCategorieSocieteClient)', 2
	];
	
	Map_Categorie_Concernant_Contact:
	Mapping load
    	*
	Resident Tmp_Categorie_Concernant_Contact;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Categorie_Concernant_Contact/' & CatégorieSociete & '/' & Check		as #Cle_Parametre,
    	'Map_Categorie_Concernant_Contact'											as Parametre,
		CatégorieSociete															as Code,
		Check    																	as Libelle
	Resident Tmp_Categorie_Concernant_Contact
	Where not Exists(#Cle_Parametre, 'Map_Categorie_Concernant_Contact/' & CatégorieSociete & '/' & Check);
    
    Drop Table Tmp_Categorie_Concernant_Contact;

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityActivite)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntitySystemUser)*')>0 then
	
	// Map 20 Societe
	
	Tmp_Parent_Categorie_Societe:
	load * inline  [
	AccountCategoryCode,ParentCategory
	'$(vCategorieSocieteScope)', '$(vParentCategorieSocieteProspection)'
	'$(vCategorieSocieteHorsScope)', '$(vParentCategorieSocieteProspection)'
	'$(vCategorieSocieteSortiePortefeuille)', '$(vParentCategorieSocieteProspection)'
	'$(vCategorieSocietePortefeuille)', '$(vParentCategorieSocietePortefeuille)'
	'$(vCategorieSocieteMnA)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteReseauAXA)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteClient)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteBanque)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteAvocat)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteAudit)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteAutre)', '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteFondsScript)',  '$(vParentCategorieSocieteFonds)'
	'$(vCategorieSocieteChasseurTete)', '$(vParentCategorieSocieteFonds)'
	];
	
	Map_Parent_Categorie_Societe:
	Mapping load
    	*
	Resident Tmp_Parent_Categorie_Societe;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Parent_Categorie_Societe/' & AccountCategoryCode & '/' & ParentCategory		as #Cle_Parametre,
    	'Map_Parent_Categorie_Societe'														as Parametre,
		AccountCategoryCode																	as Code,
		ParentCategory    																	as Libelle
	Resident Tmp_Parent_Categorie_Societe
	Where not Exists(#Cle_Parametre, 'Map_Parent_Categorie_Societe/' & AccountCategoryCode & '/' & ParentCategory);
    
    Drop Table Tmp_Parent_Categorie_Societe;
	
	Affaire_Map:
	Load
		_ard_societeid_value							as ard_SocieteId,
		if(ard_statutaffairecode <> '173090005', 1, 0)	as TopOuvert
	Resident Affaire
	Where ard_statutaffairecode <> '173090005';
	
	Map_Affaire_Ouverte:
	Mapping Load
		ard_SocieteId,
	    sum(TopOuvert)	as TopOuvert
	Resident Affaire_Map
	Group By ard_SocieteId;
	
	Drop Table Affaire_Map;
	
	Tmp_Categorie_Concernant_Societe:
	Load * Inline [
	    CatégorieSociete, Check
	    '$(vCategorieSocieteDianeCRM)', 1
	    '$(vCategorieSocieteDianeHorsScope)', 1
	    '$(vCategorieSocieteReseauAXA)', 2
	    '$(vCategorieSocieteChasseurTete)', 2
	    '$(vCategorieSocieteFondsScript)', 2
	    '$(vCategorieSocieteMnA)', 2
	    '$(vCategorieSocieteAudit)', 2
	    '$(vCategorieSocieteAvocat)', 2
	    '$(vCategorieSocieteBanque)', 2
	    '$(vCategorieSocieteAutre)', 2
	];
	
	Map_Categorie_Concernant_Societe:
	Mapping load
    	*
	Resident Tmp_Categorie_Concernant_Societe;
	
    // Parametre
    Concatenate(Parametre)
    Load Distinct
    	'Map_Categorie_Concernant_Societe/' & CatégorieSociete & '/' & Check		as #Cle_Parametre,
    	'Map_Categorie_Concernant_Societe'											as Parametre,
		CatégorieSociete															as Code,
		Check    																	as Libelle
	Resident Tmp_Categorie_Concernant_Societe
	Where not Exists(#Cle_Parametre, 'Map_Categorie_Concernant_Societe/' & CatégorieSociete & '/' & Check);
    
    Drop Table Tmp_Categorie_Concernant_Societe;

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityFinance)*')>0 then
	
	// Map 20 Finance
	
	Map_Societe_Creation:
	Mapping Load
		accountid,
	    new_datedecreation
	Resident Account;

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then
	
	// Map 20 Tags
	
	Map_Date_Attribution_ModifiedOn:
	Mapping LOAD
	    _ard_tagid_value,
	    date(max(floor(num(modifiedon))),'DD/MM/YYYY') as Tag_Date_Attribution_ModifiedOn
	Resident Tag_Attribution
	Group By _ard_tagid_value;

End If

ListeVariable:
LOAD
	'Variable'																										as Parametre,
    trim(Right(SubField(@1,'=',1),len(SubField(@1,'=',1))-4))        												as Variable,
    if(left(@1,3)='LET',
        Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(trim(SubField(@1,'=',2) & if(len(SubField(@1,'=',3))>0,'=' & SubField(@1,'=',3))),' & ',''),'& ',''),' &',''),'&',''),'chr(233)','é'),'chr(234)','ê'),'chr(38)','&'),'chr(224)','à'),'chr(226)','â'),'chr(232)','è'),'chr(244)','ô'),'chr(231)','ç'),chr(39),''),
        Replace(trim(SubField(@1,'=',2) & if(len(SubField(@1,'=',3))>0,'=' & SubField(@1,'=',3))),chr(39),''))		as Definition
FROM
[$(v_FolderQVDSource_Path)Variables Libellés.qvs]
(txt, utf8, no labels, delimiter is ';', msq)
Where left(@1,2) <> '//';

Concatenate(ListeVariable)
LOAD
	'Variable couleur'																								as Parametre,
    trim(Right(SubField(@1,'=',1),len(SubField(@1,'=',1))-4))        												as Variable,
    if(left(@1,3)='LET',
        Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(trim(SubField(@1,'=',2) & if(len(SubField(@1,'=',3))>0,'=' & SubField(@1,'=',3))),' & ',''),'& ',''),' &',''),'&',''),'chr(233)','é'),'chr(234)','ê'),'chr(38)','&'),'chr(224)','à'),'chr(226)','â'),'chr(232)','è'),'chr(244)','ô'),'chr(231)','ç'),chr(39),''),
        Replace(trim(SubField(@1,'=',2) & if(len(SubField(@1,'=',3))>0,'=' & SubField(@1,'=',3))),chr(39),''))		as Definition
FROM
[$(v_FolderQVDSource_Path)Variables couleurs.qvs]
(txt, utf8, no labels, delimiter is ';', msq)
Where left(@1,2) <> '//';

// Parametre
Concatenate(Parametre)
Load Distinct
	Parametre & '/' & Variable & '/' & Definition	as #Cle_Parametre,
	Parametre,
	Variable										as Code,
	Definition    									as Libelle
Resident ListeVariable
Where not Exists(#Cle_Parametre, Parametre & '/' & Variable & '/' & Definition);

Drop Table ListeVariable;

IF FileSize('$(v_FolderQVD_Path_Store)ListeParametre.qvd') > 0 THEN

	Concatenate(Parametre)
    LOAD
    	*
	FROM $(v_FolderQVD_Path_Store)ListeParametre.qvd
    (qvd)
    Where not Exists(#Cle_Parametre);

EndIf

ListeParametre:
NoConcatenate
Load
	*
Resident Parametre
Where #Cle_Parametre <> 'Dummy';

STORE ListeParametre INTO [$(v_FolderQVD_Path_Store)ListeParametre.qvd] (qvd);

DROP TABLE ListeParametre;
DROP TABLE Parametre;

// If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*','*$(sEntityOperation)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then
	
// 	// Map 25 Fact Societe || 30 Contact Plus || 30 Actionnariat
	
// 	Tags_Map:
// 	LOAD Distinct
// 	    ard_tagid as ard_tagId
// 	Resident Tags
// 	where ard_isperimeteraffaire_FormattedValue='$(vLibOui)'
// 	or ard_isperimetercontact_FormattedValue='$(vLibOui)'
// 	or ard_isperimetersociete_FormattedValue='$(vLibOui)';
	
// 	Left Join(Tags_Map)
// 	LOAD
// 	    _ard_tagid_value as ard_tagId,
// 	    _ard_affaireid_value as #Cle_Tag
// 	Resident Tag_Attribution;
	
	
// 	Map_HasTag:
// 	Mapping Load Distinct
// 		#Cle_Tag,
// 	    1			as HasTag
// 	Resident Tags_Map;
	
// 	Drop Table Tags_Map;
	
// End If
	
///$tab Parameter List Color
PaletteCouleur:
LOAD
	'Secteur/' & Secteur & '/' & Couleur	as #Cle_Parametre_Couleur,
	'Secteur'								as ParametreCouleur,
    Secteur									as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is Secteur);

Concatenate(PaletteCouleur)
LOAD
	'Secteur short/' & [Secteur Short] & '/' & Couleur		as #Cle_Parametre_Couleur,
	'Secteur short'											as ParametreCouleur,
    [Secteur Short]											as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is Secteur);

Concatenate(PaletteCouleur)
LOAD
	'Pays/' & Pays & '/' & Couleur		as #Cle_Parametre_Couleur,
	'Pays'								as ParametreCouleur,
    Pays								as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is Pays);

Concatenate(PaletteCouleur)
LOAD
	'Catégorie/' & Catégorie & '/' & Couleur	as #Cle_Parametre_Couleur,
	'Catégorie'									as ParametreCouleur,
    Catégorie									as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is Catégorie);

Concatenate(PaletteCouleur)
LOAD
	'Statut affaire/' & Statut & '/' & Couleur		as #Cle_Parametre_Couleur,
	'Statut affaire'								as ParametreCouleur,
    Statut											as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is [Statut Affaire]);

Concatenate(PaletteCouleur)
LOAD
	'Origine affaire/' & Origine & '/' & Couleur	as #Cle_Parametre_Couleur,
	'Origine affaire'								as ParametreCouleur,
    Origine											as CodeCouleur,
    Couleur
FROM [$(v_FolderQVDSource_Path)Palette couleur.xlsx]
(ooxml, embedded labels, table is [Origine Affaire]);

STORE PaletteCouleur INTO [$(v_FolderQVD_Path_Store)PaletteCouleur.qvd] (qvd);

DROP TABLE PaletteCouleur;




///$tab -- Debut 20 Activite

///$tab Email Detail
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityActivityParty)*')>0 then
	
Dim_Email_Detail:
LOAD
    _activityid_value				as Act_Id,
    _partyid_value					as Act_Id_Partie,
    participationtypemask			as Act_Id_Participation_Mask,
    addressused 					as Act_Lib_Address,
    addressusedemailcolumnnumber	as Act_Num_Address_Column,
    _partyid_value_FormattedValue	as Act_Lib_Partie_Name,
    ispartydeleted_FormattedValue	as Act_Is_Deleted
FROM [$(v_FolderQVD_Path)ActivityParty.qvd]
(qvd);

STORE Dim_Email_Detail INTO [$(v_FolderQVD_Path_Store)Dim_Email_Detail.qvd] (qvd);
DROP TABLE Dim_Email_Detail;

End If

///$tab Activity
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityActivite)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*')>0 then

Dim_Activite:
LOAD
    _ownerid_value as Act_Id_Owner,
    _ownerid_value_FormattedValue as Act_Lib_Owner_Name,
    ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)') as Act_Lib_Owner_Name_Short,
    ApplyMap('Map_Gerant_Type',ApplyMap('Map_Gerant_Type_Activite',_ownerid_value_FormattedValue),Null()) as Act_Lib_Owner_Type,
    activityid as Act_Id,
    if(activitytypecode='$(vActivityTypeCodeEmail)',left(description, 1000),description) as Act_Lib_Description,
    ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Act_Dtm_ModifiedOn,
    activitytypecode as Act_Lib_Type,
    activitytypecode_FormattedValue as Act_Lib_Type_Name,
    ConvertToLocalTime(scheduledend,'Paris') as Act_Dtm_Scheduled_End,
    ConvertToLocalTime(Timestamp(createdon), 'Paris') as Act_Dtm_CreatedOn,
    _regardingobjectid_value as Act_Id_RegardingObject,
    subject as Act_Lib_Subject,
    if(isnull(scheduledstart),ConvertToLocalTime(scheduledend,'Paris'), ConvertToLocalTime(scheduledstart,'Paris')) as Act_Dtm_Scheduled_Start,  // modif ABA, 28052021 Pour régler pb de ScheduledStart à null dans Crm
    _regardingobjectid_value_FormattedValue as Act_Lib_RegardingObject_Name,
    '$(v_URL_Standard_Start)' & if(activitytypecode = 'appointment', '$(v_EntityName_Appointment)',
    								if(activitytypecode = 'email','$(v_EntityName_Email)',
                                    	if(activitytypecode = 'phonecall','$(v_EntityName_phonecall)')
                                    )
    ) & '$(v_URL_Standard_End)' & activityid			as Act_Lien	
FROM [$(v_FolderQVD_Path)Activite.qvd]
(qvd)
WHERE activitytypecode = '$(vActivityTypeCodeAppointment)' 
	OR activitytypecode = '$(vActivityTypeCodePhoneCall)' 
    or activitytypecode = '$(vActivityTypeCodeEmail)';

left join(Dim_Activite)
LOAD
    ard_targetactivityid											as Act_Id,
    _regardingobjectid_value_FormattedValue							as Act_Share_Lib_RegardingObject_Name,
    _regardingobjectid_value										as Act_Share_Lib_RegardingId
FROM [$(v_FolderQVD_Path)ShareActivity.qvd]
(qvd);



Left Join(Dim_Activite)
LOAD
    if(directioncode_FormattedValue='Entrant'
    	,'In'
        ,if(directioncode_FormattedValue='Sortant'
        	,'Out'
            ,''
        )
    ) as Act_Lib_Direction
    , activityid as Act_Id
FROM [$(v_FolderQVD_Path)Email.qvd](qvd);

left Join(Dim_Activite)
LOAD
    systemuserid 			as Act_Id_Owner,
    '1' 					as Act_Is_Active_Owner
Resident SystemUser;

STORE Dim_Activite INTO [$(v_FolderQVD_Path_Store)Dim_Activite.qvd] (qvd);
DROP TABLE Dim_Activite;
	
End If

///$tab -- Debut 20 Affaire

///$tab Affaire
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityAffaire_Process_Stage)*','*$(sEntityConnectionAllObjects)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

Dim_Affaire:
LOAD
		ard_affaireid as Aff_Id, 
        ConvertToLocalTime(Timestamp(createdon), 'Paris') as Aff_Dtm_Created_On,
        ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Aff_Dtm_Modified_On,
        _ownerid_value as Aff_Id_Owner, 
        ard_name as Aff_Lib_Name,
        ard_commentaireoperation as Aff_Lib_Operation_Com, 
        ard_commentairesdescription as Aff_Lib_Description_Com, 
        ConvertToLocalTime(ard_date2pager,'Paris') as Aff_Date_2Pager, 
        ConvertToLocalTime(ard_datecomite,'Paris') as Aff_Date_Comite, 
        ConvertToLocalTime(ard_datedemandedecontacteffectuee,'Paris') as Aff_Date_Demande_Contact_Effectuee, 
        ConvertToLocalTime(ard_dateexclusivite,'Paris') as Aff_Date_Exclusivite, 
        ConvertToLocalTime(ard_dateloi,'Paris') as Aff_Date_Loi, 
        ConvertToLocalTime(ard_datemanagementpresentation,'Paris') as Aff_Date_Management_Presentation, 
        ConvertToLocalTime(ard_datendaim,'Paris') as Aff_Date_NdaIm, 
        date(ConvertToLocalTime(ard_dateouverture,'Paris'),'DD/MM/YYYY')								as Aff_Dtm_Ouverture, 
        ConvertToLocalTime(ard_daterelanceeffectuee,'Paris') as Aff_Date_Relance_Effectuee, 
        ConvertToLocalTime(ard_datereponserecue,'Paris') as Aff_Date_Reponse_Recue, 
        ConvertToLocalTime(ard_dateshortlisted,'Paris') as Aff_Date_Shortlisted, 
        ConvertToLocalTime(ard_datestatut,'Paris') as Aff_Date_Statut, 
        ConvertToLocalTime(ard_dateteaserrecu,'Paris') as Aff_Date_Teaser_Recu,  
        ard_dette as Aff_Mon_LBO_Dette,
//         ard_est2pager_FormattedValue as Aff_Is_2Pager,
        ard_estbuildup_FormattedValue as Aff_Is_BuildUp,        
//         ard_estcomite_FormattedValue as Aff_Is_Comite,
        ard_estdemandedecontacteffectuee_FormattedValue as Aff_Is_Demande_Contact_Effectuee,
        ard_estrelanceeffectuee_FormattedValue as Aff_Is_Relance_Effectuee,
        ard_statutaffairecode as Aff_Id_Statut_Affaire,
        ard_ticketardian as Aff_Mon_Ticket_Ardian,
        ard_tickettotal as Aff_Mon_Ticket_Total,
//         ard_typeinvestissementcode as Aff_Id_Type_Investissement,
        ard_typeinvestissementcode_FormattedValue as Aff_Lib_Type_Investissement,
//         ard_typeprocesscode as Aff_Id_Type_Process_Code, 
        ard_typeprocesscode_FormattedValue as Aff_Lib_Type_Process_Name,
        ard_valeurentreprise as Aff_Mon_Valeur_Entreprise, 
        ard_xca_FormattedValue as Aff_Num_xCa, 
        ard_xebit_FormattedValue as Aff_Num_xEbit, 
        ard_xebitda_FormattedValue as Aff_Num_xEbitda,
        ard_xebitdaebitretraite_FormattedValue as Aff_Is_Restated,
        ard_fondscode_FormattedValue as Aff_Lib_Fund_Type,
        _ard_acquereurid_value as Aff_Id_Acquereur,
        _ard_acquereurid_value_FormattedValue as Aff_Lib_Acquereur,
        '$(v_URL_Standard)' & ApplyMap('Map_Logo_Account',_ard_acquereurid_value,Null()) as Aff_Lien_Photo_Acquereur,
        _ard_societeid_value as Aff_Id_Societe, 
        _ard_analysteid_value as Aff_Id_Analyste, 
        _ard_gerant2id_value as Aff_Id_Gerant_2, 
        _ard_gerant3id_value as Aff_Id_Gerant_3, 
        ConvertToLocalTime(ard_datecession,'Paris') as Aff_Date_Cession, 
        ConvertToLocalTime(ard_dateteaserenvoye,'Paris') as Aff_Date_Teaser_Envoye, 
//         ard_estcession_FormattedValue as Aff_Is_Cession,
//         ard_estteaserenvoye_FormattedValue as Aff_Is_Teaser_Envoye,
        ConvertToLocalTime(ard_dateetapeprocess,'Paris') as Aff_Date_Etape_Process, 
        ard_etapeprocess as Aff_Lib_Etape_Process, 
        if(IsNull(ard_etapeprocess),1,0) as Aff_Flag_Etape_Null,
        ard_anneereference as Aff_Year_Ref, 
//         ard_fondscode as Aff_Id_Fonds_Code, 
        ard_fondscode_FormattedValue as Aff_Lib_Fonds_Name,
        ard_valeurequity as Aff_Mon_Valeur_Equity,
        //-- Gérant Affaire--
        _ard_gerant3id_value_FormattedValue as Aff_Lib_Gerant_3_Name,
        _ard_gerant2id_value_FormattedValue as Aff_Lib_Gerant_2_Name, 
        _ard_analysteid_value_FormattedValue as Aff_Lib_Analyste_Name, 
        _ownerid_value_FormattedValue as Aff_Lib_Gerant_1_Name,
        _ownerid_value_FormattedValue & ',' &_ard_gerant2id_value_FormattedValue & ',' &_ard_gerant3id_value_FormattedValue & ',' &_ard_analysteid_value_FormattedValue as #Aff_Lib_Gerant_Union,
        
//         '$(v_Url_Path_Affaire)' & ard_affaireid & '&pagetype=entityrecord' 					 	as Aff_Lien,
        '$(v_URL_Standard_Start)' & '$(v_EntityName_Affaire)' & '$(v_URL_Standard_End)' & ard_affaireid			as Aff_Lien,
//         ard_estrdvcalldirigeant_FormattedValue as Aff_Is_RDV_Call_Dirigeant,
        ConvertToLocalTime(ard_daterdvcalldirigeant,'Paris') as Aff_Date_RDV_Call_Dirigeant,
//         ard_estclosing_FormattedValue as Aff_Is_Closing,
        ConvertToLocalTime(ard_dateclosing,'Paris')as Aff_Date_Closing,
        ard_estreunioninterne_FormattedValue as Aff_Is_Reunion_Interne,
        ard_demandecontacteffectueepersonnecode as Aff_Id_DemandeContact_Personne,
        ard_demandecontacteffectueepersonnecode_FormattedValue as Aff_Lib_Demande_Contact_Qui,
        ard_detentionvisee as Aff_Num_Detention,
        ard_sourceaffaire_FormattedValue as Aff_Lib_Source,
        if(_createdby_value_FormattedValue='zpcrm nom', '$(vCreatedByCompteSysteme)', _createdby_value_FormattedValue) as Aff_Lib_Created_By_Name,
        ard_prisecontactcode as Aff_Id_Prise_Contact,
        ConvertToLocalTime(ard_prequalificationdate,'Paris') as Aff_Date_Pre_Qualification,
//         _ard_prequalificationanalystid_value_FormattedValue as Aff_Lib_Pre_Qualification_Analyst_Name,
        
        ard_origineaffairecode_FormattedValue as Aff_Lib_Origine,
    	if(Match(ard_origineaffairecode_FormattedValue,'$(vOrigineAffaireSortie)','$(vOrigineAffaireMarche)')>0,1,0)		as Aff_Is_Dealflow,
		ard_statutaffairecode_FormattedValue as Aff_Lib_Statut,
          if(ard_statutaffairecode = '173090005', date(ConvertToLocalTime(ard_datestatut,'Paris'))) as Aff_Date_Fermeture,
         ConvertToLocalTime(ard_datedealmarche,'Paris') as Aff_Date_Deal_Marche,
	 _modifiedby_value_FormattedValue as Aff_Lib_Modified_By_Name,
	 ConvertToLocalTime(ard_formmodifiedon,'Paris') as Aff_Dtm_Form_Modified_On,
     if(not isnull(_ownerid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)')) as Aff_Lib_Gerant1_Short,
     if(not isnull(_ard_gerant2id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_gerant2id_value_FormattedValue,'$(vLibAutres)')) as Aff_Lib_Gerant2_Short,
     if(not isnull(_ard_gerant3id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_gerant3id_value_FormattedValue,'$(vLibAutres)')) as Aff_Lib_Gerant3_Short,
     if(not isnull(_ard_analysteid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_analysteid_value_FormattedValue,'$(vLibAutres)')) as Aff_Lib_Analyste_Short,
     if(not isnull(_ard_formmodifiedbyid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_formmodifiedbyid_value_FormattedValue,'$(vLibAutres)')) as Aff_Lib_Form_Modified_By_Name,
     
     right(ard_name,len(ard_name)-12) as Aff_Lib_Name_Short,
     if(ard_tickettotal/1000 >= 50, '$(vClassTicket50)',
     	if(ard_tickettotal/1000 >= 40 and ard_tickettotal/1000 < 50, '$(vClassTicket40)',
        	if(ard_tickettotal/1000 >= 30 and ard_tickettotal/1000 < 40, '$(vClassTicket30)',
            	if(ard_tickettotal/1000 >= 20 and ard_tickettotal/1000 < 30, '$(vClassTicket20)',
                	if(ard_tickettotal/1000 >= 10 and ard_tickettotal/1000 < 20, '$(vClassTicket10)',
                    	if(ard_tickettotal/1000 < 10,'$(vClassTicket0)',
                        	if(isnull(ard_tickettotal),'?'))))))) as Aff_Class_Ticket_Total,
     ard_controlecode_FormattedValue as Aff_Id_Controle_Code,
     if(round(interval(today()-rangemax(daystart(ard_datestatut),daystart(ard_dateetapeprocess)),'DD'))<=15
     	and round(interval(today()-rangemax(daystart(ard_datestatut),daystart(ard_dateetapeprocess)),'DD'))>=0, '$(vLibOui)', '$(vLibNon)') 	as Aff_Is_News_15j,
	 rangemax(ApplyMap('Map_Modif_Societe',_ard_societeid_value,0),
//      	ApplyMap('Map_Modif_Tag_Affaire',ard_AffaireId,0),
//      	ApplyMap('Map_Modif_Tag_Societe',ard_SocieteId,0),
     	ApplyMap('Map_Modif_Tag_Attribution_Affaire',ard_affaireid,0),
     	ApplyMap('Map_Modif_Tag_Attribution_Societe',_ard_societeid_value,0),
     	ApplyMap('Map_Modif_Activite',_ard_societeid_value,0),
//      	ApplyMap('Map_Modif_Soc_Interm',ard_AffaireId,0),
//      	ApplyMap('Map_Modif_Con_Interm',ard_AffaireId,0),
        ApplyMap('Map_Created_Connection',_ard_societeid_value,0),
        ConvertToLocalTime(ard_formmodifiedon, 'Paris'))		as Aff_Dtm_Last_Change,
     if(ApplyMap('Map_Type_Gerant',_ownerid_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_ard_gerant2id_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_ard_gerant3id_value_FormattedValue) = 2,1,0)																				as Aff_Flag_Gerant_Analyste,
     if(ApplyMap('Map_Type_Gerant',_ard_analysteid_value_FormattedValue) = 1,1,0)																					as Aff_Flag_Analyste_Gerant,
     if(ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_ard_gerant2id_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_ard_gerant3id_value_FormattedValue,0) = 0,1,0)																			as Aff_Flag_Gerant_Requis,
     if((ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0 and not IsNull(_ownerid_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_ard_gerant2id_value_FormattedValue,0) = 0 and not IsNull(_ard_gerant2id_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_ard_gerant3id_value_FormattedValue,0) = 0 and not IsNull(_ard_gerant3id_value_FormattedValue)),1,0)										as Aff_Flag_Clean_Gerant,
     if(_ownerid_value_FormattedValue = _ard_gerant2id_value_FormattedValue
     	or _ownerid_value_FormattedValue = _ard_gerant3id_value_FormattedValue
     	or _ard_gerant3id_value_FormattedValue = _ard_gerant2id_value_FormattedValue,1,0) 																							as Aff_Flag_Gerant_Redondant,
     if(ApplyMap('Map_SocieteHorsScope',_ard_societeid_value,0)=1 and ard_statutaffairecode <> '173090005',1,0) 										as Aff_Flag_Fermeture_Hors_Scope,
     if(ApplyMap('Map_Statut_Origine_Impossible',ard_statutaffairecode & '/' & ard_origineaffairecode,0)=1,1,0)									as Aff_Flag_Statut_Origine,
     if(ApplyMap('Map_Statut_Etape_Impossible',ard_statutaffairecode & '/' & ard_etapeprocess,0)=1,1,0)											as Aff_Flag_Statut_Etape,
     if(ApplyMap('Map_Phase_Statut_Impossible',ApplyMap('Map_Phase_Affaire',ard_affaireid) & '/' & ard_origineaffairecode,0)=1,1,0)				as Aff_Flag_Phase_Statut,
     if(IsNull(ApplyMap('Map_Workflow_Affaire',ard_affaireid,null())) and ard_origineaffairecode='173090002',1,0)								as Aff_Flag_Prospection_Sans_Workflow,
     if(not IsNull(ApplyMap('Map_Workflow_Affaire',ard_affaireid,null())) and ard_origineaffairecode<>'173090002',1,0)							as Aff_Flag_Workflow_Hors_Prospection,
     if(ApplyMap('Map_Categorie_Statut_Impossible',ApplyMap('Map_Categorie_Societe',_ard_societeid_value) & '/' & ard_statutaffairecode,0)=2,1,0)		as Aff_Flag_Categorie_Statut,
     if(ApplyMap('Map_Affaire_Contact_Intermediaire',ard_affaireid,0)=0 and ard_origineaffairecode = '173090000',1,0)								as Aff_Flag_Advisor,
     ard_datafeed as Aff_Is_Datafeed
FROM [$(v_FolderQVD_Path)Affaire.qvd] (qvd);


left join(Dim_Affaire)
LOAD
    _parentcustomerid_value 	as Aff_Id_Societe,
    contactid 					as Aff_Id_Societe_Contact
Resident Contact;

left join(Dim_Affaire)
Load
	accountid							as Aff_Id_Societe,
// 	Soc_Is_Digital 						as Aff_Is_Digital,
    name		 						as Aff_Lib_Societe,
    accountcategorycode_FormattedValue 	as Aff_Lib_Societe_Categorie,
    ard_secteurcode_FormattedValue		as Aff_Lib_Societe_Secteur
Resident Account;

left Join(Dim_Affaire)
LOAD
    systemuserid							as Aff_Id_Analyste,
    if(ard_qliktypecode='173090000',1,0) 	as Aff_Is_Real_Analyste
Resident SystemUser;

left Join(Dim_Affaire)
LOAD
    accountid as Aff_Id_Acquereur,
    accountcategorycode as AccountCategoryCode,
    accountcategorycode_FormattedValue as Aff_Lib_Categorie_Acquereur,
    if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocietePortefeuille)','$(vCategorieSocieteSortiePortefeuille)')>0,1,0)		as Aff_Acquereur_Is_Portfolio
Resident Account;





///$tab Aff is last / first
Temp_1:
NoConcatenate
LOAD
	*,
	if(peek(Aff_Id_Societe) <> Aff_Id_Societe or isnull(peek(Aff_Id_Societe)), 1, 0) as Aff_Is_Last;
LOAD Distinct 
     Aff_Id,
     Aff_Id_Societe,
     Aff_Dtm_Ouverture
Resident Dim_Affaire
Order by Aff_Id_Societe asc, Aff_Dtm_Ouverture desc;


Dim_Affaire_2:
NoConcatenate
Load
	*,
    Aff_Id&'-'&Aff_Id_Societe as Key_join
Resident Dim_Affaire;

left join(Dim_Affaire_2)
abc:
Load
	Aff_Id&'-'&Aff_Id_Societe as Key_join,
    Aff_Is_Last 
Resident Temp_1
where Aff_Is_Last=1;

// drop field Key_join;
drop tables Temp_1;

Temp_2:
NoConcatenate
LOAD
	*,
	if(peek(Aff_Id_Societe) <> Aff_Id_Societe or isnull(peek(Aff_Id_Societe)), 1, 0) as Aff_Is_First;
LOAD Distinct 
     Aff_Id,
     Aff_Id_Societe,
     Aff_Dtm_Ouverture
Resident Dim_Affaire
Order by Aff_Id_Societe asc, Aff_Dtm_Ouverture asc;


NoConcatenate

Dim_Affaire_3:

Load  * Resident Dim_Affaire_2;
left join
abc:
Load Aff_Id&'-'&Aff_Id_Societe as Key_join,
    Aff_Is_First 
Resident Temp_2 where Aff_Is_First=1 ;

// drop field Key_join;
Drop Table Temp_2;
Drop Table Dim_Affaire;
Drop Table Dim_Affaire_2;


///$tab Dim Affaire
Dim_Affaire_4:
NoConcatenate
LOAD distinct
	*
resident Dim_Affaire_3;

left Join(Dim_Affaire_4)
LOAD 
     Aff_Id,
     date(if(Aff_Lib_Origine='$(vOrigineAffaireMarche)',date(DayEnd(Aff_Date_Deal_Marche),'DD/MM/YYYY'),
     DayEnd(rangemax(  Aff_Dtm_Created_On,
//     Aff_Date_Overriden_Created_On,    
    Aff_Date_2Pager,
    Aff_Date_Comite,
    Aff_Date_Demande_Contact_Effectuee,
    Aff_Date_Exclusivite,
    Aff_Date_Loi,
    Aff_Date_Management_Presentation,
    Aff_Date_NdaIm,
    Aff_Dtm_Ouverture,
    Aff_Date_Relance_Effectuee,
    Aff_Date_Reponse_Recue,
    Aff_Date_Shortlisted,
    Aff_Date_Statut,
    Aff_Date_Teaser_Recu,    
    Aff_Date_Cession,
    Aff_Date_Teaser_Envoye,    
    Aff_Date_Etape_Process,    
    Aff_Date_RDV_Call_Dirigeant,    
    Aff_Date_Closing,    
    Aff_Date_Pre_Qualification,
    if(Aff_Id_Statut_Affaire=173090005,0,today()+1)))) ,'DD/MM/YYYY')  as #Cle_Pivot_Periode_Max,
    
     date(if(Aff_Lib_Origine='$(vOrigineAffaireMarche)',Daystart(Aff_Date_Deal_Marche), DayStart(rangemin(  Aff_Dtm_Created_On,
//     Aff_Date_Overriden_Created_On,    
    Aff_Date_2Pager,
    Aff_Date_Comite,
    Aff_Date_Demande_Contact_Effectuee,
    Aff_Date_Exclusivite,
    Aff_Date_Loi,
    Aff_Date_Management_Presentation,
    Aff_Date_NdaIm,
    Aff_Dtm_Ouverture, 
    Aff_Date_Relance_Effectuee,
    Aff_Date_Reponse_Recue,
    Aff_Date_Shortlisted,
    Aff_Date_Statut,
    Aff_Date_Teaser_Recu,    
    Aff_Date_Cession,
    Aff_Date_Teaser_Envoye,    
    Aff_Date_Etape_Process,    
    Aff_Date_RDV_Call_Dirigeant,    
    Aff_Date_Closing,    
    Aff_Date_Pre_Qualification))),'DD/MM/YYYY')   as #Cle_Pivot_Periode_Min //Aff_Date_Min
resident Dim_Affaire_3;

DROP table Dim_Affaire_3;

NoConcatenate
Dim_Affaire:
load
	*
Resident Dim_Affaire_4
where not isnull(#Cle_Pivot_Periode_Max)
and not isnull(#Cle_Pivot_Periode_Min);

DROP table Dim_Affaire_4;

STORE Dim_Affaire INTO [$(v_FolderQVD_Path_Store)Dim_Affaire.qvd] (qvd);
DROP table Dim_Affaire;

End If

///$tab -- Debut 20 Affaire Contact Intermediaire

///$tab Dim Apporteur d'Affaires
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*')>0 then

Dim_Affaire_Contact_Intermediaire_Temp:
LOAD
     ard_affaireid				as Interm_Id_Affaire, 
     contactid					as Interm_Id,
     '$(vTypeContactInterm)'	as Interm_Lib_Type
FROM
[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd] (qvd);

outer join(Dim_Affaire_Contact_Intermediaire_Temp)
load
	_parentcustomerid_value		as Interm_Id_Societe,
	contactid	 				as Interm_Id
Resident Contact;



left join(Dim_Affaire_Contact_Intermediaire_Temp)
load
	accountid as Interm_Id_Societe,
	name as Interm_Lib_Societe,
    Timestamp(createdon) as Interm_Date_Created_On,
    Timestamp(new_datedecreation) as Interm_Date_Incorporated_On,
    _createdby_value_FormattedValue as Interm_Lib_Created_By_Name,
// 	_ard_formmodifiedbyid_value_FormattedValue as ard_FormModifiedByIdName,
// 	Timestamp(ard_formmodifiedon) as ard_FormModifiedOn,
// 	accountcategorycode as AccountCategoryCode,
	accountcategorycode_FormattedValue as AccountCategoryName,
	ard_address1_country as Address1_Country,
	ard_address1_country_FormattedValue as Address1_Country_Name,
      
	address1_city as Address1_City,
	ard_secteurcode as ard_SecteurCode,
    ard_secteurcode_FormattedValue as ard_SecteurName,
	new_commentairestatut as New_commentairestatut,
	'['&If((ard_straddress1longitude>=0 Or ard_straddress1longitude<=0) And (ard_straddress1latitude>=0 Or ard_straddress1latitude<=0),ard_straddress1longitude & ',' & ard_straddress1latitude)&']' as Interm_Geo_Position,
// 	'$(v_Url_Path_Societe)' & replace(replace(accountid,'{',''),'}','') & '&pagetype=entityrecord'  AS Interm_Lien,
	'$(v_URL_Standard_Start)' & '$(v_EntityName_Account)' & '$(v_URL_Standard_End)' & accountid		as Interm_Lien,
	new_objet as Interm_Lib_Objet,
	description as Interm_Lib_Description,
	_ownerid_value_FormattedValue as Interm_Lib_Gerant1_Name,
	_new_gerant2id_value_FormattedValue as Interm_Lib_Gerant2_Name,
	_new_gerant3id_value_FormattedValue as Interm_Lib_Gerant3_Name,
	_new_analysteid_value_FormattedValue as Interm_Lib_Analyste_Name,
	if(not isnull(_ownerid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)')) as Interm_Lib_Gerant1_Short,
	if(not isnull(_new_gerant2id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_gerant2id_value_FormattedValue,'$(vLibAutres)')) as Interm_Lib_Gerant2_Short,
	if(not isnull(_new_gerant3id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_gerant3id_value_FormattedValue,'$(vLibAutres)')) as Interm_Lib_Gerant3_Short,
	if(not isnull(_new_analysteid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_analysteid_value_FormattedValue,'$(vLibAutres)')) as Interm_Lib_Analyste_Short,
	_modifiedby_value_FormattedValue as Interm_Lib_Modified_By_Name,
	Timestamp(ard_formmodifiedon) as Interm_Date_Modified_On,
    '$(v_URL_Standard)' & entityimage_url as Interm_Lien_Photo
// 	ard_Ticketmaxm as Interm_Mon_Ticket_Max_M,
// 	ard_Ticketmaxmclient  as Interm_Mon_Ticket_Max_M_Client,
// 	ard_Ticketmin  as Interm_Mon_Ticket_Min,
// 	ard_Ticketminmclient  as Interm_Mon_Ticket_Min_Client,
// 	ard_Ticketpotentielmclient as Interm_Mon_Ticket_Potentiel_M_Client
Resident Account;


left join(Dim_Affaire_Contact_Intermediaire_Temp)
LOAD
    ard_affaireid 	as Interm_Id_Affaire,
    _ard_societeid_value	as Interm_Id_Cible
Resident Affaire;

left join(Dim_Affaire_Contact_Intermediaire_Temp)
load
	accountid 	as Interm_Id_Cible,
	name 		as Interm_Lib_Cible_Name
Resident Account;


NoConcatenate
Dim_Affaire_Contact_Intermediaire:
load
     Interm_Id_Societe & '/' & Interm_Id_Affaire & '/' & Interm_Id								as #Cle_Pivot_Gerant_Interm,
     Interm_Id_Societe & '/' & Interm_Id														as #Cle_Pivot_Pays_Interm,
     Interm_Id_Affaire, 
     Interm_Id,
     Interm_Lib_Type,
     Interm_Id_Societe,
     Interm_Lib_Societe,
     Interm_Id_Cible,
     Interm_Lib_Cible_Name,
     Interm_Date_Incorporated_On,
     Interm_Date_Created_On,
     Interm_Lib_Created_By_Name,
//      ard_FormModifiedByIdName as Interm_Lib_Modified_By,
//  	  ard_FormModifiedOn as Interm_Dtm_Modified_On,
      AccountCategoryName as Interm_Lib_Categorie,
      if(Match(AccountCategoryName,'$(vCategorieSocieteMnA)','$(vCategorieSocieteBanque)','$(vCategorieSocieteAvocat)','$(vCategorieSocieteAudit)','$(vCategorieSocieteAutre)')>0,1,0)	as Interm_Is_Advisor,
      Address1_Country as Interm_Id_Pays,
      Address1_Country_Name as Interm_Lib_Pays,
      Address1_City as Interm_Lib_Ville,
      ard_SecteurName as Interm_Lib_Secteur,
	  ApplyMap('Map_Secteur_Societe',ard_SecteurName,null()) as Interm_Lib_Secteur_Short,
      New_commentairestatut as Interm_Lib_Commentaire,
      Interm_Geo_Position,
      Interm_Lien,
      Interm_Lib_Objet,
      Interm_Lib_Description,
      Interm_Lib_Gerant1_Name,
      Interm_Lib_Gerant2_Name,
      Interm_Lib_Gerant3_Name,
      Interm_Lib_Analyste_Name,
      Interm_Lib_Gerant1_Short,
      Interm_Lib_Gerant2_Short,
      Interm_Lib_Gerant3_Short,
      Interm_Lib_Analyste_Short,
      Interm_Lib_Modified_By_Name,
	  Interm_Date_Modified_On,
      Interm_Lien_Photo
//       Interm_Mon_Ticket_Max_M,
// 	  Interm_Mon_Ticket_Max_M_Client,
// 	  Interm_Mon_Ticket_Min,
// 	  Interm_Mon_Ticket_Min_Client,
// 	  Interm_Mon_Ticket_Potentiel_M_Client
resident Dim_Affaire_Contact_Intermediaire_Temp;

// left join(Dim_Affaire_Contact_Intermediaire)
// LOAD
// 	Value 			as Interm_Lib_Pays,
//     AttributeValue 	as Interm_Id_Pays
// FROM [$(v_FolderQVD_Path)Pays.qvd] (qvd);


drop table Dim_Affaire_Contact_Intermediaire_Temp;


///$tab Link Table Intermediraire
Link_Table_tmp:
Load Distinct
    Interm_Id_Societe,
    Interm_Id,
    Interm_Id_Cible,
    Interm_Id_Affaire
Resident Dim_Affaire_Contact_Intermediaire;



Link_Table_Intermediaire:
Load
	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire		as #Cle_Interm_Id,
    Interm_Id_Societe & '/' & Interm_Id & '/' & Interm_Id_Affaire								as #Cle_Interm_Id_Fact,
//     Interm_Id_Societe & '/' & Interm_Id_Affaire & '/' & Interm_Id								as #Cle_Pivot_Gerant_Interm,
//     Interm_Id_Societe & '/' & Interm_Id															as #Cle_Pivot_Pays_Interm,
    Interm_Id																					as Interm_Act_Id_RegardingObject,
    '$(vIntermLinkCon)'																			as Interm_Link_Type
Resident Link_Table_tmp
Where not IsNull(Interm_Id_Societe)
and not IsNull(Interm_Id)
//and not IsNull(Interm_Id_Affaire)
;


Concatenate(Link_Table_Intermediaire)
Load
	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire		as #Cle_Interm_Id,
    '/' & Interm_Id & '/' & Interm_Id_Affaire													as #Cle_Interm_Id_Fact,
//     '/' & Interm_Id_Affaire & '/' & Interm_Id													as #Cle_Pivot_Gerant_Interm,
//     '/' & Interm_Id																				as #Cle_Pivot_Pays_Interm,
    Interm_Id																					as Interm_Act_Id_RegardingObject,
    '$(vIntermLinkCon)'																			as Interm_Link_Type
Resident Link_Table_tmp
Where not IsNull(Interm_Id_Societe)
and not IsNull(Interm_Id)
//and not IsNull(Interm_Id_Affaire)
;

Concatenate(Link_Table_Intermediaire)
Load
	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire		as #Cle_Interm_Id,
    Interm_Id_Societe & '//' & Interm_Id_Affaire												as #Cle_Interm_Id_Fact,
//     Interm_Id_Societe & '/' & Interm_Id_Affaire & '/'											as #Cle_Pivot_Gerant_Interm,
//     Interm_Id_Societe & '/'																		as #Cle_Pivot_Pays_Interm,
    Interm_Id_Societe																			as Interm_Act_Id_RegardingObject,	 
    '$(vIntermLinkSoc)'																			as Interm_Link_Type
Resident Link_Table_tmp
Where not IsNull(Interm_Id_Societe)
//and not IsNull(Interm_Id_Affaire)
;


// Concatenate(Link_Table_Intermediaire)
// Load
// 	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id		as #Cle_Interm_Id,
//     '/' & Interm_Id							as #Cle_Interm_Id_Fact,
//     Interm_Id								as Interm_Act_Id_RegardingObject,
//     'Con'									as Interm_Link_Type
// Resident Link_Table_tmp;

Concatenate(Link_Table_Intermediaire)
Load
	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire		as #Cle_Interm_Id,
    Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire									as #Cle_Interm_Id_Fact,
//     Interm_Id_Cible & '/' & Interm_Id_Affaire & '/' & Interm_Id									as #Cle_Pivot_Gerant_Interm,
//     Interm_Id_Cible & '/' & Interm_Id															as #Cle_Pivot_Pays_Interm,
    Interm_Id																					as Interm_Act_Id_RegardingObject,
    '$(vIntermLinkCibleCon)'																	as Interm_Link_Type
Resident Link_Table_tmp
Where not IsNull(Interm_Id_Cible)
and not IsNull(Interm_Id)
and not IsNull(Interm_Id_Affaire)
;

Concatenate(Link_Table_Intermediaire)
Load
	Interm_Id_Societe & '/' & Interm_Id_Cible & '/' & Interm_Id & '/' & Interm_Id_Affaire		as #Cle_Interm_Id,
    Interm_Id_Cible & '//' & Interm_Id_Affaire													as #Cle_Interm_Id_Fact,
//     Interm_Id_Cible & '/' & Interm_Id_Affaire													as #Cle_Pivot_Gerant_Interm,
//     Interm_Id_Cible																				as #Cle_Pivot_Pays_Interm,
//    Interm_Id_Cible																				as Interm_Act_Id_RegardingObject,
    '$(vIntermLinkCible)'																		as Interm_Link_Type
Resident Link_Table_tmp
Where not IsNull(Interm_Id_Cible)
and not IsNull(Interm_Id_Affaire)
;

// Concatenate(Link_Table_Intermediaire)
// Load
// 	Interm_Id_Cible & '/' & Interm_Id		as #Cle_Interm_Id,
//     '/' & Interm_Id							as #Cle_Interm_Id_Fact,
//     Interm_Id								as Interm_Act_Id_RegardingObject,
//     'Cible Con'								as Interm_Link_Type
// Resident Link_Table_tmp;

Drop Table Link_Table_tmp;

STORE Dim_Affaire_Contact_Intermediaire INTO [$(v_FolderQVD_Path_Store)Dim_Affaire_Contact_Intermediaire.qvd] (qvd);
Drop table Dim_Affaire_Contact_Intermediaire;

STORE Link_Table_Intermediaire INTO [$(v_FolderQVD_Path_Store)Link_Table_Intermediaire.qvd] (qvd);
Drop table Link_Table_Intermediaire;

End If
///$tab -- Debut 20 Contact

///$tab Contact
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

//==============================================================================//
// Création de la dimension des contacts relatifs aux sociétés intermédiaires : 
// 1) Chargement des données brutes
// 2) Suppression des champs inutiles
// 3) Renomage des champs pour QlikView
//==============================================================================//

Dim_Contact:
LOAD 
	 _parentcustomerid_value as Con_Id_Societe,
	 contactid as Con_Id,
	 telephone1 as Con_Num_Telephone,
	 mobilephone as Con_Num_Mobilephone,
	 emailaddress1 as Con_Lib_Email,
	 // Attributs
	 if(fullname = '' OR IsNull(fullname),'$(vContactTitleInconnu)',fullname) as Con_Lib_Name,
	 if(jobtitle = '' OR IsNull(jobtitle),null(),if(jobtitle='$(vContactTitleInconnu)','',jobtitle)) AS Con_Lib_Title,
     date(Floor(birthdate)) as Con_Date_Birth,
//      ard_lienurl as Con_URL,
     '$(v_URL_Standard_Start)' & '$(v_EntityName_Contact)' & '$(v_URL_Standard_End)' & contactid			as Con_URL,
//      ard_list_event_FormattedValue as Con_Is_List_Event,
// 	 ard_cerclecode as Con_Id_Cercle,
// 	 ard_cerclecode_FormattedValue as Con_Lib_Cercle,
	 _ownerid_value as Con_Id_Gerant1,
	 _ownerid_value_FormattedValue as Con_Lib_Gerant_1_Name,
     _ard_gerant2id_value as Con_Id_Gerant2,
     _ard_gerant2id_value_FormattedValue as Con_Lib_Gerant_2_Name,
     _ard_gerant3id_value as Con_Id_Gerant3,
     _ard_gerant3id_value_FormattedValue as Con_Lib_Gerant_3_Name,
//      new_cenmember_FormattedValue as Con_Is_CEN_Member, 
//      address1_line1 as Con_Lib_Address_Line1, 
// 	 address1_line2 as Con_Lib_Address_Line2, 
	 address1_city as Con_Lib_Address_City,
// 	 address1_postalcode as Con_Lib_PostalCode,
//  	 ard_address1_country as Old_Pays_Contact,
	 ard_address1_country_FormattedValue as Con_Lib_Country,
// 	 ard_mailing_FormattedValue as Con_Is_Mailing,
//      ard_langue_echange_FormattedValue as Con_Lib_Langue_Echange,
     description as Con_Lib_Desc,
//      ard_straddress1precisiongeo as Con_Geo_Precision,
	 ard_straddress1latitude as Con_Geo_Latitude, 
     ard_straddress1longitude as Con_Geo_Longitude,
//      ard_isavoir_FormattedValue as Con_Is_A_Voir,
//      _ard_avoirutilisateur_value_FormattedValue as Con_Lib_A_Voir_Utilisateur,
     ConvertToLocalTime(Timestamp(ard_avoirdate), 'Paris') as Con_Date_A_Voir,
//      _ard_avoirgerant1_value_FormattedValue as Con_Lib_A_Voir_Gerant1,
// //      ard_AVoirGerant2Name as Con_Lib_A_Voir_Gerant2,
// //      _ard_avoirgerant3_value_FormattedValue as Con_Lib_A_Voir_Gerant3,
     ConvertToLocalTime(Timestamp(createdon), 'Paris') as Con_Dtm_Creation,
     ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Con_Dtm_Modification,
//      GeoMakePoint(ard_straddress1latitude, ard_straddress1longitude) as Con_Geo_Point,
//      _modifiedby_value_FormattedValue as Con_Lib_Modified_By_Name,
     ConvertToLocalTime(Timestamp(ard_formmodifiedon), 'Paris') as Con_Dtm_Form_Modified_On,
     if(not isnull(_ownerid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)')) as Con_Lib_Gerant1_Short,
     if(not isnull(_ard_gerant2id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_gerant2id_value_FormattedValue,'$(vLibAutres)')) as Con_Lib_Gerant2_Short,
     if(not isnull(_ard_gerant3id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_gerant3id_value_FormattedValue,'$(vLibAutres)')) as Con_Lib_Gerant3_Short,
     
     if(not isnull(_ard_formmodifiedbyid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_formmodifiedbyid_value_FormattedValue,'$(vLibAutres)')) as Con_Lib_Form_Modified_By_Name,
     
     _createdby_value_FormattedValue as Con_Lib_Created_By_Name,
//      if(not isnull(_createdby_value_FormattedValue), ApplyMap('Map_Gerant_Short',_createdby_value_FormattedValue,'$(vLibAutres)')) as Con_Lib_Created_By_Name_Short,
// //      ard_Positionnement as Con_Num_Positionnement,
// //      ard_Ticketmaxm as Con_Mon_Ticket_Max_M,
// //      ard_Ticketminm as Con_Mon_Ticket_Min_M,
     ard_lienlinkedinurl as Con_Lien_LinkedIn,
     '$(v_URL_Standard)' & entityimage_url as Con_Lien_Photo,
     
     if(ApplyMap('Map_Type_Gerant',_ownerid_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_ard_gerant2id_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_ard_gerant3id_value_FormattedValue) = 2,1,0)															as Con_Flag_Gerant_Analyste,
     if(ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_ard_gerant2id_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_ard_gerant3id_value_FormattedValue,0) = 0,1,0)														as Con_Flag_Gerant_Requis,
     if((ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0 and not IsNull(_ownerid_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_ard_gerant2id_value_FormattedValue,0) = 0 and not IsNull(_ard_gerant2id_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_ard_gerant3id_value_FormattedValue,0) = 0 and not IsNull(_ard_gerant3id_value_FormattedValue)),1,0)					as Con_Flag_Clean_Gerant,
     if(_ownerid_value_FormattedValue = _ard_gerant2id_value_FormattedValue
     	or _ownerid_value_FormattedValue = _ard_gerant3id_value_FormattedValue
     	or _ard_gerant3id_value_FormattedValue = _ard_gerant2id_value_FormattedValue,1,0) 																		as Con_Flag_Gerant_Redondant,
     if(ApplyMap('Map_Categorie_Concernant_Contact',ApplyMap('Map_Categorie_Societe',_parentcustomerid_value),0)=2
     	and ApplyMap('Map_Activity_Email',_parentcustomerid_value,0)=1,1,0)																						as Con_Flag_Concernant_Email,
     if(ApplyMap('Map_Categorie_Concernant_Contact',ApplyMap('Map_Categorie_Societe',_parentcustomerid_value),0)=2
     	and ApplyMap('Map_Activity_RdvCall',_parentcustomerid_value,0)=1,1,0)																					as Con_Flag_Concernant_Rdv_Call,
      	ard_datafeed as Con_Is_Datafeed
FROM [$(v_FolderQVD_Path)Contact.qvd]
(qvd);

Left Join(Dim_Contact)
LOAD  
    _ard_societeid_value as Con_Id_Societe,
    ard_affaireid as Con_Aff_Id
Resident Affaire;

STORE Dim_Contact INTO [$(v_FolderQVD_Path_Store)Dim_Contact.qvd] (qvd);
DROP TABLE Dim_Contact;

End If
///$tab -- Debut 20 Finance

///$tab Finance
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityFinance)*')>0 then

// TMP_Max_Year:
// Load
// 	new_anneexercice as Fin_Year_Exercice,
//     _new_accountid_value as Fin_Id_Soc,
//     new_chiffreaffaire as Fin_Mon_CA,
//     new_ebitda as Fin_Mon_Ebitda,
//     new_ebit as Fin_Mon_Ebit
// Resident Finance;

NoConcatenate
TMP_Max_Year:
Load Distinct
	new_anneexercice
    , _new_accountid_value
    , new_ebitda
    , new_ebit
FROM [$(v_FolderQVD_Path)Finance.qvd]
(qvd)
where new_anneexercice <= Year(Today());

NoConcatenate
EBIT_EBITDA_Select:
Load
	_new_accountid_value
    , Count(distinct new_ebitda) as Nb_ebitda
    , Count(distinct new_ebit) as Nb_ebit
Resident TMP_Max_Year
group by _new_accountid_value;

Drop Table TMP_Max_Year;

///////////// DEFINE THE FINANCE TABLE //////////////////
Dim_Finance:
LOAD
    	new_anneexercice as Fin_Year_Exercice,
		new_financeid as Fin_Id,
        _new_accountid_value as Fin_Id_Soc,
// 		'Lien<url>' & '$(v_Url_Path_Finance)' & new_financeid AS Fin_Lien,
     	'$(v_URL_Standard_Start)' & '$(v_EntityName_Finance)' & '$(v_URL_Standard_End)' & new_financeid			as Fin_Lien,
		
		// Mesures
		new_chiffreaffaire as Fin_Mon_CA,// AS %CA,
		new_ebit as Fin_Mon_Ebit,// AS %EBIT,
		new_ebitperct as Fin_Prc_Ebit,// AS %EBIT_Pourcent,
		new_ebitda as Fin_Mon_Ebitda,// AS %EBITDA,
		new_effectif as Fin_Num_Effectif,// AS %Effectifs,
		new_rn as Fin_Mon_RN,// AS %RN,
		new_tresorerie as Fin_Mon_Tresorerie,// AS %TRESO,
		new_dettefinanciere as Fin_Mon_Dette,// AS %DF,
		new_dettefinancierenet as Fin_Mon_Dette_Net,// AS %DFN,
// 		New_DividendesRecusKEuro as Fin_Mon_Dividendes_Recus_Keuro,// AS %DIV,
// 		new_OC as Fin_Mon_OC,// AS %OC,
		new_chiffreaffaireperct as Fin_Prc_CA,//,
		new_ebitdaperct as Fin_Prc_Ebitda,//,
		new_rnperct as Fin_Prc_RN,//,
// 		New_ISR as Fin_Dtm_ISR,//,
		new_type_FormattedValue as Fin_Lib_Type,
        ard_source as Fin_Lib_Source,// as Finance_Source,
        date(daystart(ard_datesaisie),'DD/MM/YYYY') as Fin_Date_Saisie, //as Finance_DateSaisie
        new_comptesdecales as Fin_Date_Comptes_Decales,
//         New_commentaireoperation,
        new_description as Fin_Lib_Commentaire,
        if(new_anneexercice=year(ApplyMap('Map_Societe_Creation',_new_accountid_value)),1,0) as Fin_Is_On_CreationYear,
     	ConvertToLocalTime(Timestamp(createdon), 'Paris') as Fin_Dtm_Creation,
     	ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Fin_Dtm_Modification,
        _createdby_value_FormattedValue as Fin_Lib_Created_By,
        _modifiedby_value_FormattedValue as Fin_Lib_Modified_By,
      	ard_datafeed as Fin_Is_Datafeed
FROM [$(v_FolderQVD_Path)Finance.qvd]
(qvd)
where new_anneexercice>1900;

left join(Dim_Finance)
Load 
	_new_accountid_value		as Fin_Id_Soc
    , If(Nb_ebitda >= Nb_ebit
    	, 'EBITDA'
        , 'EBIT'
    ) 							as Fin_Lib_EBIT_EBITDA
Resident EBIT_EBITDA_Select;

Drop Table EBIT_EBITDA_Select;

// left Join(TMP_Finance)
// LOAD
// 	accountid as Fin_Id_Soc,
// 	year(new_datedecreation) as New_datedecreation
// Resident Account
// where not isnull(accountid);

// left join(TMP_Finance)
// Load
// 	Max(Fin_Year_Exercice) as Fin_Year_Exercice,
//     Fin_Id_Soc,
//     1 as Fin_Is_Last_CA
// Resident TMP_Max_Year
// where not isnull(Fin_Mon_CA)
// group by Fin_Id_Soc;

// left join(TMP_Finance)
// Load
// 	Max(Fin_Year_Exercice) as Fin_Year_Exercice,
//     Fin_Id_Soc,
//     1 as Fin_Is_Last_EBIT
// Resident TMP_Max_Year
// where not isnull(Fin_Mon_Ebitda)
// group by Fin_Id_Soc;

// left join(TMP_Finance)
// Load
// 	Max(Fin_Year_Exercice) as Fin_Year_Exercice,
//     Fin_Id_Soc,
//     1 as Fin_Is_Last_EBITDA
// Resident TMP_Max_Year
// where not isnull(Fin_Mon_Ebit)
// group by Fin_Id_Soc;

// drop tables TMP_Max_Year;

// Dim_Finance:
// NoConcatenate
// load
// 	*,
// 	if(Fin_Year_Exercice=year(new_datedecreation),1,0) as Fin_Is_On_CreationYear
// //     if(Fin_Year_Exercice>=New_datedecreation,1,0) as Fin_Is_After_CreationYear
// resident TMP_Finance;

// drop table TMP_Finance ;

STORE Dim_Finance INTO [$(v_FolderQVD_Path_Store)Dim_Finance.qvd] (qvd);
DROP table Dim_Finance;

End If

///$tab -- Debut 20 Fonds

///$tab Fonds
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityFonds)*')>0 then

//==============================================================================//
// Création de la dimension opérations : 
// 1) Chargement des données brutes
// 2) Suppression des champs inutiles
// 3) Renomage des champs pour QlikView
//==============================================================================//

Dim_Fonds:
LOAD
	 new_fondid as Fond_Id,
// 	 CreatedByName as Fond_Lib_CreatedBy, 
//      ModifiedByName as Fond_Lib_ModifiedBy, 
     ConvertToLocalTime(Timestamp(createdon), 'Paris') as Fond_Dtm_CreatedOn,
     new_name as Fond_Lib_Name, 
//      new_commentaire as Fond_Lib_Comment,
//      new_description as Fond_Lib_Description, 
//      new_FundCreationDate as Fond_Date_Creation, 
//      new_montantsouscritnet as Fond_Mon_Souscrit_Net, 
//      new_performancefinale_avec_avantagefiscale as Fond_Num_Perf_Avec_Avantage_Fiscale, 
//      new_performancefinale_hors_avantagefiscale as Fond_Num_Perf_Sans_Avantage_Fiscale, 
     new_shortname as Fond_Lib_Short_Name,
     new_typefond as Fond_Lib_Type
FROM [$(v_FolderQVD_Path)Fonds.qvd]
(qvd);

STORE Dim_Fonds INTO [$(v_FolderQVD_Path_Store)Dim_Fonds.qvd] (qvd);
DROP TABLE Dim_Fonds;

End If

///$tab -- Debut 20 Fonds Concernes

///$tab Fonds Concernes
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityFonds_Concerne)*')>0 then

//==============================================================================//
// Création de la dimension opérations : 
// 1) Chargement des données brutes
// 2) Suppression des champs inutiles
// 3) Renomage des champs pour QlikView
//==============================================================================//

Fonds_concernes:
LOAD 
	//Clés
	new_fondconcerneid as FondC_Id,
	_new_fondid_value as FondC_Id_Concerne,
	_new_operationid_value as FondC_Id_Operation, 
	_new_societeid_value as FondC_Id_Societe,
    new_name as FondC_Lib_Name,
	new_montantinvestifond as FondC_Mon_Investi,
	new_montantrecufond as FondC_Mon_Recu,
    new_montantrecufond - new_montantinvestifond as FondC_Mon_Global,
	new_nombreinstruments as FondC_Num_Instruments_Nombre,
	new_prixunitaire as FondC_Mon_Prix_Unitaire,
	new_detailinstrument as FondC_Lib_Instrument_Detail,
    _ard_operationtypeid_value as FondC_Lib_Operation_Type_Id,
	ConvertToLocalTime(Date#(Date(new_dateoperation)), 'Paris') as FondC_Date_Operation,
    ard_typetransactioncode_FormattedValue as FondC_Lib_Transaction_Type,
    ard_typenaturecode_FormattedValue as FondC_Lib_Nature_Type,
	ard_idmdm as FondC_Id_MDM,
	ard_typeinstruments as FondC_Lib_Instrument_Type,
    ard_cost as FondC_Cost
//     new_commentaire as FondC_Lib_Commentaire
//      ApplyMap('Map_Transaction_Code',ard_TypeTransactionCode) as FondC_Lib_Transaction_Type,
//      ApplyMap('Map_Nature_Code',ard_TypeNatureCode) as FondC_Lib_Nature_Type
FROM [$(v_FolderQVD_Path)Fonds_concerne.qvd]
(qvd);

left join(Fonds_concernes)
load
    ard_operationtypeid as FondC_Lib_Operation_Type_Id,
    ard_name            as FondC_Lib_Operation_Type,
    ard_m0				as FondC_Lib_M0, 
    ard_m1				as FondC_Lib_M1, 
    ard_m2				as FondC_Lib_M2
FROM [$(v_FolderQVD_Path)Operation_Type.qvd] (qvd);

STORE Fonds_concernes INTO [$(v_FolderQVD_Path_Store)Dim_Fonds_concernes.qvd](qvd);
DROP TABLE Fonds_concernes;

End If

///$tab -- Debut 20 Operation

///$tab Operation
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityContact)*','*$(sEntityOperation)*')>0 then

Dim_Operation_Tmp:
LOAD
	new_operationid as Ope_Id,
	new_name as Ope_Lib_Name,
	_new_societe_value as Ope_Id_Societe,
// 	OwnerId as Ope_Id_Proprietaire,
// 	OwnerIdName as Ope_Lib_Proprietaire_Name,
    _new_societe_value_FormattedValue as Ope_Lib_Societe_Name,
	ConvertToLocalTime(new_dateoperation,'Paris') as Ope_Date, 
//     ApplyMap('Map_Has_Fonds_Concerne',new_HasFondConcerne,'$(vLibOui)') as Ope_Is_Fonds_Concerne,
// 	new_typeoperation as Ope_Id_Type,
    new_totalinvesti_axape as Ope_Mon_Montant_Investissement_€, 		
	new_totalrecu_axape_horsdividende as Ope_Mon_Montant_Sortie_€, 
// 	ard_effectifentree as Ope_Num_Effectif_Entree,
	new_anneereference as Ope_Year_Annee_Ref, 
	new_commentaire as Ope_Lib_Comment, 
	new_montant_actions as Ope_Mon_Montant_Actions, 
	new_montant_autre as Ope_Mon_Montant_Autre, 
	new_montant_oc as Ope_Mon_Montant_Oc, 
	new_totaltour as Ope_Mon_Total_Tour, 
	new_valeurentreprise_entree as Ope_Mon_valeurentreprise_entree, 
	new_valeurequity_postoperation_entree as Ope_Mon_valeurequity_postoperation_entree, 
	new_xca as Ope_Num_xca, 
	new_xebit as Ope_Num_xebit, 
	new_xebitda as Ope_Num_xebitda,
//     '$(v_Url_Path_Operation)' & replace(replace(new_operationid,'{',''),'}','') & '&pagetype=entityrecord' 		as Ope_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Operation)' & '$(v_URL_Standard_End)' & new_operationid			as Ope_Lien,
    new_typeoperation_FormattedValue as Ope_Lib_Type,
    ard_estxebitdaebitretraite as Ope_Is_XEbitEbitda_Retraite,
    ConvertToLocalTime(Timestamp(createdon), 'Paris') as Ope_Dtm_CreatedOn,
    ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Ope_Dtm_Modification,
    _createdby_value_FormattedValue as Ope_Lib_Created_By,
    _modifiedby_value_FormattedValue as Ope_Lib_Modified_By
FROM [$(v_FolderQVD_Path)Operation.qvd]
(qvd);

left Join(Dim_Operation_Tmp)
LOAD
	contactid as Ope_Id_Contact
    , _parentcustomerid_value as Ope_Id_Societe 
Resident Contact;

// left Join(Dim_Operation_Tmp)
// LOAD
// 	_new_gerant2id_value_FormattedValue  as Ope_Lib_Soc_Gerant_2_Name
//     , _new_analysteid_value_FormattedValue   as Ope_Lib_Soc_Analyste_Name
//     , _new_gerant3id_value_FormattedValue as Ope_Lib_Soc_Gerant_3_Name
//     , _ownerid_value as Ope_Id_Soc_Gerant_1
//     , _ownerid_value_FormattedValue as Ope_Lib_Soc_Gerant_1_Name
//     , accountid as Ope_Id_Societe
//     , _new_gerant3id_value  as Ope_Id_Soc_Gerant_3
//     , _new_gerant2id_value  as Ope_Id_Soc_Gerant_2
//     , _new_analysteid_value as Ope_Id_Soc_Analyste
// Resident Account;


///$tab Is Last Operation
// Tmp_1:
// NoConcatenate
// LOAD
// 	*,
// 	if(peek(Ope_Id_Societe) <> Ope_Id_Societe or isnull(peek(Ope_Id_Societe)), 1, 0) as Ope_Is_Last;
// LOAD distinct 
//     Ope_Id_Societe,
//     Ope_Id,
//     Ope_Date
// Resident Dim_Operation_Tmp
// Order by Ope_Id_Societe asc, Ope_Date desc;

Tmp_2:
NoConcatenate
LOAD distinct 
    Ope_Id_Societe,
    min(Year(Ope_Date)) as Ope_Year_First_Operation
Resident Dim_Operation_Tmp
group by Ope_Id_Societe;


Dim_Operation:
NoConcatenate
LOAD
	*
Resident Dim_Operation_Tmp;


// left Join(Dim_Operation)
// load
// 	*
// Resident Tmp_1;


left Join(Dim_Operation)
load
	*
Resident Tmp_2;

Drop Table Tmp_2;
Drop Table Dim_Operation_Tmp;
// drop Tables Tmp_1,Tmp_2,Dim_Operation_Tmp;

STORE Dim_Operation INTO [$(v_FolderQVD_Path_Store)Dim_Operation.qvd] (qvd);
DROP TABLE Dim_Operation;

End If

///$tab -- Debut 20 Suivi valo

///$tab Suivi de Valorisation
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityFonds_Concerne)*')>0 then

//==============================================================================//
// Création de la dimension opérations : 
// 1) Chargement des données brutes
// 2) Suppression des champs inutiles
// 3) Renomage des champs pour QlikView
//==============================================================================//

Tmp_Last_Suivi_De_Valo:
LOAD _new_societeid_value               as Val_Id_Societe
	, ConvertToLocalTime(Date#(Date(max(new_date_comite))), 'Paris') as Val_Date_Comite
FROM [$(v_FolderQVD_Path)Suivi_De_Valorisation.qvd] (qvd)
group by _new_societeid_value;


Dim_Suivi_De_Valorisation:
LOAD 
	new_suividevalorisationid          as Val_Id
	, _new_societeid_value             as Val_Id_Societe
	, _new_societeid_value_FormattedValue as Val_Lib_Societe
	, _ard_fondsid_value               as Val_Id_Fonds
	, _ard_fondsid_value_FormattedValue as Val_Lib_Fonds
	, ConvertToLocalTime(Date#(Date(new_date_comite)),'Paris')     as Val_Date_Comite
    , ConvertToLocalTime(new_date_comite,'Paris')	as Val_TimeStamp_Date_Comite
//	, new_date_comite					as Val_TimeStamp_Date_Comite
	, ard_typeinstrument               as Val_Lib_Type_Instrument
	, new_multiple_retenu              as Val_Num_Multiple_Retenu
	, ard_multipleretenutvpi           as Val_Num_Multiple_Retenu_TVPI
    , ard_cost                         as Val_Mon_Cost
	, ard_fmv                          as Val_Mon_FMV
	, ard_ticket                       as Val_Mon_Ticket
// 	, ard_valeur_entreprise_corresp    as Val_Mon_Valeur_Entreprise_Corresp
// 	, ard_valeur_titre_correspondante  as Val_Mon_Valeur_Titre_Corresp
// 	, new_commentaire_gerant           as Val_Lib_Comment_Gerant
// 	, new_commentaire_valo             as Val_Lib_Comment_Valo
// 	, new_methodevalo                  as Val_Lib_Methode_Valo
FROM [$(v_FolderQVD_Path)Suivi_De_Valorisation.qvd] (qvd);

left join(Dim_Suivi_De_Valorisation)
LOAD Val_Id_Societe
	, Val_Date_Comite
    , '1' as Val_Is_Last_Date
Resident Tmp_Last_Suivi_De_Valo;

Drop table Tmp_Last_Suivi_De_Valo;

STORE Dim_Suivi_De_Valorisation INTO [$(v_FolderQVD_Path_Store)Dim_Suivi_De_Valorisation.qvd] (qvd);
DROP TABLE Dim_Suivi_De_Valorisation;

End If


///$tab -- Debut 20 Period

///$tab Calendrier Brut
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityOperation)*')>0 then

//===========================================================================
// Contruction du calendrier brut
// Les limites sont paramétrées ou définis suivant les données de faits
//===========================================================================



// Limites définies manuellement
LET vDateMin = Floor(YearStart(AddYears(today(),-4)));  
LET vDateMax = Floor(YearEnd(AddYears(today(),0)));  

// Limites définies suivant les données de faits
_Temp_Period:
// Faits sociétés - Utilisation de la date de création dans le SI CRM
LOAD Distinct
	Year(createdon)*10000 + Month(createdon)* 100 + Day(createdon) as Fact_Date
	//'Date_Societe' as Pivot_Date_Type // YYYYMMDD
Resident Account;
	
// // Faits Finance - Année
// CONCATENATE (_Temp_Period)
// LOAD Distinct 
//      (New_anneexercice*10000) + 100 + 01 as Fact_Date
//      //'Date_Finance' as Pivot_Date_Type // YYYYMMDD
// FROM
// 	[$(v_FolderQVD_Path)Finance.QVD] (qvd);

// Faits Opérations - Date de l'opération
CONCATENATE (_Temp_Period)
LOAD Distinct
	Year(new_dateoperation)*10000 + Month(new_dateoperation)* 100 + Day(new_dateoperation) as Fact_Date
	//'Date_Operation' as Pivot_Date_Type // YYYYMMDD
FROM [$(v_FolderQVD_Path)Operation.qvd] (qvd);
	
	// Faits Affaires - Date de l'ouverture de l'affaire
CONCATENATE (_Temp_Period)
LOAD Distinct
	Year(ard_dateouverture)*10000 + Month(ard_dateouverture)* 100 + Day(ard_dateouverture) as Fact_Date
	//'Date_Affaire' as Pivot_Date_Type //YYYYMMDD
	//Year(new_dateoperation)*10000 + Month(new_dateoperation)* 100 + Day(new_dateoperation) as Fact_Date // YYYYMMDD
Resident Affaire;
	
// Work on distinct dates
NOCONCATENATE
_Temp_DistinctPeriodID:
LOAD Distinct
	if(Fact_Date<=19000101,19000101,Fact_Date) as Period_id_Distinct
	//Pivot_Date_Type
RESIDENT _Temp_Period
//WHERE Fact_Date > 19000101
ORDER BY Fact_Date ASC; // Seulement les dates pertinentes

DROP TABLE _Temp_Period;

// Determine les périodes min et max
MinMaxPeriod_id:
LOAD 
	 min(Year(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Year_Min,
     max(Year(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Year_Max,
	 min(Year(date#(Period_id_Distinct,'YYYYMMDD'))*10 + Ceil(Month(date#(Period_id_Distinct,'YYYYMMDD'))/3)) as Period_Quarter_Min,
     max(Year(date#(Period_id_Distinct,'YYYYMMDD'))*10 + Ceil(Month(date#(Period_id_Distinct,'YYYYMMDD'))/3)) as Period_Quarter_Max,
	 min(Year(date#(Period_id_Distinct,'YYYYMMDD'))*100 + Month(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Month_Min,
     max(Year(date#(Period_id_Distinct,'YYYYMMDD'))*100 + Month(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Month_Max,
	 min(Year(date#(Period_id_Distinct,'YYYYMMDD'))*100000 + Month(date#(Period_id_Distinct,'YYYYMMDD'))* 1000 + Week(date#(Period_id_Distinct,'YYYYMMDD'))* 10 ) as Period_Week_Min,
     max(Year(date#(Period_id_Distinct,'YYYYMMDD'))*100000 + Month(date#(Period_id_Distinct,'YYYYMMDD'))* 1000 + Week(date#(Period_id_Distinct,'YYYYMMDD'))* 10 ) as Period_Week_Max,
	 min(Year(date#(Period_id_Distinct,'YYYYMMDD'))*10000 + Month(date#(Period_id_Distinct,'YYYYMMDD'))* 100 + Day(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Date_Min,
     max(Year(date#(Period_id_Distinct,'YYYYMMDD'))*10000 + Month(date#(Period_id_Distinct,'YYYYMMDD'))* 100 + Day(date#(Period_id_Distinct,'YYYYMMDD'))) as Period_Date_Max
     //Pivot_Date_Type
RESIDENT _Temp_DistinctPeriodID
WHERE Period_id_Distinct > 19000101;

DROP TABLE _Temp_DistinctPeriodID;


LET vDateMin = Num(MakeDate(Year(Date#(Peek('Period_Date_Min'),'YYYYMMDD')),Month(Date#(Peek('Period_Date_Min'),'YYYYMMDD')),Day(Date#(Peek('Period_Date_Min'),'YYYYMMDD')))); 
LET vDateMax = Num(MakeDate(Year(Date#(Peek('Period_Date_Max'),'YYYYMMDD')),Month(Date#(Peek('Period_Date_Max'),'YYYYMMDD')),Day(Date#(Peek('Period_Date_Max'),'YYYYMMDD')))); 


DROP TABLE MinMaxPeriod_id;
	
// Création du calendrier brut
TempCalendar:  
	LOAD 
		$(vDateMin) + RowNo() - 1 AS DateNumber,  
		Date($(vDateMin) + RowNo() - 1) AS TempDate,
		Addmonths(Date($(vDateMin) + RowNo() - 1),-$(vDateFicalOffsetMonth)) AS TempDateFiscal  
	AUTOGENERATE 1  
	WHILE $(vDateMin)+IterNo()-1<= $(vDateMax);  

///$tab Mapping for counters
/************************ CALENDAR CONTENT ********************/
// Periode Counter Mapping

// Mapping Year
GetDistinct:
LOAD distinct Year(TempDate) As DistinctVal
Resident TempCalendar;

Map_Year_counter:
Mapping Load 
	DistinctVal,
	RowNo()
Resident GetDistinct
Order by DistinctVal;

Drop Table GetDistinct;

// Mapping Quarter
GetDistinct:
LOAD distinct QuarterName(TempDate) As DistinctVal,
'Q'&Ceil(Month(TempDate)/3) &'-'& Year(TempDate) As FormatVal
Resident TempCalendar;

Map_Quarter_counter:
Mapping Load 
	FormatVal,
	RowNo()
Resident GetDistinct
Order by DistinctVal;

Drop Table GetDistinct;

// Mapping Month
GetDistinct:
LOAD distinct Monthname(TempDate) As DistinctVal
Resident TempCalendar;

Map_Month_counter:
Mapping Load 
	DistinctVal,
	RowNo()
Resident GetDistinct
Order by DistinctVal;

Drop Table GetDistinct;

// Mapping Week 
GetDistinct:
LOAD distinct WeekName(TempDate) As DistinctVal,
Replace(WeekName(TempDate), '/', '-W') As FormatVal
Resident TempCalendar;

Map_Week_counter:
Mapping Load 
	FormatVal,
	RowNo()
Resident GetDistinct
Order by DistinctVal;

Drop Table GetDistinct;



// Mapping Date 
GetDistinct:
LOAD distinct Date(TempDate) As DistinctVal
Resident TempCalendar;

Map_Date_counter:
Mapping Load 
	DistinctVal,
	RowNo()
Resident GetDistinct
Order by DistinctVal;

Drop Table GetDistinct;

/************************ CALENDAR CONTENT ********************/

///$tab Period
// Date :		Year(TempDate)*10000 + Month(TempDate)* 100 + Day(TempDate) as Period_id, // YYYYMMDD
// Week : 		Year(TempDate)*100000 + Month(TempDate)* 1000 + Week(TempDate)* 10 As Period_id, // YYYYMMWW0
// Month :		Year(TempDate)*100 + Month(TempDate) As Period_id,  // YYYYMM
// Quarter :	Year(TempDate)*10 + Ceil(Month(TempDate)/3) As Period_id,// YYYYQ
// Year :		Year(TempDate) As Period_id, //YYYY

Dim_Period:
NOCONCATENATE
LOAD
	Year(TempDate)*10000 + Month(TempDate)* 100 + Day(TempDate) as Period_id, // YYYYMMDD
	'$(vPeriodTypeDate)' as Period_Type,

	Year(TempDate) as Period_Year,
// 	'S'& ceil(Month(TempDate)/6) as Period_Semester,
// 	'S'& Ceil(Month(TempDate)/6) &'-'& Year(TempDate) as Period_SemesterName,
// 	'T'& Ceil(Month(TempDate)/3) as Period_Quarter,
// 	'T'& Ceil(Month(TempDate)/3) &'-'& Year(TempDate) as Period_QuarterName,
// 	Monthname(TempDate)  as Period_MonthName,
// 	Date(Monthname(TempDate),'MMM YY')  as Period_MonthName_Short,	
	Month(TempDate) As Period_Month,

// 	Day(TempDate) as Period_DayOfMonth,

// 	'W'&Week(TempDate) as Period_Week,
// 	Replace(WeekName(TempDate), '/', '-W') as Period_WeekName,
	TempDate as Period_Date

// 	WeekDay(TempDate) as Period_DayName,

// 	Date#(Date(TempDate, 'D MMM'), 'D MMM') as Period_DayMonth,
// 	Date#(Date(TempDate, 'WWW D MMM'), 'WWW D MMM') as Period_DayNameMonth,
// 	Date#(Date(TempDate, 'WWW D MMM YYYY'), 'WWW D MMM YYYY') as Period_DayNameMonthYear,


// 	If (TempDate = Date#(YearStart(TempDate)), 1, 0)  as Period_Flag_YearStartDate,
// 	If (TempDate = Date#(MonthStart(TempDate)), 1, 0)  as Period_Flag_MonthStartDate,
// 	If (TempDate = Date#(QuarterStart(TempDate)), 1, 0)  as Period_Flag_QuarterStartDate,
// 	If (TempDate = Date#(WeekStart(TempDate)), 1, 0)  as Period_Flag_WeekStartDate,
	
// 	// Used Date# to convert in Timestamp (if not convert the test is wrong)
// 	If (TempDate = Date#(YearEnd(TempDate)), 1, 0)  as Period_Flag_YearEndDate,
// 	If (TempDate = Date#(MonthEnd(TempDate)), 1, 0)  as Period_Flag_MonthEndDate,
// 	If (TempDate = Date#(QuarterEnd(TempDate)), 1, 0)  as Period_Flag_QuarterEndDate,
// 	If (TempDate = Date#(WeekEnd(TempDate)), 1, 0)  as Period_Flag_WeekEndDate,
		
// 	'FY'&Year(TempDateFiscal) as Period_FiscalYear,
// 	'FQ'&Ceil(Month(TempDateFiscal)/3) as Period_FiscalQuarter,
// 	'FM'&num(Ceil(Month(TempDateFiscal)/1)) as Period_FiscalMonthName,
// 	'FW'&Week(TempDateFiscal) as Period_FiscalWeek,
// 	Day(TempDateFiscal) as Period_FiscalDayOfMonth
	
RESIDENT TempCalendar
ORDER BY TempDate ASC;

/* Week at Week level */
CONCATENATE (Dim_Period)
LOAD distinct

	Year(TempDate)*100000 + Month(TempDate)* 1000 + Week(TempDate)* 10 As Period_id, // YYYYMMWW0
	'$(vPeriodTypeWeek)' As Period_Type,

	Year(TempDate) As Period_Year,
// 	'S'& ceil(Month(TempDate)/6) as Period_Semester,
// 	'S'& Ceil(Month(TempDate)/6) &'-'& Year(TempDate) as Period_SemesterName,
// 	'T'&Ceil(Month(TempDate)/3) as Period_Quarter,
// 	'T'&Ceil(Month(TempDate)/3) &'-'& Year(TempDate) as Period_QuarterName,
// 	Monthname(TempDate) As Period_MonthName,
// 	Date(Monthname(TempDate),'MMM YY')  as Period_MonthName_Short,
	Month(TempDate) As Period_Month

// 	'W'&Week(TempDate) as Period_Week,
// 	Replace(WeekName(TempDate), '/', '-W') as Period_WeekName
	
// 	'FY'&Year(TempDateFiscal) as Period_FiscalYear,
// 	'FQ'&Ceil(Month(TempDateFiscal)/3) as Period_FiscalQuarter,
// 	'FM'&num(Ceil(Month(TempDateFiscal)/1)) as Period_FiscalMonthName,
// 	'FW'&Week(TempDateFiscal) as Period_FiscalWeek
		
RESIDENT TempCalendar
ORDER BY TempDate ASC;


/* Month at Month level */
CONCATENATE (Dim_Period)
LOAD distinct

	Year(TempDate)*100 + Month(TempDate) As Period_id,  // YYYYMM
	'$(vPeriodTypeMonth)' As Period_Type,

	Year(TempDate) As Period_Year,
// 	'S'& ceil(Month(TempDate)/6) as Period_Semester,
// 	'S'& Ceil(Month(TempDate)/6) &'-'& Year(TempDate) as Period_SemesterName,
// 	'T'&Ceil(Month(TempDate)/3) as Period_Quarter,
// 	'T'&Ceil(Month(TempDate)/3) &'-'& Year(TempDate) as Period_QuarterName,
// 	Monthname(TempDate) As Period_MonthName,
// 	Date(Monthname(TempDate),'MMM YY')  as Period_MonthName_Short,
	Month(TempDate) As Period_Month
	
// 	'FY'&Year(TempDateFiscal) as Period_FiscalYear,
// 	'FQ'&Ceil(Month(TempDateFiscal)/3) as Period_FiscalQuarter,
// 	'FM'&num(Ceil(Month(TempDateFiscal)/1)) as Period_FiscalMonthName
	
RESIDENT TempCalendar
ORDER BY TempDate ASC;


/* Quarter at Quarter level */
CONCATENATE (Dim_Period)
LOAD distinct

	Year(TempDate)*10 + Ceil(Month(TempDate)/3) As Period_id,// YYYYQ
	'$(vPeriodTypeQuarter)' As Period_Type,

	Year(TempDate) As Period_Year
// 	'S'& ceil(Month(TempDate)/6) as Period_Semester,
// 	'S'& Ceil(Month(TempDate)/6) &'-'& Year(TempDate) as Period_SemesterName
// 	'T'&Ceil(Month(TempDate)/3) as Period_Quarter,
// 	'T'&Ceil(Month(TempDate)/3) &'-'& Year(TempDate) as Period_QuarterName
		
// 	'FY'&Year(TempDateFiscal) as Period_FiscalYear,
// 	'FQ'&Ceil(Month(TempDateFiscal)/3) as Period_FiscalQuarter

RESIDENT TempCalendar
ORDER BY TempDate ASC;


/* Year at Year level */
CONCATENATE (Dim_Period)
LOAD distinct

	Year(TempDate) As Period_id, //YYYY
	'$(vPeriodTypeYear)' As Period_Type,

	Year(TempDate) As Period_Year
	
// 	'FY'&Year(TempDateFiscal) as Period_FiscalYear
RESIDENT TempCalendar
ORDER BY TempDate ASC;

Drop table TempCalendar;

STORE Dim_Period INTO [$(v_FolderQVD_Path_Store)Dim_Period.qvd] (qvd);
DROP TABLE Dim_Period;

End If

///$tab -- Debut 20 Societe

///$tab Societe
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntitySystemUser)*')>0 then

Dim_Societe:
LOAD
	accountid as Soc_Id,
// 	accountnumber as Soc_Num_Number,
	name as Soc_Lib_Name,
// 	_new_correspondancedianeid_value_FormattedValue as Soc_Lib_Diane_Name,
	ConvertToLocalTime(Timestamp(createdon), 'Paris') as Soc_Dtm_Created_On,
    description as Soc_Lib_Description,
	accountcategorycode as Soc_Id_Categorie,
	accountcategorycode_FormattedValue as Soc_Lib_Categorie,
	if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocietePortefeuille)','$(vCategorieSocieteSortiePortefeuille)','$(vCategorieSocieteScope)','$(vCategorieSocieteFicheACompleter)','$(vCategorieSocieteHorsScope)')>0,1,0)	as Soc_Is_Target,
	if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocieteMnA)','$(vCategorieSocieteBanque)','$(vCategorieSocieteAvocat)','$(vCategorieSocieteAudit)','$(vCategorieSocieteAutre)')>0,1,0)										as Soc_Is_Advisor,
    if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocietePortefeuille)','$(vCategorieSocieteSortiePortefeuille)')>0,1,0)																										as Soc_Is_Portfolio,
    if(match(accountcategorycode_FormattedValue,'$(vCategorieSocieteDiane)','$(vCategorieSocieteDianeCRM)','$(vCategorieSocieteDianeHorsScope)')>0,1,0)																					as Soc_Is_Diane,
	if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocietePortefeuille)','$(vCategorieSocieteSortiePortefeuille)','$(vCategorieSocieteScope)','$(vCategorieSocieteHorsScope)')>0,1,0)											as Soc_Is_Big_Fish,
	if(Match(accountcategorycode_FormattedValue,'$(vCategorieSocietePortefeuille)','$(vCategorieSocieteSortiePortefeuille)','$(vCategorieSocieteScope)')>0,1,0)																			as Soc_Is_Chase,
	ApplyMap('Map_Parent_Categorie_Societe',accountcategorycode_FormattedValue,null()) as Soc_Lib_Parent_Categorie,
	ApplyMap('Map_Population',accountcategorycode_FormattedValue,null()) as Soc_Lib_Population,
// 	statuscode as Soc_Id_Status_Code,
	statuscode_FormattedValue as Soc_Lib_Status_Code,
// 	Timestamp(new_datestatut) as Soc_Dtm_Statut,
// 	Year(new_datestatut) as Soc_Year_Statut,
	ConvertToLocalTime(date(floor(createdon)), 'Paris') as Soc_Date_Creation,
	ConvertToLocalTime(date(floor(new_datedecreation)), 'Paris') as Soc_Date_Incorporation,
	_ownerid_value as Soc_Id_Gerant_1,
	_ownerid_value_FormattedValue as Soc_Lib_Gerant_1_Name,
	_new_gerant2id_value as Soc_Id_Gerant_2,
	_new_gerant2id_value_FormattedValue as Soc_Lib_Gerant_2_Name,
	_new_gerant3id_value as Soc_Id_Gerant_3,
	_new_gerant3id_value_FormattedValue as Soc_Lib_Gerant_3_Name,
// // 	New_Gerant4Id as Soc_Id_Gerant_4,
// // 	New_Gerant4IdName as Soc_Lib_Gerant_4_Name,
    _new_analysteid_value as Soc_Id_Analyste,
	_new_analysteid_value_FormattedValue as Soc_Lib_Analyste_Name,
// 	_new_codenafid_value_FormattedValue as Soc_Id_Code_Naf,				// Commenté par CLE le 26/07/2022
    new_commentairestatut as Soc_Lib_Statut_Com,
//     new_libellenaf as Soc_Lib_Naf,									// Commenté par CLE le 26/07/2022
// 	_transactioncurrencyid_value_FormattedValue as Soc_Lib_Transaction_Currency_Name,
	address1_city as Soc_Address1_City,
// 	ard_address1_country as Soc_Address1_Country,
	ard_address1_country_FormattedValue as Soc_Lib_Adresse1_Pays,
// 	address1_line1 as Soc_Address1_Line1,
// // 	address1_line2 as Soc_Address1_Line2,
// 	address1_postalcode as Soc_Address1_PostalCode,
	address1_stateorprovince as Soc_Address1_StateOrProvince,
// 	new_ficheatraiter_FormattedValue as Soc_Is_Fiche_A_Traiter,
// 	new_ficheanalyse_FormattedValue as Soc_Is_Fiche_Analyse,
// 	ard_iscotation_FormattedValue as Soc_Is_Cotation,
    
	ard_secteurcode_FormattedValue as Soc_Lib_Secteur,
	ApplyMap('Map_Secteur_Societe',ard_secteurcode_FormattedValue,null()) as Soc_Lib_Secteur_Short,
	
    '$(v_URL_Standard)' & entityimage_url as Soc_Lien_Photo,
// 	new_cotation as Soc_Lib_Cotation,
	new_objet as Soc_Lib_Objet,
	// Compteur de société
// 	1 as Soc_Num_Counter,
//     '$(v_Url_Path_Societe)' & replace(replace(accountid,'{',''),'}','') & '&pagetype=entityrecord'  AS Soc_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Account)' & '$(v_URL_Standard_End)' & accountid			as Soc_Lien,
	// Nouveau champs gélocalisation 
// 	 ard_straddress1latitude as Soc_Num_Address1_Latitude, 
//      ard_straddress1longitude as Soc_Num_strAddress1Longitude, 
//      ard_straddress1precisiongeo as Soc_Geo_strAddress1PrecisionGeo,
     '['&If((ard_straddress1longitude>=0 Or ard_straddress1longitude<=0) And (ard_straddress1latitude>=0 Or ard_straddress1latitude<=0),ard_straddress1longitude & ',' & ard_straddress1latitude)&']' as Soc_Geo_Position,
// 	 If((ard_straddress1longitude>=0 Or ard_straddress1longitude<=0) And (ard_straddress1latitude>=0 Or ard_straddress1latitude<=0), '$(vLibOui)', '$(vLibNon)') as Soc_Is_Position_GPS_Renseignee,
// 	 Timestamp(ard_datecategorie) as Soc_Date_Categorie,
// 	 ard_istopleague_FormattedValue as Soc_Is_Top_League,
// 	 new_sigle as Soc_Lib_Sigle,
// 	 new_siret as Soc_Lib_Siret,
// // 	 New_dossierreseauexplorer as Soc_Lib_Dossier_Reseau,
// //      ard_Source as Soc_Lib_Source,
	 ConvertToLocalTime(Timestamp(modifiedon), 'Paris') as Soc_Dtm_Modified_On,
//      ard_isavoir_FormattedValue as Soc_Is_IsAvoir,
//      _ard_avoirutilisateur_value_FormattedValue as Soc_Lib_Avoir_Utilisateur_Name,
//      Timestamp(ard_avoirdate) as Soc_Date_Avoir,
//      _ard_avoirgerant1_value_FormattedValue as Soc_Lib_Avoir_Gerant1_Name,
// //      _ard_avoirgerant2_value_FormattedValue as Soc_Lib_Avoir_Gerant2_Name,
// //      _ard_avoirgerant3_value_FormattedValue as Soc_Lib_AVoirGerant3_Name,
// //      ard_AvoirAnalysteIdName as Soc_Lib_Avoir_Analyste_Name,
//      if(match(ard_secteurcode,'173090008', '173090009','173090010') ,'$(vLibOui)','$(vLibNon)') as Soc_Is_Digital,
     _ownerid_value_FormattedValue & ',' & _new_gerant2id_value_FormattedValue & ',' & _new_gerant3id_value_FormattedValue & ',' & _new_analysteid_value_FormattedValue as #Soc_Lib_Gerant_Union,
//      ApplyMap('Map_Categorie_Societe_Color',accountcategorycode,black()) as Soc_Color_Categorie,

//      ard_taillecode as Soc_Id_Taille,
//      ard_typecode as Soc_Id_Type,
     _modifiedby_value_FormattedValue as Soc_Lib_Modified_By_Name,
     ConvertToLocalTime(Timestamp(ard_formmodifiedon), 'Paris') as Soc_Dtm_Form_Modified_On,
     if(not isnull(_ownerid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Gerant1_Short,
     if(not isnull(_new_gerant2id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_gerant2id_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Gerant2_Short,
     if(not isnull(_new_gerant3id_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_gerant3id_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Gerant3_Short,
     if(not isnull(_new_analysteid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_new_analysteid_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Analyste_Short,
     if(not isnull(_ard_formmodifiedbyid_value_FormattedValue), ApplyMap('Map_Gerant_Short',_ard_formmodifiedbyid_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Form_Modified_By_Name,
     _createdby_value_FormattedValue as Soc_Lib_Created_By_Name,
//      if(not isnull(_createdby_value_FormattedValue), ApplyMap('Map_Gerant_Short',_createdby_value_FormattedValue,'$(vLibAutres)')) as Soc_Lib_Created_By_Name_Short,
     
     ard_positionnementcode as Soc_Num_Positionnement,
     ard_ticketmaxm as Soc_Mon_TicketMax_M,
     ard_ticketmaxmclient as Soc_Mon_TicketMax_M_Client,
     ard_ticketmin as Soc_Mon_TicketMin,
//      ard_ticketminmclient as Soc_Mon_TicketMin_M_Client,
     ard_ticketpotentielmclient as Soc_Mon_Ticket_Potentiel_M_Client, 
     
     ard_positionnementfi as Soc_Num_Positionnement_FI,
     ard_dernieraum as Soc_Num_Last_AUM,
//      ard_Footprint as Soc_Lib_Footprint,
     if(ApplyMap('Map_Type_Gerant',_ownerid_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_new_gerant2id_value_FormattedValue) = 2
     	or ApplyMap('Map_Type_Gerant',_new_gerant3id_value_FormattedValue) = 2,1,0)											as Soc_Flag_Gerant_Analyste,
     if(ApplyMap('Map_Type_Gerant',_new_analysteid_value_FormattedValue) = 1,1,0)												as Soc_Flag_Analyste_Gerant,
     if(ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_new_gerant2id_value_FormattedValue,0) = 0
     	and ApplyMap('Map_Gerant_Actif',_new_gerant3id_value_FormattedValue,0) = 0,1,0)										as Soc_Flag_Gerant_Requis,
     if((ApplyMap('Map_Gerant_Actif',_ownerid_value_FormattedValue,0) = 0 and not IsNull(_ownerid_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_new_gerant2id_value_FormattedValue,0) = 0 and not IsNull(_new_gerant2id_value_FormattedValue))
     	or (ApplyMap('Map_Gerant_Actif',_new_gerant3id_value_FormattedValue,0) = 0 and not IsNull(_new_gerant3id_value_FormattedValue)),1,0)	as Soc_Flag_Clean_Gerant,
     if(_ownerid_value = _new_gerant2id_value
     	or _ownerid_value = _new_gerant3id_value
     	or _new_gerant3id_value = _new_gerant2id_value,1,0) 																as Soc_Flag_Gerant_Redondant,
     if(accountcategorycode = '173090009' and ApplyMap('Map_Affaire_Ouverte',accountid,0)=0,1,0)			as Soc_Flag_Affaire_Requise,
     if(ApplyMap('Map_Categorie_Concernant_Societe',accountcategorycode_FormattedValue,0)=2
     	and ApplyMap('Map_Activity_Email',accountid,0)=1,1,0)												as Soc_Flag_Concernant_Email,
     if(ApplyMap('Map_Categorie_Concernant_Societe',accountcategorycode_FormattedValue,0)=2
     	and ApplyMap('Map_Activity_RdvCall',accountid,0)=1,1,0)												as Soc_Flag_Concernant_Rdv_Call,
      	ard_datafeed as Soc_Is_Datafeed
FROM [$(v_FolderQVD_Path)Account.qvd]
(qvd);
// FROM [$(v_FolderQVD_Path)Account.qvd]
// (qvd);

TAG FIELDS Soc_Geo_Position WITH $geopoint;
TAG FIELDS Soc_Lib_Name WITH $geoname;

STORE Dim_Societe INTO [$(v_FolderQVD_Path_Store)Dim_Societe.qvd] (qvd);
// DROP table Dim_Societe;

End If

///$tab -- Debut 20 Societe Finance Values

///$tab Faits Get_Last_Values
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityFinance)*')>0 then

//===============================================================================//
// Création de la table des faits société à partir des données opérations
// Permet un suivi de tendance du nombre de société par date de création CRM
// N.B : utiliser le compteur de la Dim_Societe pour tout autre comptage dépendant
// des opération ou données financières
//===============================================================================//


IF  Not IsNull(QvdCreateTime('$(v_FolderQVD_Path)Finance.qvd')) THEN
  
    Faits_Finance:
	LOAD
//     	new_anneexercice as Fin_Year_Exercice,
		// Clé associatives
		_new_accountid_value AS Soc_Id,
// 		_new_accountid_value AS #Cle_Pivot_Gerant,
		// Le 1er jour de l'année est choisi comme clé période finance
		(new_anneexercice*10000) + 100 + 1 AS #Cle_Pivot_Periode, // YYYYMMDD
        new_anneexercice as AnneeFinance,
		// No operation segmentation
// 		'NA' AS #Cle_Operation,
		
		//Id fiche Finance
// 		new_financeid as Fin_Id,
// 		'Lien<url>' & '$(v_Url_Path_Finance)' & new_financeid AS Finance_Lien,
		
		// Mesures
		new_chiffreaffaire AS Fin_Mon_CA,
		new_ebit AS Fin_Mon_Ebit,
// 		new_ebitperct AS Fin_Prc_Ebit,
		new_ebitda AS Fin_Mon_Ebitda,
		new_effectif AS Fin_Num_Effectif,
// 		new_rn AS Fin_Mon_RC,
// 		new_tresorerie AS Fin_Mon_Tresorerie,
// 		new_dettefinanciere AS Fin_Mon_Dette,
// 		new_dettefinancierenet AS Fin_Mon_Dette_Net,
// // 		New_DividendesRecusKEuro AS Fin_Mon_Dividendes_Recus_Keuro,
// 		new_oc AS Fin_Mon_OC,
// 		new_chiffreaffaireperct as Fin_Prc_CA,
// 		new_ebitdaperct as Fin_Prc_Ebitda,
// 		new_rnperct as Fin_Prc_RN,
// 		Timestamp(new_isr) as Fin_Dtm_ISR,
// 		new_type_FormattedValue as New_type_Libellé,
//         ApplyMap('Map_CategoryCode', _new_accountid_value) as Societe_Categorie,  				// Add on 09/04/2018
		// new v1.1 2014/11/03 --> Calculate flag to determine null or empty cells
		if(IsNull(new_chiffreaffaire) OR new_chiffreaffaire='',0,1) AS #Flag_CA_Exists,
		if(IsNull(new_ebit) OR new_ebit='',0,1) AS #Flag_EBIT_Exists,
        if(IsNull(new_ebitda) OR new_ebitda='',0,1) AS #Flag_EBITDA_Exists,
        if(IsNull(new_effectif) OR new_effectif='',0,1) AS #Flag_Effectif_Exists,
        if(IsNull(new_chiffreaffaire) OR new_chiffreaffaire='',0,1)*if(IsNull(new_ebit) OR new_ebit='',0,1) as #Flag_PAIR_Exists,  // #TATOOLS# 
        if(IsNull(new_chiffreaffaire) OR new_chiffreaffaire='',0,1)*if(IsNull(new_ebitda) OR new_ebitda='',0,1) as #Flag_2nd_PAIR_Exists // #TATOOLS# 
//         ard_source as Fin_Lib_Source,
//         Timestamp(ard_datesaisie) as Fin_Dtm_Saisie
	FROM [$(v_FolderQVD_Path)Finance.qvd]
	(qvd)
	where ((new_anneexercice*10000) + 101 <= $(v_Current_YearStart))
    AND (new_anneexercice >= $(v_2014_Year));
    
    
	// -------------------------------------------------------
//     Faits_Finance:
//     NoConcatenate
// 	LOAD
// 		// Clé associatives
// 		Soc_Id,
// 		#Cle_Pivot_Gerant,
// 		#Cle_Pivot_Periode,
// 		#Cle_Operation,
// 		Fin_Id,
// 		Finance_Lien,
// 		Fin_Mon_CA,
// 		Fin_Mon_Ebit,
// 		Fin_Prc_Ebit,
// 		Fin_Mon_Ebitda,
// 		Fin_Num_Effectif,
// 		Fin_Mon_RC,
// 		Fin_Mon_Tresorerie,
// 		Fin_Mon_Dette,
// 		Fin_Mon_Dette_Net,
// // // 		Fin_Mon_Dividendes_Recus_Keuro,
// // 		Fin_Mon_OC,
// 		Fin_Prc_CA,
// 		Fin_Prc_Ebitda,
// 		Fin_Prc_RN,
// // 		Fin_Dtm_ISR,
// 		New_type_Libellé,
// 		#Flag_CA_Exists,
// 		#Flag_EBIT_Exists,
//         #Flag_EBITDA_Exists,
//         #Flag_CA_Exists*#Flag_EBIT_Exists as #Flag_PAIR_Exists,  // #TATOOLS# 
//         #Flag_CA_Exists*#Flag_EBITDA_Exists as #Flag_2nd_PAIR_Exists, // #TATOOLS# 
//         Fin_Lib_Source,
//         Fin_Dtm_Saisie
// 	Resident Faits_Finance_Temp;
//     // --------------------- WorkshopContext need Diane Categories => Comment Where clause  --------------------------------
// 	//WHERE not Wildmatch(Societe_Categorie, '*Diane*')  ;  	// Add on 09/04 to except Diane Accounts 
// 	DROP TABLE Faits_Finance_Temp;

// //Last CA-EBIT Year and Values

//     _Temp_Exist_Pair:
//     NoConcatenate
// //     LOAD distinct 
// //     	Soc_Id, 
// //         if(Fin_Year_Last_Pair1<=$(v_2014_Year), null(), Fin_Year_Last_Pair1 ) as Fin_Year_Last_Pair1, 
// //     	if(Fin_Year_Last_Pair1<=$(v_2014_Year), null(),Fin_Mon_Last_Pair1_CA) as Fin_Mon_Last_Pair1_CA, 
// //     	if(Fin_Year_Last_Pair1<=$(v_2014_Year), null(),Fin_Mon_Last_Pair1_EBIT) as Fin_Mon_Last_Pair1_EBIT;
//     LOAD distinct 
//     	Soc_Id, 
//     	if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Left(#Cle_Pivot_Periode,4), peek(Fin_Year_Last_Pair1)) as Fin_Year_Last_Pair1,
//         if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Fin_Mon_CA, peek(Fin_Mon_Last_Pair1_CA)) as Fin_Mon_Last_Pair1_CA,
//         if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Fin_Mon_Ebit, peek(Fin_Mon_Last_Pair1_EBIT)) as Fin_Mon_Last_Pair1_EBIT
// //     LOAD
// // 		Soc_Id,
// // 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_Pair,
// // 		Fin_Mon_Ebit AS %Dernier_EBIT,
// //         Fin_Mon_CA AS %Dernier_CA
// // //         #Flag_PAIR_Exists
// 	RESIDENT Faits_Finance
// 	WHERE #Flag_PAIR_Exists = 1
// 	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;


// last Pair CA EBITDA Year and values
	_Temp_Exist_Pair:
//     LOAD distinct 
//     	Soc_Id, 
//         if(Fin_Year_Last_Pair2<=$(v_2014_Year), null(), Fin_Year_Last_Pair2 ) as Fin_Year_Last_Pair2,
//     	if(Fin_Year_Last_Pair2<=$(v_2014_Year), null(),Fin_Mon_Last_Pair2_CA) as Fin_Mon_Last_Pair2_CA,
//     	if(Fin_Year_Last_Pair2<=$(v_2014_Year), null(),Fin_Mon_Last_Pair2_EBITDA) as Fin_Mon_Last_Pair2_EBITDA;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_Last_Pair2)) as Fin_Year_Last_Pair2,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_CA, peek(Fin_Mon_Last_Pair2_CA)) as Fin_Mon_Last_Pair2_CA,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_Ebitda, peek(Fin_Mon_Last_Pair2_EBITDA)) as Fin_Mon_Last_Pair2_EBITDA
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_Pair,
// 		Fin_Mon_Ebitda AS %Dernier_EBITDA,
//         Fin_Mon_CA AS %Dernier_CA
// //         #Flag_2nd_PAIR_Exists
	RESIDENT Faits_Finance
	WHERE #Flag_2nd_PAIR_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;


// //LAST CA and CA Year:
    OUTER JOIN(_Temp_Exist_Pair)
//     LOAD distinct
//     	Soc_Id,
//         Fin_Year_Last_CA,
//         Fin_Mon_Last_CA;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_Last_CA)) as Fin_Year_Last_CA,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_CA, peek(Fin_Mon_Last_CA)) as Fin_Mon_Last_CA
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_CA,
// 		Fin_Mon_CA AS %Dernier_CA
	RESIDENT Faits_Finance
	WHERE #Flag_CA_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;


// //LAST EBIT and EBIT Year

	OUTER JOIN(_Temp_Exist_Pair)
//     LOAD distinct
//     	Soc_Id,
//         Fin_Year_Last_EBIT,
//         Fin_Mon_Last_EBIT;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_Last_EBIT)) as Fin_Year_Last_EBIT,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_Ebit, peek(Fin_Mon_Last_EBIT)) as Fin_Mon_Last_EBIT
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_EBIT,
// 		Fin_Mon_Ebit AS %Dernier_EBIT
	RESIDENT Faits_Finance
	WHERE #Flag_EBIT_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;
    
    
// //LAST EBITDA and EBITDA Year

	OUTER JOIN(_Temp_Exist_Pair)
//     LOAD distinct
//     	Soc_Id,
//         Fin_Year_Last_EBITDA,
//         Fin_Mon_Last_EBITDA;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_Last_EBITDA)) as Fin_Year_Last_EBITDA,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_Ebitda, peek(Fin_Mon_Last_EBITDA)) as Fin_Mon_Last_EBITDA
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_EBITDA,
// 		Fin_Mon_Ebitda AS %Dernier_EBITDA
	RESIDENT Faits_Finance
	WHERE #Flag_EBITDA_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;
    
    
// //LAST Effectif and Effectif Year

	OUTER JOIN(_Temp_Exist_Pair)
//     LOAD distinct
//     	Soc_Id,
//         Fin_Year_Last_EBITDA,
//         Fin_Mon_Last_EBITDA;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_Last_Effectif)) as Fin_Year_Last_Effectif,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Num_Effectif, peek(Fin_Num_Last_Effectif)) as Fin_Num_Last_Effectif
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS %Dernier_Annee_EBITDA,
// 		Fin_Mon_Ebitda AS %Dernier_EBITDA
	RESIDENT Faits_Finance
	WHERE #Flag_Effectif_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode DESC;
    

///$tab Faits Get_First_Values
// //First CA and First CA Year:
    
    OUTER JOIN(_Temp_Exist_Pair)
//     LOAD distinct
//     	Soc_Id,
//         Fin_Year_First_CA,
//         Fin_Mon_First_CA;
    LOAD distinct 
    	Soc_Id, 
    	if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), AnneeFinance, peek(Fin_Year_First_CA)) as Fin_Year_First_CA,
        if(peek(Soc_Id) <> Soc_Id or isnull(previous(Soc_Id)), Fin_Mon_CA, peek(Fin_Mon_First_CA)) as Fin_Mon_First_CA
//     LOAD
// 		Soc_Id,
// 		Left(#Cle_Pivot_Periode,4) AS [%Premier_Annee_CA],
// 		Fin_Mon_CA AS %Premier_CA
	RESIDENT Faits_Finance
	WHERE #Flag_CA_Exists = 1
	ORDER BY Soc_Id asc, #Cle_Pivot_Periode ASC;


// // //FIRST EBIT and EBIT Year

// 	OUTER JOIN(_Temp_Exist_Pair)
// //     LOAD distinct
// //     	Soc_Id,
// //         Fin_Year_First_EBIT,
// //         Fin_Mon_First_EBIT;
//     LOAD distinct 
//     	Soc_Id, 
//     	if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Left(#Cle_Pivot_Periode,4), peek(Fin_Year_First_EBIT)) as Fin_Year_First_EBIT,
//         if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Fin_Mon_Ebit, peek(Fin_Mon_First_EBIT)) as Fin_Mon_First_EBIT
// //     LOAD
// // 		Soc_Id,
// // 		Left(#Cle_Pivot_Periode,4) AS %Premier_Annee_EBIT,
// // 		Fin_Mon_Ebit AS %Premier_EBIT
// 	RESIDENT Faits_Finance
// 	WHERE #Flag_EBIT_Exists = 1
// 	ORDER BY Soc_Id asc, #Cle_Pivot_Periode asc;
    
// // //FIRST EBITDA and EBITDA Year

// 	OUTER JOIN(_Temp_Exist_Pair)
// //     LOAD distinct
// //     	Soc_Id,
// //         Fin_Year_First_EBITDA,
// //         Fin_Mon_First_EBITDA;
//     LOAD distinct 
//     	Soc_Id, 
//     	if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Left(#Cle_Pivot_Periode,4), peek(Fin_Year_First_EBITDA)) as Fin_Year_First_EBITDA,
//         if(Previous(Soc_Id) <> Soc_Id or isnull(peek(Soc_Id)), Fin_Mon_Ebitda, peek(Fin_Mon_First_EBITDA)) as Fin_Mon_First_EBITDA
// //     LOAD
// // 		Soc_Id,
// // 		Left(#Cle_Pivot_Periode,4) AS %Premier_Annee_EBITDA,
// // 		Fin_Mon_Ebitda AS %Premier_EBITDA
// 	RESIDENT Faits_Finance
// 	WHERE #Flag_EBITDA_Exists = 1
// 	ORDER BY Soc_Id asc, #Cle_Pivot_Periode asc;
 
 	
 	Dim_Societe_Finance_Values:
	NoConcatenate
	LOAD *,
// 	     	if(Fin_Mon_Last_CA>'0' and Fin_Mon_Last_CA<='2000','$(vLastCA0)',
// 			if(Fin_Mon_Last_CA>'2000' and Fin_Mon_Last_CA<='10000','$(vLastCA2)',
// 			if(Fin_Mon_Last_CA>'10000' and Fin_Mon_Last_CA<='50000','$(vLastCA10)',
// 			if(Fin_Mon_Last_CA>'50000' and Fin_Mon_Last_CA<='100000','$(vLastCA50)',
// 			if(Fin_Mon_Last_CA>'100000','$(vLastCA100)'))))) as Fin_Lib_Last_CA_Tranche,
            
//         	if(Fin_Mon_Last_EBIT>'0' and Fin_Mon_Last_EBIT<='500','$(vLastEBIT0)',
// 			if(Fin_Mon_Last_EBIT>'1000' and Fin_Mon_Last_EBIT<='1000','$(vLastEBIT05)',
// 			if(Fin_Mon_Last_EBIT>'1000' and Fin_Mon_Last_EBIT<='2000','$(vLastEBIT1)',
// 			if(Fin_Mon_Last_EBIT>'2000' and Fin_Mon_Last_EBIT<='7000','$(vLastEBIT2)',
// 			if(Fin_Mon_Last_EBIT>'7000','$(vLastEBIT7)'))))) as  Fin_Lib_Last_EBIT_Tranche,
//             pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1 as Fin_Prc_CAGR,
			if(pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1>=num(0.5),'$(vColCAGR1)', 			
			if(pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1>=num(0.2),'$(vColCAGR2)' ,  
			if(pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1>=num(0.1),'$(vColCAGR3)',  
			if(pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1>=num(0.0),'$(vColCAGR4)', 			 
			if(pow((Fin_Mon_Last_CA/Fin_Mon_First_CA),(1/(Fin_Year_Last_CA-Fin_Year_First_CA)))-1<=num(0.0),'$(vColCAGR5)',  			
			'$(vColCAGR6)' )))))	as Fin_Col_CAGR
           ;
		LOAD
  			  Soc_Id,
  			  num(Fin_Year_Last_CA,'0') as Fin_Year_Last_CA,
  			  num(Fin_Mon_Last_CA,'0') as Fin_Mon_Last_CA,
  			  num(Fin_Year_Last_EBIT,'0') as Fin_Year_Last_EBIT,
              num(Fin_Mon_Last_EBIT,'0') as Fin_Mon_Last_EBIT,
              num(Fin_Year_Last_EBITDA,'0') as Fin_Year_Last_EBITDA,
              num(Fin_Mon_Last_EBITDA,'0') as Fin_Mon_Last_EBITDA,
              num(Fin_Year_Last_Effectif,'0') as Fin_Year_Last_Effectif,
              num(Fin_Num_Last_Effectif,'0') as Fin_Num_Last_Effectif,
//               num(Fin_Year_Last_Pair1,'0') as Fin_Year_Last_Pair1,
//               num(Fin_Mon_Last_Pair1_CA,'0') as Fin_Mon_Last_Pair1_CA,
//               num(Fin_Mon_Last_Pair1_EBIT,'0') as Fin_Mon_Last_Pair1_EBIT,
              num(Fin_Year_First_CA,'0') as Fin_Year_First_CA,
              num(Fin_Mon_First_CA,'0') as Fin_Mon_First_CA,
//               num(Fin_Year_First_EBIT,'0') as Fin_Year_First_EBIT,
//               num(Fin_Mon_First_EBIT,'0') as Fin_Mon_First_EBIT,
//               num(Fin_Year_First_EBITDA,'0') as Fin_Year_First_EBITDA,
//               num(Fin_Mon_First_EBITDA,'0') as Fin_Mon_First_EBITDA,
              num(Fin_Year_Last_Pair2,'0') as Fin_Year_Last_Pair2,
              num(Fin_Mon_Last_Pair2_CA,'0') as Fin_Mon_Last_Pair2_CA,
              num(Fin_Mon_Last_Pair2_EBITDA,'0')  as Fin_Mon_Last_Pair2_EBITDA
		Resident _Temp_Exist_Pair;
    
    //here
//     Rename Fields using FieldMap;
    
    DROP table _Temp_Exist_Pair;
    //here
    Drop table Faits_Finance;
    
ELSE

	TRACE QVD [$(v_FolderQVD_Path)Finance.qvd] Does not Exist;

ENDIF


STORE Dim_Societe_Finance_Values INTO [$(v_FolderQVD_Path_Store)Dim_Societe_Finance_Values.qvd] (qvd);
Drop Table Dim_Societe_Finance_Values;

End If

///$tab -- Debut 20 SysUser

///$tab SysUsers
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntitySystemUser)*')>0 then

NoConcatenate
Dim_SysUser:
LOAD
    systemuserid as User_Id,
//     FirstName as User_Lib_First_Name,
//     LastName as User_Lib_Last_Name,
    fullname as User_Lib_FullName,
    internalemailaddress as User_Lib_Email,
    ard_qlikname as User_Lib_QlikName,
    ard_qliktypecode as User_Id_QlikType,
    ard_qliktypecode_FormattedValue as User_Lib_QlikType
FROM [$(v_FolderQVD_Path)SystemUser.qvd]
(qvd);

STORE Dim_SysUser INTO [$(v_FolderQVD_Path_Store)Dim_SysUser.qvd] (qvd);
DROP TABLE Dim_SysUser;

End If

///$tab -- Debut 20 Tags

///$tab Tags
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntityTags)*','*$(sEntityTag_Attribution)*')>0 then

Dim_Tags_1:
LOAD
    ard_tagid as ard_tagId,
    ard_name,
    ard_description as Tag_Lib_Description,
//     'https://crm.ardian.com/AG/main.aspx?etc=10063&id=' & ard_tagid & '&pagetype=entityrecord' as Tag_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Tag)' & '$(v_URL_Standard_End)' & ard_tagid			as Tag_Lien,
    date(floor(num(createdon)),'DD/MM/YYYY') as Tag_Date_CreatedOn, 
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_ModifiedOn, 
    '$(vTypeTagAffaire)' as Tag_Type,
	_ard_gerant1id_value as Tag_Id_Gerant_1,
	_ard_gerant1id_value_FormattedValue as Tag_Lib_Gerant_1_Name,
    ApplyMap('Map_Gerant_Short',_ard_gerant1id_value_FormattedValue,'$(vLibAutres)') as Tag_Lib_Gerant_1_Name_Short,
	Null() as Tag_Id_Gerant_2,
	Null() as Tag_Lib_Gerant_2_Name,
    Null() as Tag_Lib_Gerant_2_Name_Short,
	Null() as Tag_Id_Gerant_3,
	Null() as Tag_Lib_Gerant_3_Name,
    Null() as Tag_Lib_Gerant_3_Name_Short
Resident Tags
where ard_isperimeteraffaire_FormattedValue='$(vLibOui)';

Left Join(Dim_Tags_1)
LOAD
    _ard_tagid_value as ard_tagId,
    _ard_affaireid_value as #Cle_Tag,
    ard_tagattributionid as Tag_Id_Attribution,
//     date(floor(num(CreatedOn)),'DD/MM/YYYY') as Tag_Date_Attribution_CreatedOn,
//     CreatedByName as Tag_Lib_Attribution_CreatedBy,
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_Attribution_ModifiedOn,
    _modifiedby_value_FormattedValue as Tag_Lib_Attribution_ModifiedBy
Resident Tag_Attribution;

Left Join(Dim_Tags_1)
Load
	ard_affaireid 			as #Cle_Tag,
    _ard_societeid_value 	as Soc_Id
Resident Affaire;

Left Join(Dim_Tags_1)
Load
	accountid							as Soc_Id,
    accountcategorycode_FormattedValue 	as Tag_Lib_Categorie
Resident Account;


Dim_Tags_2:
NoConcatenate
LOAD
    ard_tagid as ard_tagId,
    ard_name,
    ard_description as Tag_Lib_Description,
//     'https://crm.ardian.com/AG/main.aspx?etc=10063&id=' & ard_tagid & '&pagetype=entityrecord' as Tag_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Tag)' & '$(v_URL_Standard_End)' & ard_tagid			as Tag_Lien,
    date(floor(num(createdon)),'DD/MM/YYYY') as Tag_Date_CreatedOn, 
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_ModifiedOn, 
    '$(vTypeTagContact)' as Tag_Type,
	_ard_gerant1id_value as Tag_Id_Gerant_1,
	_ard_gerant1id_value_FormattedValue as Tag_Lib_Gerant_1_Name,
    ApplyMap('Map_Gerant_Short',_ard_gerant1id_value_FormattedValue,'$(vLibAutres)') as Tag_Lib_Gerant_1_Name_Short,
	Null() as Tag_Id_Gerant_2,
	Null() as Tag_Lib_Gerant_2_Name,
    Null() as Tag_Lib_Gerant_2_Name_Short,
	Null() as Tag_Id_Gerant_3,
	Null() as Tag_Lib_Gerant_3_Name,
    Null() as Tag_Lib_Gerant_3_Name_Short
Resident Tags
where ard_isperimetercontact_FormattedValue='$(vLibOui)';

Left Join(Dim_Tags_2)
LOAD
    _ard_tagid_value as ard_tagId,
    _ard_contactid_value as #Cle_Tag,
    ard_tagattributionid as Tag_Id_Attribution,
//     date(floor(num(CreatedOn)),'DD/MM/YYYY') as Tag_Date_Attribution_CreatedOn,
//     CreatedByName as Tag_Lib_Attribution_CreatedBy,
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_Attribution_ModifiedOn,
    _modifiedby_value_FormattedValue as Tag_Lib_Attribution_ModifiedBy
Resident Tag_Attribution;


Left Join(Dim_Tags_2)
Load
	contactid 					as #Cle_Tag,
    _parentcustomerid_value 	as Soc_Id
Resident Contact;

Left Join(Dim_Tags_2)
Load
	accountid							as Soc_Id,
    accountcategorycode_FormattedValue 	as Tag_Lib_Categorie
Resident Account;



Dim_Tags_3:
NoConcatenate
LOAD
    ard_tagid as ard_tagId,
    ard_name,
    ard_description as Tag_Lib_Description,
//     'https://crm.ardian.com/AG/main.aspx?etc=10063&id=' & ard_tagid & '&pagetype=entityrecord' as Tag_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Tag)' & '$(v_URL_Standard_End)' & ard_tagid			as Tag_Lien,
    date(floor(num(createdon)),'DD/MM/YYYY') as Tag_Date_CreatedOn, 
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_ModifiedOn, 
    '$(vTypeTagSociete)' as Tag_Type,
	_ard_gerant1id_value as Tag_Id_Gerant_1,
	_ard_gerant1id_value_FormattedValue as Tag_Lib_Gerant_1_Name,
    ApplyMap('Map_Gerant_Short',_ard_gerant1id_value_FormattedValue,'$(vLibAutres)') as Tag_Lib_Gerant_1_Name_Short,
	Null() as Tag_Id_Gerant_2,
	Null() as Tag_Lib_Gerant_2_Name,
    Null() as Tag_Lib_Gerant_2_Name_Short,
	Null() as Tag_Id_Gerant_3,
	Null() as Tag_Lib_Gerant_3_Name,
    Null() as Tag_Lib_Gerant_3_Name_Short
Resident Tags
where ard_isperimetersociete_FormattedValue='$(vLibOui)';

Left Join(Dim_Tags_3)
LOAD
    _ard_tagid_value as ard_tagId,
    _ard_accountid_value as #Cle_Tag,
    ard_tagattributionid as Tag_Id_Attribution,
//     date(floor(num(CreatedOn)),'DD/MM/YYYY') as Tag_Date_Attribution_CreatedOn,
//     CreatedByName as Tag_Lib_Attribution_CreatedBy,
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_Attribution_ModifiedOn,
    _modifiedby_value_FormattedValue as Tag_Lib_Attribution_ModifiedBy
Resident Tag_Attribution;

Left Join(Dim_Tags_3)
Load
	accountid 							as #Cle_Tag,
    accountcategorycode_FormattedValue 	as Tag_Lib_Categorie
Resident Account;

Dim_Tags_4:
NoConcatenate
LOAD
    ard_tagid as ard_tagId,
    ard_name,
    ard_description as Tag_Lib_Description,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Tag)' & '$(v_URL_Standard_End)' & ard_tagid			as Tag_Lien,
    date(floor(num(createdon)),'DD/MM/YYYY') as Tag_Date_CreatedOn, 
    date(floor(num(modifiedon)),'DD/MM/YYYY') as Tag_Date_ModifiedOn, 
    null() as Tag_Type,
	_ard_gerant1id_value as Tag_Id_Gerant_1,
	_ard_gerant1id_value_FormattedValue as Tag_Lib_Gerant_1_Name
Resident Tags
where ard_isperimeteraffaire_FormattedValue<>'$(vLibOui)'
and ard_isperimetercontact_FormattedValue<>'$(vLibOui)'
and ard_isperimetersociete_FormattedValue<>'$(vLibOui)';


NoConcatenate

Dim_Tags_tmp:
load
	*
Resident Dim_Tags_1;

Concatenate(Dim_Tags_tmp)
load
	*
Resident Dim_Tags_2;

Concatenate(Dim_Tags_tmp)
Load
	*
Resident Dim_Tags_3;

Concatenate(Dim_Tags_tmp)
Load
	*
Resident Dim_Tags_4;


NoConcatenate
Dim_Tags:
Load
	ard_tagId as Tag_Id,
    ard_name as Tag_Lib_Name,
    Tag_Lib_Description,
    Tag_Lib_Categorie,
    Tag_Lien,
    Tag_Date_CreatedOn,
    Tag_Date_ModifiedOn,
    Tag_Type,
    #Cle_Tag,
    Tag_Id_Attribution,
//     Tag_Date_Attribution_CreatedOn,
//     Tag_Lib_Attribution_CreatedBy,
    Tag_Date_Attribution_ModifiedOn,
    Tag_Lib_Attribution_ModifiedBy,
	Tag_Id_Gerant_1,
	Tag_Lib_Gerant_1_Name,
    Tag_Lib_Gerant_1_Name_Short,
	Tag_Id_Gerant_2,
	Tag_Lib_Gerant_2_Name,
    Tag_Lib_Gerant_2_Name_Short,
	Tag_Id_Gerant_3,
	Tag_Lib_Gerant_3_Name,
    Tag_Lib_Gerant_3_Name_Short
resident Dim_Tags_tmp;

drop tables Dim_Tags_1, Dim_Tags_2, Dim_Tags_3, Dim_Tags_4, Dim_Tags_tmp;


Map_Tag_Lib:
Mapping Load
	Tag_Id,
    Tag_Lib_Name
Resident Dim_Tags;

///$tab Hierarchy
SET vLevel0Id = '{0}';

TagAllFields_tmp:
Load
	*
FROM [$(v_FolderQVD_Path)Tags.qvd]
(qvd);

Concatenate(TagAllFields_tmp)
Load
	'DUMMY'	as DummyField,
	null() 	as _ard_level1id_value_FormattedValue,
	null() 	as _ard_level2id_value_FormattedValue,
	null() 	as _ard_level3id_value_FormattedValue,
	null() 	as _ard_level4id_value_FormattedValue,
	null() 	as _ard_level5id_value_FormattedValue,
	null() 	as _ard_level6id_value_FormattedValue,
	null() 	as _ard_level7id_value_FormattedValue,
	null() 	as _ard_level8id_value_FormattedValue,
	null() 	as _ard_level9id_value_FormattedValue,
	null() 	as _ard_level10id_value_FormattedValue,
	null() 	as _ard_level1id_value,
	null() 	as _ard_level2id_value,
	null() 	as _ard_level3id_value,
	null() 	as _ard_level4id_value,
	null() 	as _ard_level5id_value,
	null() 	as _ard_level6id_value,
	null() 	as _ard_level7id_value,
	null() 	as _ard_level8id_value,
	null() 	as _ard_level9id_value,
	null() 	as _ard_level10id_value
AutoGenerate 1;

TagAllFields:
NoConcatenate
Load
	*
Resident TagAllFields_tmp
Where DummyField <> 'DUMMY';

Drop Field DummyField;

Drop Table TagAllFields_tmp;

Hierarchy_Tags_tmp:
Load * Inline [
	ard_tagId, ard_name, Level, Flag_Is_Leaf, LevelName
    '$(vLevel0Id)', '$(vTagNameTags)', 0, 0, '$(vTagNameTags)'
];

Concatenate(Hierarchy_Tags_tmp)
LOAD Distinct
	ard_tagid 		as ard_tagId,
    ard_tagid		as Leaf_Id,
    ard_name,
    ard_description	as ard_Description,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Tag)' & '$(v_URL_Standard_End)' & ard_tagid		as Tag_Lien,
    date(floor(num(createdon)),'DD/MM/YYYY') 													as Tag_Date_CreatedOn, 
    date(floor(num(modifiedon)),'DD/MM/YYYY') 													as Tag_Date_ModifiedOn, 
    ApplyMap('Map_Date_Attribution_ModifiedOn',ard_tagid,Null())								as Tag_Date_Attribution_ModifiedOn,
	_ard_gerant1id_value 																		as Tag_Id_Gerant_1,
	_ard_gerant1id_value_FormattedValue 														as Tag_Lib_Gerant_1_Name,
    ApplyMap('Map_Gerant_Short',_ard_gerant1id_value_FormattedValue,'$(vLibAutres)') 			as Tag_Lib_Gerant_1_Name_Short,
//     Null()			as ard_Level11Id,
    ard_name						   as ard_Level0IdName,
    _ard_level1id_value_FormattedValue as ard_Level1IdName,
    _ard_level2id_value_FormattedValue as ard_Level2IdName,
    _ard_level3id_value_FormattedValue as ard_Level3IdName,
    _ard_level4id_value_FormattedValue as ard_Level4IdName,
    _ard_level5id_value_FormattedValue as ard_Level5IdName,
    _ard_level6id_value_FormattedValue as ard_Level6IdName,
    _ard_level7id_value_FormattedValue as ard_Level7IdName,
    _ard_level8id_value_FormattedValue as ard_Level8IdName,
    _ard_level9id_value_FormattedValue as ard_Level9IdName,
    _ard_level10id_value_FormattedValue as ard_Level10IdName,
    '$(vLevel0Id)'		as ard_Level0Id,
    _ard_level1id_value as ard_Level1Id,
    _ard_level2id_value as ard_Level2Id,
    _ard_level3id_value as ard_Level3Id,
    _ard_level4id_value as ard_Level4Id,
    _ard_level5id_value as ard_Level5Id,
    _ard_level6id_value as ard_Level6Id,
    _ard_level7id_value as ard_Level7Id,
    _ard_level8id_value as ard_Level8Id,
    _ard_level9id_value as ard_Level9Id,
    _ard_level10id_value as ard_Level10Id,
//     _ard_level1id_value & '///' & _ard_level2id_value & '///' & _ard_level3id_value & '///' & _ard_level4id_value
//     & '///' & _ard_level5id_value & '///' & ard_tagid as Tag_Path_Id,
    _ard_level1id_value & '///' & _ard_level2id_value & '///' & _ard_level3id_value & '///' & _ard_level4id_value
    & '///' & _ard_level5id_value & '///' & _ard_level6id_value & '///' & _ard_level7id_value
    & '///' & _ard_level8id_value & '///' & _ard_level9id_value & '///' & _ard_level10id_value & '///' & ard_tagid						as Tag_Path_Id,
	ard_name			as LevelName,
    1					as Flag_Is_Leaf,
    if(not IsNull(_ard_level10id_value_FormattedValue),11,
    	if(not IsNull(_ard_level9id_value_FormattedValue),10,
        	if(not IsNull(_ard_level8id_value_FormattedValue),9,
            	if(not IsNull(_ard_level7id_value_FormattedValue),8,
                	if(not IsNull(_ard_level6id_value_FormattedValue),7,
                    	if(not IsNull(_ard_level5id_value_FormattedValue),6,
                        	if(not IsNull(_ard_level4id_value_FormattedValue),5,
                            	if(not IsNull(_ard_level3id_value_FormattedValue),4,
                                	if(not IsNull(_ard_level2id_value_FormattedValue),3,
                                    	if(not IsNull(_ard_level1id_value_FormattedValue),2,1))))))))))								as Level,
    if(not IsNull(_ard_level10id_value_FormattedValue),_ard_level10id_value,
    	if(not IsNull(_ard_level9id_value_FormattedValue),_ard_level9id_value,
        	if(not IsNull(_ard_level8id_value_FormattedValue),_ard_level8id_value,
            	if(not IsNull(_ard_level7id_value_FormattedValue),_ard_level7id_value,
                	if(not IsNull(_ard_level6id_value_FormattedValue),_ard_level6id_value,
                    	if(not IsNull(_ard_level5id_value_FormattedValue),_ard_level5id_value,
                        	if(not IsNull(_ard_level4id_value_FormattedValue),_ard_level4id_value,
                            	if(not IsNull(_ard_level3id_value_FormattedValue),_ard_level3id_value,
                                	if(not IsNull(_ard_level2id_value_FormattedValue),_ard_level2id_value,
                                    	if(not IsNull(_ard_level1id_value_FormattedValue),_ard_level1id_value,'$(vLevel0Id)'))))))))))		as ParentId,
    if(not IsNull(_ard_level10id_value_FormattedValue),_ard_level10id_value_FormattedValue,
    	if(not IsNull(_ard_level9id_value_FormattedValue),_ard_level9id_value_FormattedValue,
        	if(not IsNull(_ard_level8id_value_FormattedValue),_ard_level8id_value_FormattedValue,
            	if(not IsNull(_ard_level7id_value_FormattedValue),_ard_level7id_value_FormattedValue,
                	if(not IsNull(_ard_level6id_value_FormattedValue),_ard_level6id_value_FormattedValue,
                    	if(not IsNull(_ard_level5id_value_FormattedValue),_ard_level5id_value_FormattedValue,
                        	if(not IsNull(_ard_level4id_value_FormattedValue),_ard_level4id_value_FormattedValue,
                            	if(not IsNull(_ard_level3id_value_FormattedValue),_ard_level3id_value_FormattedValue,
                                	if(not IsNull(_ard_level2id_value_FormattedValue),_ard_level2id_value_FormattedValue,
                                    	if(not IsNull(_ard_level1id_value_FormattedValue),_ard_level1id_value_FormattedValue,'$(vLevel0Id)'))))))))))	as ParentName,
    if(not IsNull(_ard_level10id_value_FormattedValue),_ard_level9id_value,
    	if(not IsNull(_ard_level9id_value_FormattedValue),_ard_level8id_value,
        	if(not IsNull(_ard_level8id_value_FormattedValue),_ard_level7id_value,
            	if(not IsNull(_ard_level7id_value_FormattedValue),_ard_level6id_value,
                	if(not IsNull(_ard_level6id_value_FormattedValue),_ard_level5id_value,
                    	if(not IsNull(_ard_level5id_value_FormattedValue),_ard_level4id_value,
                        	if(not IsNull(_ard_level4id_value_FormattedValue),_ard_level3id_value,
                            	if(not IsNull(_ard_level3id_value_FormattedValue),_ard_level2id_value,
                                	if(not IsNull(_ard_level2id_value_FormattedValue),_ard_level1id_value,		'$(vLevel0Id)')))))))))		as GrandParentId,
    if(not IsNull(_ard_level10id_value_FormattedValue),_ard_level9id_value_FormattedValue,
    	if(not IsNull(_ard_level9id_value_FormattedValue),_ard_level8id_value_FormattedValue,
        	if(not IsNull(_ard_level8id_value_FormattedValue),_ard_level7id_value_FormattedValue,
            	if(not IsNull(_ard_level7id_value_FormattedValue),_ard_level6id_value_FormattedValue,
                	if(not IsNull(_ard_level6id_value_FormattedValue),_ard_level5id_value_FormattedValue,
                    	if(not IsNull(_ard_level5id_value_FormattedValue),_ard_level4id_value_FormattedValue,
                        	if(not IsNull(_ard_level4id_value_FormattedValue),_ard_level3id_value_FormattedValue,
                            	if(not IsNull(_ard_level3id_value_FormattedValue),_ard_level2id_value_FormattedValue,
                                	if(not IsNull(_ard_level2id_value_FormattedValue),_ard_level1id_value_FormattedValue,'$(vLevel0Id)')))))))))		as GrandParentName
Resident TagAllFields;

Hierarchy_Tags_tmp2:
NoConcatenate
Load
	*
Resident Hierarchy_Tags_tmp
Where ParentId <> ard_tagId;

Drop Table Hierarchy_Tags_tmp;

Hierarchy_Tags_tmp3:
NoConcatenate
Load
	*
Resident Hierarchy_Tags_tmp2;

for i=1 to 10

	LET vParentLevel = if($(i)>0,$(i)-1,11);
	LET vGrandParentLevel = if($(i)>1,$(i)-2,10);
// 	LET vChildI = if($(i)<10,'ard_Level' & ($(i)+1) & 'Id','Dummy');
// 	LET vGrandParentFieldId = if($(i)>1,'ard_Level' & ($(i)-2) & 'Id','null()');
// 	LET vGrandParentFieldName = if($(i)>1,'ard_Level' & ($(i)-2) & 'IdName','null()');
    
    Concatenate(Hierarchy_Tags_tmp3)
    Load
    	ard_Level$(i)Id						as ard_tagId,
    	ard_name,
    	ard_Description,
    	Tag_Lien,
    	Tag_Date_CreatedOn, 
    	Tag_Date_ModifiedOn, 
    	Tag_Date_Attribution_ModifiedOn,
		Tag_Id_Gerant_1,
		Tag_Lib_Gerant_1_Name,
    	Tag_Lib_Gerant_1_Name_Short,
    	ard_Level1IdName,
    	ard_Level2IdName,
    	ard_Level3IdName,
    	ard_Level4IdName,
    	ard_Level5IdName,
    	ard_Level6IdName,
    	ard_Level7IdName,
    	ard_Level8IdName,
    	ard_Level9IdName,
    	ard_Level10IdName,
        ard_Level0Id,
    	ard_Level1Id,
    	ard_Level2Id,
    	ard_Level3Id,
    	ard_Level4Id,
    	ard_Level5Id,
    	ard_Level6Id,
    	ard_Level7Id,
    	ard_Level8Id,
    	ard_Level9Id,
    	ard_Level10Id,
//     	ard_Level1Id & '///' & ard_Level2Id & '///' & ard_Level3Id & '///' & ard_Level4Id
//     	& '///' & ard_Level5Id & '///' & ard_tagId						as Tag_Path_Id,
    	ard_Level1Id & '///' & ard_Level2Id & '///' & ard_Level3Id & '///' & ard_Level4Id
    	& '///' & ard_Level5Id & '///' & ard_Level6Id & '///' & ard_Level7Id
    	& '///' & ard_Level8Id & '///' & ard_Level9Id & '///' & ard_Level10Id & '///' & ard_tagId						as Tag_Path_Id,
        ard_Level$(i)IdName						as LevelName,
		ard_Level$(vParentLevel)Id				as ParentId,
        ard_Level$(vParentLevel)IdName			as ParentName,
// 		if(IsNull($(vChildI)),1,0)				as Flag_Is_Child,
// 		$(vGrandParentFieldId)					as GrandParentId,
//         $(vGrandParentFieldName)				as GrandParentName,
		ard_Level$(vGrandParentLevel)Id			as GrandParentId,
        ard_Level$(vGrandParentLevel)IdName		as GrandParentName,
        $(i)									as Level,
    	0										as Flag_Is_Leaf,
        ard_tagId								as Leaf_Id
    Resident Hierarchy_Tags_tmp2
    Where not IsNull(ard_Level$(i)IdName);
        
    for j = $(i) to 10
    
// 		LET vChildJ = if($(j)<10,'ard_Level' & ($(j)+1) & 'Id','Dummy');
            
    	Concatenate(Hierarchy_Tags_tmp3)
        Load
    		'1'									as Flag_Not_Leaf,
            ard_Level$(i)Id						as ard_tagId,
            ard_name,
    		ard_Description,
    		Tag_Lien,
    		Tag_Date_CreatedOn, 
    		Tag_Date_ModifiedOn, 
    		Tag_Date_Attribution_ModifiedOn,
			Tag_Id_Gerant_1,
			Tag_Lib_Gerant_1_Name,
    		Tag_Lib_Gerant_1_Name_Short,
            ard_Level1IdName,
            ard_Level2IdName,
            ard_Level3IdName,
            ard_Level4IdName,
            ard_Level5IdName,
            ard_Level6IdName,
            ard_Level7IdName,
            ard_Level8IdName,
            ard_Level9IdName,
            ard_Level10IdName,
            ard_Level0Id,
            ard_Level1Id,
            ard_Level2Id,
            ard_Level3Id,
            ard_Level4Id,
            ard_Level5Id,
            ard_Level6Id,
            ard_Level7Id,
            ard_Level8Id,
            ard_Level9Id,
            ard_Level10Id,
//     		ard_Level1Id & '///' & ard_Level2Id & '///' & ard_Level3Id & '///' & ard_Level4Id
//     		& '///' & ard_Level5Id & '///' & ard_tagId						as Tag_Path_Id,
    		ard_Level1Id & '///' & ard_Level2Id & '///' & ard_Level3Id & '///' & ard_Level4Id
    		& '///' & ard_Level5Id & '///' & ard_Level6Id & '///' & ard_Level7Id
    		& '///' & ard_Level8Id & '///' & ard_Level9Id & '///' & ard_Level10Id & '///' & ard_tagId						as Tag_Path_Id,
            ard_Level$(i)IdName						as LevelName,
			ard_Level$(vParentLevel)Id				as ParentId,
            ard_Level$(vParentLevel)IdName			as ParentName,
// 			if(IsNull($(vChildJ)),1,0)				as Flag_Is_Child,
// 			$(vGrandParentFieldId)					as GrandParentId,
//         	$(vGrandParentFieldName)				as GrandParentName,
			ard_Level$(vGrandParentLevel)Id			as GrandParentId,
        	ard_Level$(vGrandParentLevel)IdName		as GrandParentName,
            $(i)									as Level,
            0										as Flag_Is_Leaf,
            ard_Level$(j)Id							as Leaf_Id
        Resident Hierarchy_Tags_tmp2
        Where not IsNull(ard_Level$(i)IdName)
        and not IsNull(ard_Level$(j)Id);
        
	Next j
    
Next i

Left Join(Hierarchy_Tags_tmp3)
Load
	Tag_Id			as Leaf_Id,
    Tag_Lib_Name
Resident Dim_Tags;

Map_Is_Leaf:
Mapping Load
	Tag_Lib_Name,
    Flag_Not_Leaf
Resident Hierarchy_Tags_tmp3
Where Flag_Not_Leaf = 1;

Hierarchy_Tags_tmp4:
NoConcatenate
Load
	Leaf_Id											as Tag_Id,
	ard_tagId										as Tag_Hierarchy_Id,
	ard_name										as Tag_Hierarchy_Lib_Name,
	Flag_Is_Leaf									as Tag_Hierarchy_Flag_Is_leaf,
//     Flag_Is_Child									as Tag_Hierarchy_Flag_Is_Child,
	Level											as Tag_Hierarchy_Niveau,
	LevelName										as Tag_Hierarchy_Lib_Niveau,
	ParentId										as Tag_Hierarchy_Parent_Id,
    ParentName										as Tag_Hierarchy_Parent_Lib_Name,
//     ard_Description									as Tag_Hierarchy_Lib_Description,
//     Tag_Lien										as Tag_Hierarchy_Lien,
//     Tag_Date_CreatedOn								as Tag_Hierarchy_Date_CreatedOn,
//     Tag_Date_ModifiedOn								as Tag_Hierarchy_Date_ModifiedOn,
//     Tag_Date_Attribution_ModifiedOn					as Tag_Hierarchy_Date_Attribution_ModifiedOn,
// 	Tag_Id_Gerant_1									as Tag_Hierarchy_Id_Gerant_1,
// 	Tag_Lib_Gerant_1_Name							as Tag_Hierarchy_Lib_Gerant_1_Name,
//     Tag_Lib_Gerant_1_Name_Short						as Tag_Hierarchy_Lib_Gerant_1_Name_Short,
// 	Null() 											as Tag_Hierarchy_Id_Gerant_2,
// 	Null() 											as Tag_Hierarchy_Lib_Gerant_2_Name,
//     Null() 											as Tag_Hierarchy_Lib_Gerant_2_Name_Short,
// 	Null() 											as Tag_Hierarchy_Id_Gerant_3,
// 	Null() 											as Tag_Hierarchy_Lib_Gerant_3_Name,
//     Null() 											as Tag_Hierarchy_Lib_Gerant_3_Name_Short,
    GrandParentId									as Tag_Hierarchy_GrandParent_Id,
    GrandParentName									as Tag_Hierarchy_GrandParent_Lib_Name,
    if(ApplyMap('Map_Is_Leaf',Tag_Lib_Name,0)=0
    	and Tag_Lib_Name = ard_name,1,0)			as Tag_Hierarchy_Flag_Is_Child,
	SubField(Tag_Path_Id,'///')						as Tag_Hierarchy_Parents_Id
Resident Hierarchy_Tags_tmp3;

Left Join(Hierarchy_Tags_tmp4)
Load Distinct
	Tag_Id 											as Tag_Hierarchy_Id,
    Tag_Lib_Description								as Tag_Hierarchy_Lib_Description,
    Tag_Lien										as Tag_Hierarchy_Lien,
    Tag_Date_CreatedOn								as Tag_Hierarchy_Date_CreatedOn,
    Tag_Date_ModifiedOn								as Tag_Hierarchy_Date_ModifiedOn,
    Tag_Date_Attribution_ModifiedOn					as Tag_Hierarchy_Date_Attribution_ModifiedOn,
    Tag_Lib_Attribution_ModifiedBy					as Tag_Hierarchy_Date_Attribution_ModifiedBy,
	Tag_Id_Gerant_1									as Tag_Hierarchy_Id_Gerant_1,
	Tag_Lib_Gerant_1_Name							as Tag_Hierarchy_Lib_Gerant_1_Name,
    Tag_Lib_Gerant_1_Name_Short						as Tag_Hierarchy_Lib_Gerant_1_Name_Short,
	Tag_Id_Gerant_2									as Tag_Hierarchy_Id_Gerant_2,
	Tag_Lib_Gerant_2_Name							as Tag_Hierarchy_Lib_Gerant_2_Name,
    Tag_Lib_Gerant_2_Name_Short						as Tag_Hierarchy_Lib_Gerant_2_Name_Short,
	Tag_Id_Gerant_3									as Tag_Hierarchy_Id_Gerant_3,
	Tag_Lib_Gerant_3_Name							as Tag_Hierarchy_Lib_Gerant_3_Name,
    Tag_Lib_Gerant_3_Name_Short						as Tag_Hierarchy_Lib_Gerant_3_Name_Short
resident Dim_Tags;
	

Hierarchy_Tags:
NoConcatenate
Load
	*,
    ApplyMap('Map_Tag_Lib',Tag_Hierarchy_Parents_Id)			as Tag_Hierarchy_Parents_Lib_Name
Resident Hierarchy_Tags_tmp4
Where (not IsNull(Tag_Hierarchy_Parents_Id)
and trim(Tag_Hierarchy_Parents_Id) <> '')
or Tag_Hierarchy_Id = '$(vLevel0Id)';

left join(Hierarchy_Tags)
Load distinct
	Tag_Id,
    Tag_Hierarchy_Lib_Niveau as Tag_Hierarchy_Lib_SecondLevel
Resident Hierarchy_Tags_tmp4
where Tag_Hierarchy_Niveau = 2;

Drop Table Hierarchy_Tags_tmp2;
Drop Table Hierarchy_Tags_tmp3;
Drop Table Hierarchy_Tags_tmp4;

STORE Dim_Tags INTO [$(v_FolderQVD_Path_Store)Dim_Tags_New.qvd] (qvd);
DROP TABLE Dim_Tags;

STORE Hierarchy_Tags INTO [$(v_FolderQVD_Path_Store)Dim_Hierarchy_Tags.qvd] (qvd);
Drop Table Hierarchy_Tags;

End If

///$tab -- Debut 20 Vehicule

///$tab Vehicule
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityVehicle)*')>0 then

	Vehicule:
	LOAD
	    _ard_accountid_value					as Part_Id_Fonds,
	    ard_commentaire							as Veh_Lib_Commentaire,
	    ard_vehicleid							as Veh_Id,
	    ard_ticketmin							as Veh_Num_TicketMin,
	    ard_ticketmax							as Veh_Num_TicketMax,
	    ard_vintage								as Veh_Num_Vintage,
	    ard_taille								as Veh_Num_Taille,
	    ard_name								as Veh_Lib_Name,
        ard_isardianfofenlps_FormattedValue		as Veh_Is_Ardian_Fof
	FROM [$(v_FolderQVD_Path)Vehicle.qvd]
	(qvd);
	
	STORE Vehicule INTO [$(v_FolderQVD_Path_Store)Dim_Vehicule.qvd] (qvd);
	Drop Table Vehicule;

End If




///$tab Preparation 30
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntityOperation)*','*$(sEntityConnectionAllObjects)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*')>0 then

	Dim_Societe_30:
	Load
		Soc_Id,
	    Soc_Lib_Categorie,
		Soc_Is_Target,
		Soc_Is_Advisor,
    	Soc_Is_Portfolio,
    	Soc_Is_Diane,
	    Soc_Lib_Adresse1_Pays,
	    Soc_Address1_City,
	    Soc_Id_Gerant_1,
	    Soc_Lib_Gerant_1_Name,
	    Soc_Id_Gerant_2,
	    Soc_Lib_Gerant_2_Name,
	    Soc_Id_Gerant_3,
	    Soc_Lib_Gerant_3_Name,
	    Soc_Id_Analyste,
	    Soc_Lib_Analyste_Name,
        Soc_Dtm_Created_On,
	    Soc_Num_Positionnement_FI,
	    Soc_Mon_TicketMax_M,
	    Soc_Mon_TicketMin,
	    Soc_Num_Last_AUM,
	    Soc_Lib_Statut_Com,
	    Soc_Lib_Secteur,
	    Soc_Lib_Secteur_Short,
	    Soc_Lib_Objet,
        Soc_Is_Datafeed
	FROM [$(v_FolderQVD_Path_Store)Dim_Societe.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntityOperation)*','*$(sEntitySystemUser)*')>0 then

	Dim_Affaire_30:
	Load
		Aff_Id,
		Aff_Id_Societe,	 
		Aff_Id_Owner,
		Aff_Lib_Gerant_1_Name,
		Aff_Id_Analyste,
		Aff_Lib_Analyste_Name,
		Aff_Id_Gerant_2,
		Aff_Lib_Gerant_2_Name,
		Aff_Id_Gerant_3,
		Aff_Lib_Gerant_3_Name,
		Aff_Date_Statut,
		Aff_Date_Etape_Process,
		Aff_Lib_Etape_Process,
		Aff_Lib_Statut,
		Aff_Is_Last
	FROM [$(v_FolderQVD_Path_Store)Dim_Affaire.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActivityParty)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*','*$(sEntityOperation)*','*$(sEntitySystemUser)*','*$(sEntityStringMap)*')>0 then

	Dim_Contact_30:
	LOAD
		Con_Id,
		Con_Id_Societe,
		Con_Aff_Id,
		Con_Lib_Country,
		Con_Lib_Address_City,
		Con_Lib_Gerant_3_Name,
		Con_Lib_Gerant_2_Name,
		Con_Lib_Gerant_1_Name,
		Con_Id_Gerant1,
		Con_Id_Gerant2,
		Con_Id_Gerant3
	FROM [$(v_FolderQVD_Path_Store)Dim_Contact.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*','*$(sEntityOperation)*','*$(sEntityConnectionAllObjects)*')>0 then
	
	Dim_Operation_30:
	Load
	    Ope_Id,
	    Ope_Id_Societe
	FROM [$(v_FolderQVD_Path_Store)Dim_Operation.qvd]
	(qvd);

End If

If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*')>0 then
	
	Dim_Affaire_Contact_Intermediaire_30:
	Load Distinct
	    Interm_Id_Societe,
	    Interm_Id,
	    Interm_Id_Affaire,
	    Interm_Id_Cible
	FROM [$(v_FolderQVD_Path_Store)Dim_Affaire_Contact_Intermediaire.qvd]
	(qvd);

End If
	
///$tab -- Debut 25 Activities

///$tab Prep. Activite
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityContact)*','*$(sEntityStringMap)*','*$(sEntitySystemUser)*')>0 then

Activite:
LOAD Distinct
// 	Act_Id_RegardingObject as Soc_Id,
// 	Act_Id_RegardingObject as Con_Id,
// 	Act_Id_RegardingObject as #Cle_email,
//	Coalesce(Act_Id_RegardingObject, Act_Share_Lib_RegardingId)
	if(isnull(Act_Id_RegardingObject), Act_Share_Lib_RegardingId, Act_Id_RegardingObject) as Soc_Id,
	if(isnull(Act_Id_RegardingObject), Act_Share_Lib_RegardingId, Act_Id_RegardingObject) as Con_Id,
	if(isnull(Act_Id_RegardingObject), Act_Share_Lib_RegardingId, Act_Id_RegardingObject) as #Cle_email,
    if(isnull(Act_Id_RegardingObject), Act_Share_Lib_RegardingId, Act_Id_RegardingObject) as Act_Id_RegardingObject,
    Act_Lib_RegardingObject_Name,
    Act_Id,
    Act_Lib_Type,
    Act_Lib_Direction,
	Act_Lib_Owner_Name,
    Act_Lib_Owner_Name_Short,
    Act_Lib_Owner_Type,
    Act_Is_Active_Owner,
    Act_Dtm_CreatedOn,
    Act_Dtm_ModifiedOn,
    Act_Dtm_Scheduled_Start,
    Act_Dtm_Scheduled_End,
    Act_Lien,
    Act_Lib_Type_Name,
    Act_Lib_Subject,
    Act_Lib_Description,
    Act_Share_Lib_RegardingId,
    Act_Share_Lib_RegardingObject_Name,
//    Act_Share_ActivityId,
    if(Act_Lib_Type_Name='$(vActivityTypeNameRDV)'or Act_Lib_Type_Name='$(vActivityTypeNameAppel)','$(vActivityTypeNameRDV)','$(vActivityTypeNameMail)') as Act_Lib_Type_Name_Soc
FROM [$(v_FolderQVD_Path_Store)Dim_Activite.qvd]
(qvd);

///$tab Activité Société
_Temp_Dim_Activite_Societe:
LOAD Distinct
	 Soc_Id,
	 Soc_Lib_Categorie
// Resident Dim_Societe;
Resident Dim_Societe_30;

left Join(_Temp_Dim_Activite_Societe)
LOAD
	Soc_Id,
	#Cle_email,
    Act_Id_RegardingObject,
    Act_Lib_RegardingObject_Name,
    Act_Id,
    '$(vActivityTypeSociete)' as Act_Lib_Type,
	Act_Lib_Owner_Name,
    Act_Lib_Owner_Name_Short,
    Act_Lib_Direction,
    Act_Lib_Owner_Type,
    Act_Is_Active_Owner,
    Act_Dtm_CreatedOn,
    Act_Dtm_ModifiedOn,
    Act_Dtm_Scheduled_Start,
    Act_Dtm_Scheduled_End,
    Act_Lien,
    Act_Lib_Type_Name,
    Act_Lib_Subject,
    Act_Lib_Description,
    Act_Lib_Type_Name_Soc,
    Act_Share_Lib_RegardingId,
    Act_Share_Lib_RegardingObject_Name
//    Act_Share_ActivityId
Resident Activite;

STORE _Temp_Dim_Activite_Societe INTO [$(v_FolderQVD_Path_Store)_Temp_Dim_Activite_Societe.qvd] (qvd);
///$tab Activité Contact
_Temp_Dim_Activite_Contact:
NoConcatenate
LOAD Distinct
	 Soc_Id,
	 Soc_Lib_Categorie
// Resident Dim_Societe;
Resident Dim_Societe_30;

left Join(_Temp_Dim_Activite_Contact)
LOAD Distinct
    Con_Id_Societe		as Soc_Id,
    Con_Id
// Resident Dim_Contact;
Resident Dim_Contact_30;

left Join(_Temp_Dim_Activite_Contact)
LOAD
	Con_Id,
	#Cle_email,
    Act_Id_RegardingObject,
    Act_Lib_RegardingObject_Name,
    Act_Id,
    '$(vActivityTypeContact)' as Act_Lib_Type,
	Act_Lib_Owner_Name,
    Act_Lib_Owner_Name_Short,
    Act_Lib_Direction,
    Act_Lib_Owner_Type,
    Act_Is_Active_Owner,
    Act_Dtm_CreatedOn,
    Act_Dtm_ModifiedOn,
    Act_Dtm_Scheduled_Start,
    Act_Dtm_Scheduled_End,
    Act_Lien,
    Act_Lib_Type_Name,
    Act_Lib_Subject,
    Act_Lib_Description,
    Act_Lib_Type_Name_Soc,
    Act_Share_Lib_RegardingId,
    Act_Share_Lib_RegardingObject_Name
//    Act_Share_ActivityId
Resident Activite;

Drop Table Activite;

///$tab Last Activity
Dim_Activities:
NoConcatenate
Load Distinct
	*,
    if(Previous(#Cle_email) <> #Cle_email or isnull(Previous(#Cle_email)) or (Previous(Act_Lib_Type_Name) <> Act_Lib_Type_Name or isnull(Previous(Act_Lib_Type_Name))), 1, 0) as Act_Is_Last
Resident _Temp_Dim_Activite_Societe
Where Act_Id <> ''
and Not IsNull(Act_Id)
Order by #Cle_email asc, Act_Lib_Type_Name desc, Act_Dtm_Scheduled_Start desc;

Concatenate(Dim_Activities)
Load Distinct
	*,
    if(Previous(#Cle_email) <> #Cle_email or isnull(Previous(#Cle_email)) or (Previous(Act_Lib_Type_Name) <> Act_Lib_Type_Name or isnull(Previous(Act_Lib_Type_Name))), 1, 0) as Act_Is_Last
Resident _Temp_Dim_Activite_Contact
Where Act_Id <> ''
and Not IsNull(Act_Id)
Order by #Cle_email asc, Act_Lib_Type_Name desc, Act_Dtm_Scheduled_Start desc;

Drop Table _Temp_Dim_Activite_Contact;
Drop Table _Temp_Dim_Activite_Societe;

///$tab Aggr  Societe
Dim_Last_Societe_Activity:
NoConcatenate
Load
	*,
	if((Previous(Soc_Id) <> Soc_Id or isnull(Previous(Soc_Id))) or (Previous(Act_Lib_Type_Name_Soc) <> Act_Lib_Type_Name_Soc or isnull(Previous(Act_Lib_Type_Name_Soc))),1,0) as Act_Is_Societe_Last
Resident Dim_Activities
Order by Soc_Id asc, Act_Lib_Type_Name_Soc desc, Act_Dtm_Scheduled_Start desc;

STORE Dim_Activities INTO [$(v_FolderQVD_Path_Store)Dim_Activities.qvd] (qvd);
Store Dim_Last_Societe_Activity INTO [$(v_FolderQVD_Path_Store)Dim_Last_Societe_Activity.qvd] (qvd);

Drop Table Dim_Activities;
Drop Table Dim_Last_Societe_Activity;

End If

///$tab -- Debut 25 Fact Societe

///$tab Societe
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityContact)*')>0 then

Fact_Societe:
LOAD
    Soc_Id,
    Soc_Lib_Categorie,
    Soc_Dtm_Created_On,
    Soc_Is_Datafeed
Resident Dim_Societe_30;

left Join(Fact_Societe)
LOAD
    Aff_Id_Societe as Soc_Id,
    Aff_Id as Soc_Aff_Id
// Resident Dim_Affaire;
Resident Dim_Affaire_30;

left Join(Fact_Societe)
LOAD
    Con_Id_Societe as Soc_Id,   
    Con_Id as Soc_Con_Id
// Resident Dim_Contact;
Resident Dim_Contact_30;

STORE Fact_Societe INTO [$(v_FolderQVD_Path_Store)Fact_Societe.qvd] (qvd);
DROP table Fact_Societe;

End If


///$tab Preparation 30 (25)
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntityOperation)*','*$(sEntityConnectionAllObjects)*','*$(sEntitySystemUser)*')>0 then

	Dim_Activities_30:
	Load
	    Act_Lib_Owner_Name,
	    Act_Dtm_Scheduled_Start,
	    Act_Lien,
	    Con_Id,
	    Act_Lib_Description,
	    Act_Is_Last,
	    Act_Lib_Type_Name
	FROM [$(v_FolderQVD_Path_Store)Dim_Activities.qvd]
	(qvd);

End If

///$tab -- Debut 30 Actionnariat

///$tab Actionnariat
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

Dim_Actionnariat_tmp:
LOAD
    new_actionnaire as Part_Lib_Shareholder_Name,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Actionnariat)' & '$(v_URL_Standard_End)' & new_actionnaire			as Part_Lien_Shareholder,
//     'https://crm.ardian.com/AG/main.aspx?etc=10000&id=' & new_actionnariatid & '&pagetype=entityrecord'  as Part_Lien_Shareholder,
    year(new_anneeentree) as Part_Year_Entree,
//     new_commentaire as Part_Lib_Actionnariat_Commentaire,
    num(new_participationperct/100,'# ##0%',',',' ') as Part_Prc_Participation,
    _new_actionnairecorrespondancedianeid_value as Part_Id_Fonds,
    num(ard_pourcentagefd/100,'# ##0%',',',' ') as Part_Prc_FD,
    _new_accountid_value as Soc_Id,
    new_actionnariatid as Part_Id_Actionnariat,
    ApplyMap('Map_Population_Categorie',ApplyMap('Map_Categorie_Societe',_new_actionnairecorrespondancedianeid_value))	as Part_Lib_Fonds_Categorie
FROM [$(v_FolderQVD_Path)Actionnariat.qvd]
(qvd);

outer Join(Dim_Actionnariat_tmp)
LOAD
    ApplyMap('Map_Gerant_Short',_new_gerant2id_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Gerant2_Name,
    ApplyMap('Map_Gerant_Short',_new_analysteid_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Analyste_Name,
    ApplyMap('Map_Gerant_Short',_new_gerant3id_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Gerant3_Name,
    address1_city as Part_Lib_Ville,
//     ard_address1_country as Part_Id_Country,
    ard_address1_country_FormattedValue as Part_Lib_Pays,
	ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Gerant1_Name,
    accountid as Part_Id_Fonds,
    name as Part_Lib_Name,
//     '$(v_Url_Path_Societe)' & replace(replace(accountid,'{',''),'}','') & '&pagetype=entityrecord'  as Part_Lien,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Account)' & '$(v_URL_Standard_End)' & accountid			as Part_Lien,
    accountcategorycode_FormattedValue as Part_Lib_Categorie,
    new_objet as Part_Lib_Activity,
    accountid as Part_Id_Part,
    '$(v_URL_Standard)' & entityimage_url as Part_Lien_Photo,
    description as Part_Lib_Description,
//     date(createdon,'DD/MM/YYYY') as Part_Date_Created_On,
    new_commentairestatut   as Part_Lib_Commentaire,
    ard_straddress1latitude as Part_Num_Latitude,
    ard_straddress1longitude as Part_Num_Longitude,
    _ard_formmodifiedbyid_value_FormattedValue as Part_Lib_Modified_By_Name,
    date(ard_formmodifiedon,'DD/MM/YYYY') as Part_Date_Modified_On,
    _createdby_value_FormattedValue as Part_Lib_Created_By_Name,
    date(createdon,'DD/MM/YYYY') as Part_Date_Created_On,
    date(new_datedecreation,'DD/MM/YYYY') as Part_Date_Incorporated_On
Resident Account
where accountcategorycode=173090005;

left Join(Dim_Actionnariat_tmp)
LOAD
    address1_city as Part_Lib_Contact_Ville,
	ard_straddress1latitude  as Part_Num_Contact_Latitude,
    ard_straddress1longitude as Part_Num_Contact_Longitude,
    _parentcustomerid_value as Part_Id_Fonds,
    contactid as Part_Id_Contact,
    Capitalize(fullname) as Part_Lib_Contact_Name,
    ard_address1_country_FormattedValue as Part_Lib_Contact_Pays,
//     ard_lienurl as Part_Lien_Contact,
    '$(v_URL_Standard_Start)' & '$(v_EntityName_Contact)' & '$(v_URL_Standard_End)' & contactid			as Part_Lien_Contact,
    Timestamp(ard_avoirdate) as Part_Date_Contact_A_Voir,
    ApplyMap('Map_Gerant_Short',_ard_gerant2id_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Contact_Gerant_2_Name,
    ApplyMap('Map_Gerant_Short',_ard_gerant3id_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Contact_Gerant_3_Name,
// 	ard_isavoir_FormattedValue as Part_Is_Contact_A_Voir,
    emailaddress1 as Part_Lib_Contact_Email,
	jobtitle as Part_Lib_Contact_Title,
    date(floor(birthdate)) as Part_Date_Contact_Birth,
    telephone1 as Part_Num_Contact_Telephone,
    ApplyMap('Map_Gerant_Short',_ownerid_value_FormattedValue,'$(vLibAutres)') as Part_Lib_Contact_Gerant_1_Name,
    '$(v_URL_Standard)' & entityimage_url as Part_Lien_Contact_Photo,
    _ard_formmodifiedbyid_value_FormattedValue as Part_Lib_Contact_Form_Modified_By_Name,
	Timestamp(ard_formmodifiedon) as Part_Dtm_Contact_Form_Modified_On,
    date(createdon,'DD/MM/YYYY') as Part_Date_Contact_Created_On,
    _createdby_value_FormattedValue as Part_Lib_Contact_Created_By_Name,
	description as Part_Lib_Contact_Desc,
    mobilephone as Part_Num_Contact_Mobilephone,
    ard_lienlinkedinurl as Part_Lien_Contact_LinkedIn
Resident Contact_Actionnariat
where not isnull(_parentcustomerid_value);

left Join(Dim_Actionnariat_tmp)
LOAD
    Soc_Id as Part_Id_Fonds,
    Soc_Num_Positionnement_FI as Part_Num_Positionnement,
    Soc_Mon_TicketMax_M  as Part_Mon_TicketMax_M,
    Soc_Mon_TicketMin as Part_Mon_TicketMin,
	Soc_Num_Last_AUM as Part_Num_Last_AUM
//     Soc_Lib_Footprint as Part_Lib_Footprint
// Resident Dim_Societe;
Resident Dim_Societe_30;

Left join(Dim_Actionnariat_tmp)
LOAD
    Act_Lib_Owner_Name as Part_Lib_Contact_Last_RDVCall_Owner,
//     Act_Lib_Subject as Part_Lib_Contact_Last_RDVCall_Subject,
    Act_Dtm_Scheduled_Start as Part_Dtm_Contact_Last_RDVCall,
//     Act_Lib_Description as Part_Lib_Contact_Last_RDVCall_Description,
    Act_Lien as Part_Lien_Contact_Last_RDVCall,
    Con_Id as Part_Id_Contact
Resident Dim_Activities_30
where Act_Is_Last=1 and Act_Lib_Type_Name = '$(vActivityTypeNameRDV)';

Left join (Dim_Actionnariat_tmp)
LOAD
//     Act_Lib_Owner_Name as Part_Lib_Contact_Last_Mail_Owner,
//     Act_Lib_Subject as Part_Lib_Contact_Last_Mail_Subject,
    Act_Dtm_Scheduled_Start as Part_Dtm_Contact_Last_Mail,
    Act_Lien as Part_Lien_Contact_Last_Mail,
    Con_Id as Part_Id_Contact
Resident Dim_Activities_30
where Act_Is_Last=1 and Act_Lib_Type_Name = '$(vActivityTypeNameMail)';

// left Join(Dim_Actionnariat_tmp)
// LOAD
//     Soc_Id as Part_Id_Fonds,
// //     Act_Lib_Owner_Name as Part_Lib_Last_RDVCall_Owner,
// //     Act_Lib_Subject as Part_Lib_Last_RDVCall_Subject,
// //     Act_Dtm_Scheduled_Start as Part_Dtm_Last_RDVCall,
// //     Act_Lib_Description as Part_Lib_Last_RDVCall_Description,
//     Act_Lien as Part_Lien_Last_RDVCall
// Resident Dim_Activities
// where Act_Is_Last=1 and Act_Lib_Type_Name = '$(vActivityTypeNameRDV)';

// Left join(Dim_Actionnariat_tmp)
// LOAD
//     Soc_Id as Part_Id_Fonds,
// //     Act_Lib_Owner_Name as Part_Lib_Last_Mail_Owner,
// //     Act_Lib_Subject as Part_Lib_Last_Mail_Subject,
// //     Act_Dtm_Scheduled_Start as Part_Dtm_Last_Mail,
//     Act_Lien as Part_Lien_Last_Mail
// Resident Dim_Activities
// where Act_Is_Last=1 and Act_Lib_Type_Name = '$(vActivityTypeNameMail)';

Dim_Actionnariat:
NoConcatenate
Load
	*,
//     ApplyMap('Map_HasTag',Part_Id_Fonds,0)					as Part_Part_TopHasTag,
//     ApplyMap('Map_HasTag',Soc_Id,0)							as Part_Soc_TopHasTag,
//     ApplyMap('Map_HasTag',Part_Id_Contact,0)				as Part_Con_TopHasTag,
    Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/' & Part_Id_Contact	as #Cle_Part_Id
Resident Dim_Actionnariat_tmp;

Drop Table Dim_Actionnariat_tmp;



///$tab Link table Actionnariat
Link_Table_tmp:
Load Distinct
	Part_Id_Fonds,
    Soc_Id,
    Part_Id_Contact,
    Part_Id_Actionnariat
Resident Dim_Actionnariat;

Link_Table_Actionariat:
Load Distinct
	Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/' & Part_Id_Contact	as #Cle_Part_Id,
    Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/'						as #Cle_Part_Id_Fact,
	Part_Id_Fonds & '//' & Part_Id_Contact												as #Cle_Pivot_Gerant_Part,
	Part_Id_Fonds & '/' & Part_Id_Contact												as #Cle_Pivot_Pays_Part,
    '$(vPartLinkPart)'																	as Part_Link_Type
Resident Link_Table_tmp
Where not IsNull(Part_Id_Fonds)
or not IsNull(Part_Id_Actionnariat);

Concatenate(Link_Table_Actionariat)
Load Distinct
	Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/' & Part_Id_Contact	as #Cle_Part_Id,
    Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/' & Part_Id_Contact	as #Cle_Part_Id_Fact,
	Part_Id_Fonds & '//' & Part_Id_Contact												as #Cle_Pivot_Gerant_Part,
	Part_Id_Fonds & '/' & Part_Id_Contact												as #Cle_Pivot_Pays_Part,
    '$(vPartLinkPartCon)'																as Part_Link_Type
Resident Link_Table_tmp
Where not IsNull(Part_Id_Fonds)
or not IsNull(Part_Id_Contact)
 or not IsNull(Part_Id_Actionnariat);

Contact_Societe:
Load Distinct
	Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '/' & Part_Id_Contact	as #Cle_Part_Id,
	Part_Id_Fonds & '/' & Part_Id_Actionnariat & '/' & Soc_Id & '//' & Part_Id_Contact	as #Cle_Pivot_Gerant_Part,
	Part_Id_Fonds & '/' & Part_Id_Contact												as #Cle_Pivot_Pays_Part,
    Soc_Id,
    '$(vPartLinkSocCon)'																as Part_Link_Type
Resident Link_Table_tmp
Where not IsNull(Soc_Id);

Contact_Intermediaire:
LOAD 
     ard_affaireid, 
     contactid			as Con_Id
FROM
[$(v_FolderQVD_Path)Affaire_Contact_Intermediaire.qvd] (qvd);

Left Join(Contact_Intermediaire)
LOAD
    ard_affaireid 			as ard_affaireid,
    _ard_societeid_value	as Soc_Id
Resident Affaire;

Concatenate(Contact_Intermediaire)
Load Distinct
    _parentcustomerid_value									as Soc_Id,
    contactid												as Con_Id
Resident Contact;

Left Join(Contact_Societe)
Load Distinct
    Soc_Id,
    Soc_Id & '///' & Con_Id									as #Cle_Part_Id_Fact
Resident Contact_Intermediaire
Where not IsNull(Con_Id);

Concatenate(Link_Table_Actionariat)
Load Distinct
	#Cle_Part_Id,
    #Cle_Part_Id_Fact,
    #Cle_Pivot_Gerant_Part,
    #Cle_Pivot_Pays_Part,
    Part_Link_Type
Resident Contact_Societe;

Drop Table Contact_Intermediaire;
Drop Table Contact_Societe;
Drop Table Link_Table_tmp;

STORE Dim_Actionnariat INTO [$(v_FolderQVD_Path_Store)Dim_Actionnariat.qvd] (qvd);
DROP TABLE Dim_Actionnariat;

STORE Link_Table_Actionariat INTO [$(v_FolderQVD_Path_Store)Link_Table_Actionariat.qvd] (qvd);
DROP TABLE Link_Table_Actionariat;

End If

///$tab -- Debut 30 Contact Plus

///$tab Prep. Operations
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntityOperation)*','*$(sEntityConnectionAllObjects)*','*$(sEntitySystemUser)*')>0 then

Res_Operations:
LOAD
    RangeSum(count(distinct Ope_Id),0) as Con_Nb_Operations_Pre,
//     sum(Ope_Mon_Montant_Investissement_€) as Con_Sum_Montant_Investissement_€,
    Ope_Id_Societe as Con_Id_Societe
// Resident Dim_Operation
Resident Dim_Operation_30
group by Ope_Id_Societe;


///$tab Dim_Contact_Pre
Dim_Contact_Pre:
NoConcatenate
LOAD
    *
FROM [$(v_FolderQVD_Path_Store)Dim_Contact.qvd]
(qvd);


left Join(Dim_Contact_Pre)
Load
	*
Resident Res_Operations;

left Join(Dim_Contact_Pre)
LOAD
	Soc_Id as Con_Id_Societe,
// 	Soc_Lib_Description as Con_Lib_Societe_Description,
	Soc_Lib_Categorie as Con_Lib_Societe_Categorie,
	Soc_Is_Target as Con_Is_Societe_Target,
	Soc_Is_Advisor as Con_Is_Societe_Advisor,
    Soc_Is_Portfolio as Con_Is_Societe_Portfolio,
    Soc_Is_Diane as Con_Is_Societe_Diane,
	Soc_Lib_Statut_Com as Con_Lib_Societe_Statut_Com,
	Soc_Lib_Secteur as Con_Lib_Societe_Secteur,
	Soc_Lib_Objet as Con_Lib_Societe_Objet,
	Soc_Lib_Secteur_Short as Con_Lib_Societe_Secteur_Short
// Resident Dim_Societe;
Resident Dim_Societe_30;

//new LPs definition
left Join(Dim_Contact_Pre)
LOAD
//     name as Con_Lib_Societe_LP,
    _record2id_value as Con_Id_Societe_LP,
    _record1id_value as Con_Id,
	1 as Con_Is_2nd_LP_Definition
FROM [$(v_FolderQVD_Path)Dim_Connection_AllObjects.qvd]
(qvd)
where _record2roleid_value_FormattedValue = '$(vRecordRoleLP)';


//Nb opération LP
left Join(Dim_Contact_Pre)
Load
	Con_Id_Societe as Con_Id_Societe_LP,
// 	Con_Sum_Montant_Investissement_€ as Con_Sum_Montant_Investissement_€_LP,
	Con_Nb_Operations_Pre as Con_Nb_Operations_LP_Pre
Resident Res_Operations;



///$tab Dim_Contact
Dim_Contact_Plus_Prep:
NoConcatenate
Load
	*,
	if((Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)') or Con_Is_2nd_LP_Definition=1 ,1,0) as Con_Is_LP,
    if((Con_Nb_Operations_LP=0 and Con_Is_2nd_LP_Definition=1) or (Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)' and Con_Nb_Operations=0),1,0)  as Con_Is_Potential_LP,
    if(((Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)') or Con_Is_2nd_LP_Definition=1)
    and ((Con_Nb_Operations_LP<>0 or Con_Is_2nd_LP_Definition<>1) and (Con_Lib_Societe_Categorie<>'$(vCategorieSocieteClient)' or Con_Nb_Operations<>0)),'$(vTypeLPEffective)','$(vTypeLPPotential)')	as Con_Lib_Type_LP;
LOAD distinct
	Con_Id,
    Con_Id_Societe,
//     ApplyMap('Map_HasTag',Con_Id,0)				as Con_TopHasTag,
//     ApplyMap('Map_HasTag',Con_Id_Societe,0)		as Soc_TopHasTag,
    Con_Lib_Gerant_3_Name,
    Con_Lib_Gerant_2_Name,
    Con_Lib_Gerant_1_Name,
    Con_Num_Telephone,
    Con_Num_Mobilephone,
    Con_Date_Birth,
    Con_Lib_Email,
    Con_Lib_Name,
    Con_Lib_Title,
    Con_URL,
//     Con_Is_List_Event,
//     Con_Id_Cercle,
//     Con_Lib_Cercle,
//     Con_Is_CEN_Member,
//     Con_Lib_Address_Line1,
//     Con_Lib_Address_Line2,
    Con_Lib_Address_City,
//     Con_Lib_PostalCode,
//     Old_Pays_Contact,
    Con_Lib_Country,
//     Con_Is_Mailing,
//     Con_Lib_Langue_Echange,
    Con_Lib_Desc,
//     Con_Geo_Precision,
    Con_Geo_Latitude,
    Con_Geo_Longitude,
//     Con_Is_A_Voir,
//     Con_Lib_A_Voir_Utilisateur,
    Con_Date_A_Voir,
//     Con_Lib_A_Voir_Gerant1,
// //     Con_Lib_A_Voir_Gerant2,
// //     Con_Lib_A_Voir_Gerant3,
    Con_Dtm_Creation,
    Con_Dtm_Modification,
//     Con_Geo_Point,
//     Con_Lib_Modified_By_Name,
    Con_Dtm_Form_Modified_On,
    Con_Lib_Gerant1_Short,
    Con_Lib_Gerant2_Short,
    Con_Lib_Gerant3_Short,
    Con_Lib_Form_Modified_By_Name,
    Con_Lib_Created_By_Name,
// //     Con_Num_Positionnement,
// //     Con_Mon_Ticket_Max_M,
// //     Con_Mon_Ticket_Min_M,
    Con_Lien_LinkedIn,
    Con_Lien_Photo,
//     Con_Id_Gerant1,
//     Con_Id_Gerant2,
//     Con_Id_Gerant3,
    Con_Aff_Id,
//     Con_Sum_Montant_Investissement_€,
//     Con_Lib_Societe_Description,
    Con_Lib_Societe_Categorie,
	Con_Is_Societe_Target,
	Con_Is_Societe_Advisor,
    Con_Is_Societe_Portfolio,
    Con_Is_Societe_Diane,
    Con_Lib_Societe_Statut_Com,
    Con_Lib_Societe_Secteur,
    Con_Lib_Societe_Objet,
    Con_Lib_Societe_Secteur_Short,
//     Con_Lib_Societe_LP,
    Con_Is_2nd_LP_Definition,
    Con_Flag_Gerant_Analyste,
    Con_Flag_Gerant_Requis,
    Con_Flag_Clean_Gerant,
    Con_Flag_Gerant_Redondant,
    Con_Flag_Concernant_Email,
    Con_Flag_Concernant_Rdv_Call,
	Con_Id_Societe as Con_Id_Societe_LP,
	if(isnull(Con_Nb_Operations_Pre),0,Con_Nb_Operations_Pre) as Con_Nb_Operations,
    if(isnull(Con_Nb_Operations_LP_Pre),0,Con_Nb_Operations_LP_Pre) as Con_Nb_Operations_LP,
    Con_Is_Datafeed
Resident Dim_Contact_Pre
where Con_Is_2nd_LP_Definition<>1;

Concatenate(Dim_Contact_Plus_Prep)
Load
	*,
	if((Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)') or Con_Is_2nd_LP_Definition=1 ,1,0) as Con_Is_LP,
	if((Con_Nb_Operations_LP=0 and Con_Is_2nd_LP_Definition=1) or (Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)' and Con_Nb_Operations=0),1,0)  as Con_Is_Potential_LP,
    if(((Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)') or Con_Is_2nd_LP_Definition=1)
    and ((Con_Nb_Operations_LP<>0 or Con_Is_2nd_LP_Definition<>1) and (Con_Lib_Societe_Categorie<>'$(vCategorieSocieteClient)' or Con_Nb_Operations<>0)),'$(vTypeLPEffective)','$(vTypeLPPotential)')	as Con_Lib_Type_LP;
LOAD distinct 
	Con_Id,
    Con_Id_Societe,
//     ApplyMap('Map_HasTag',Con_Id,0)				as Con_TopHasTag,
//     ApplyMap('Map_HasTag',Con_Id_Societe,0)		as Soc_TopHasTag,
    Con_Lib_Gerant_3_Name,
    Con_Lib_Gerant_2_Name,
    Con_Lib_Gerant_1_Name,
    Con_Num_Telephone,
    Con_Num_Mobilephone,
    Con_Date_Birth,
    Con_Lib_Email,
    Con_Lib_Name,
    Con_Lib_Title,
    Con_URL,
//     Con_Is_List_Event,
//     Con_Id_Cercle,
//     Con_Lib_Cercle,
//     Con_Is_CEN_Member,
//     Con_Lib_Address_Line1,
//     Con_Lib_Address_Line2,
    Con_Lib_Address_City,
//     Con_Lib_PostalCode,
//     Old_Pays_Contact,
    Con_Lib_Country,
//     Con_Is_Mailing,
//     Con_Lib_Langue_Echange,
    Con_Lib_Desc,
//     Con_Geo_Precision,
    Con_Geo_Latitude,
    Con_Geo_Longitude,
//     Con_Is_A_Voir,
//     Con_Lib_A_Voir_Utilisateur,
    Con_Date_A_Voir,
//     Con_Lib_A_Voir_Gerant1,
// //     Con_Lib_A_Voir_Gerant2,
// //     Con_Lib_A_Voir_Gerant3,
    Con_Dtm_Creation,
    Con_Dtm_Modification,
//     Con_Geo_Point,
//     Con_Lib_Modified_By_Name,
    Con_Dtm_Form_Modified_On,
    Con_Lib_Gerant1_Short,
    Con_Lib_Gerant2_Short,
    Con_Lib_Gerant3_Short,
    Con_Lib_Form_Modified_By_Name,
    Con_Lib_Created_By_Name,
// //     Con_Num_Positionnement,
// //     Con_Mon_Ticket_Max_M,
// //     Con_Mon_Ticket_Min_M,
    Con_Lien_LinkedIn,
    Con_Lien_Photo,
//     Con_Id_Gerant1,
//     Con_Id_Gerant2,
//     Con_Id_Gerant3,
    Con_Aff_Id,
//     Con_Sum_Montant_Investissement_€,
//     Con_Lib_Societe_Description,
    Con_Lib_Societe_Categorie,
	Con_Is_Societe_Target,
	Con_Is_Societe_Advisor,
    Con_Is_Societe_Portfolio,
    Con_Is_Societe_Diane,
    Con_Lib_Societe_Statut_Com,
    Con_Lib_Societe_Secteur,
    Con_Lib_Societe_Objet,
    Con_Lib_Societe_Secteur_Short,
//     Con_Lib_Societe_LP,
    Con_Is_2nd_LP_Definition,
    Con_Flag_Gerant_Analyste,
    Con_Flag_Gerant_Requis,
    Con_Flag_Clean_Gerant,
    Con_Flag_Gerant_Redondant,
    Con_Flag_Concernant_Email,
    Con_Flag_Concernant_Rdv_Call,
	Con_Id_Societe_LP,
	if(isnull(Con_Nb_Operations_Pre),0,Con_Nb_Operations_Pre) as Con_Nb_Operations,
    if(isnull(Con_Nb_Operations_LP_Pre),0,Con_Nb_Operations_LP_Pre) as Con_Nb_Operations_LP
Resident Dim_Contact_Pre
where Con_Is_2nd_LP_Definition=1;

Left join (Dim_Contact_Plus_Prep)
LOAD
//     Act_Lib_Owner_Name as Con_Lib_Last_Mail_Owner,
//     Act_Lib_Subject as Con_Lib_Last_Mail_Subject,
    Act_Dtm_Scheduled_Start as Con_Dtm_Last_Mail,
    Act_Lien as Con_Lien_Last_Mail,
     Con_Id
Resident Dim_Activities_30
where Act_Is_Last=1
and Act_Lib_Type_Name = '$(vActivityTypeNameMail)';


Left join(Dim_Contact_Plus_Prep)
LOAD
    Act_Lib_Owner_Name as Con_Lib_Last_RDVCall_Owner,
//     Act_Lib_Subject as Con_Lib_Last_RDVCall_Subject,
    Act_Dtm_Scheduled_Start as Con_Dtm_Last_RDVCall,
    Act_Lib_Description as Con_Lib_Last_RDVCall_Description,
    Act_Lien as Con_Lien_Last_RDVCall,
     Con_Id
Resident Dim_Activities_30
where Act_Is_Last=1
and Act_Lib_Type_Name = '$(vActivityTypeNameRDV)';


Drop fields Con_Nb_Operations_Pre,Con_Nb_Operations_LP_Pre;





///$tab Dim Contact 2
rename field Con_Is_Potential_LP to Con_Is_Potential_LP_Pre;

NoConcatenate
Dim_Contact_Plus:
LOAD
	*
Resident Dim_Contact_Plus_Prep;

Left join(Dim_Contact_Plus)
LOAD
	Con_Id,
    min(Con_Is_Potential_LP_Pre) as Con_Is_Potential_LP
Resident Dim_Contact_Plus_Prep
group by Con_Id;
    
drop table Dim_Contact_Plus_Prep;
DROP table Res_Operations;
DROP table Dim_Contact_Pre;

STORE Dim_Contact_Plus INTO [$(v_FolderQVD_Path_Store)Dim_Contact_Plus.qvd] (qvd);
DROP table Dim_Contact_Plus;

End If

///$tab -- Debut 30 Email Partie

///$tab Mail Société
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityActivityParty)*','*$(sEntitySystemUser)*')>0 then

Activity_Detail:
LOAD
	Act_Id,
    Act_Id_Partie,
//     Act_Id_Object_Type,
    Act_Id_Participation_Mask,
    Act_Lib_Address,
    Act_Num_Address_Column,
    Act_Lib_Partie_Name,
    ApplyMap('Map_Gerant_Short',Act_Lib_Partie_Name)	as Act_Lib_Partie_Name_Short,
    Act_Is_Deleted
//     Act_Id_Instance_Type
FROM [$(v_FolderQVD_Path_Store)Dim_Email_Detail.qvd]
(qvd)
where Act_Id_Participation_Mask <= 6;


Dim_Activity_Partie_Liste:
NoConcatenate
Load
	Act_Id as #Act_Id_Partie, 
	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Sender_Parties,
	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Sender_Parties_Short
resident Activity_Detail
where Act_Id_Participation_Mask=1
group by Act_Id ;

Join(Dim_Activity_Partie_Liste)
Load
	Act_Id as #Act_Id_Partie, 
	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Receiver_Parties,
	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Receiver_Parties_Short
resident Activity_Detail
where Act_Id_Participation_Mask=2
group by Act_Id;

Join(Dim_Activity_Partie_Liste)
Load
	Act_Id as #Act_Id_Partie, 
	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Receiver_Copy_Parties,
	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Receiver_Copy_Parties_Short
resident Activity_Detail
where Act_Id_Participation_Mask=3
group by Act_Id;

// Join(Dim_Activity_Partie_Liste)
// Load
// 	Act_Id as #Act_Id_Partie, 
// 	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Receiver_Hidden_Copy_Parties,
// 	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Receiver_Hidden_Copy_Parties_Short
// resident Activity_Detail
// where Act_Id_Participation_Mask=4
// group by Act_Id;

Join(Dim_Activity_Partie_Liste)
Load
	Act_Id as #Act_Id_Partie, 
// 	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Mandatory_Parties,
	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Mandatory_Parties_Short
resident Activity_Detail
where Act_Id_Participation_Mask=5
group by Act_Id;

Join(Dim_Activity_Partie_Liste)
Load
	Act_Id as #Act_Id_Partie, 
// 	concat(DISTINCT upper(Act_Lib_Partie_Name),' | ') 			as Act_Lib_Optional_Parties,
	concat(DISTINCT upper(Act_Lib_Partie_Name_Short),' | ') 	as Act_Lib_Optional_Parties_Short
resident Activity_Detail
where Act_Id_Participation_Mask=6
group by Act_Id;


drop table Activity_Detail;

STORE Dim_Activity_Partie_Liste INTO [$(v_FolderQVD_Path_Store)Dim_Activity_Partie_Liste.qvd] (qvd);
Drop Table Dim_Activity_Partie_Liste;

End If

///$tab -- Debut 30 Gerant & Pivot

///$tab Creation Dim and Pivot
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivityParty)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

//========================================================================================================
// Création dela dimension Gérant et de la table pivot
//========================================================================================================


//=================
// Table pivot
//=================
Dim_Pivot_Gerant:
// Les propriétaires (Gérant 1)
LOAD DISTINCT
	// Clé Accosiative 
	Soc_Id AS #Cle_Pivot_Gerant,
	Soc_Id_Gerant_1 AS #Cle_Gerant,
	Soc_Lib_Gerant_1_Name AS Gerant,
	'$(vGerantTypeSociete)' AS Gerant_Type,
    '$(vGerantNiveau1)' AS Gerant_Niveau
// Resident Dim_Societe
Resident Dim_Societe_30
WHERE Not IsNull(Soc_Id_Gerant_1) AND Soc_Id_Gerant_1<>'';

// Les gérants 2
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Soc_Id AS #Cle_Pivot_Gerant,
	Soc_Id_Gerant_2 AS #Cle_Gerant,
	Soc_Lib_Gerant_2_Name AS Gerant,
	'$(vGerantTypeSociete)' AS Gerant_Type,
    '$(vGerantNiveau2)' AS Gerant_Niveau
// Resident Dim_Societe
Resident Dim_Societe_30
WHERE Not IsNull(Soc_Id_Gerant_2) AND Soc_Id_Gerant_2<>'';

// Les gérants 3
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Soc_Id AS #Cle_Pivot_Gerant,
	Soc_Id_Gerant_3 AS #Cle_Gerant,
	Soc_Lib_Gerant_3_Name AS Gerant,
	'$(vGerantTypeSociete)' AS Gerant_Type,
    '$(vGerantNiveau3)' AS Gerant_Niveau
// Resident Dim_Societe
Resident Dim_Societe_30
WHERE Not IsNull(Soc_Id_Gerant_3) AND Soc_Id_Gerant_3<>'';

// Les gérants 4 Analystes
CONCATENATE
LOAD DISTINCT
	// Clé Accosiative 
	Soc_Id AS #Cle_Pivot_Gerant,
	Soc_Id_Analyste AS #Cle_Gerant,
	Soc_Lib_Analyste_Name AS Gerant,
	'$(vGerantTypeSociete)' AS Gerant_Type,
    '$(vGerantNiveauAnalyste)' AS Gerant_Niveau
// Resident Dim_Societe
Resident Dim_Societe_30
WHERE Not IsNull(Soc_Id_Analyste) AND Soc_Id_Analyste<>'';


// Les gérants Affaire

// Les gérants 1
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Aff_Id AS #Cle_Pivot_Gerant,
	Aff_Id_Owner AS #Cle_Gerant,
	Aff_Lib_Gerant_1_Name AS Gerant,
	'$(vGerantTypeAffaire)' AS Gerant_Type,
    '$(vGerantNiveau1)' AS Gerant_Niveau
// Resident Dim_Affaire
Resident Dim_Affaire_30
WHERE Not IsNull(Aff_Id_Owner) AND Aff_Id_Owner<>''; 

// Les gérants 2
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Aff_Id AS #Cle_Pivot_Gerant,
	Aff_Id_Gerant_2 AS #Cle_Gerant,
	Aff_Lib_Gerant_2_Name AS Gerant,
	'$(vGerantTypeAffaire)' AS Gerant_Type,
    '$(vGerantNiveau2)' AS Gerant_Niveau
// Resident Dim_Affaire
Resident Dim_Affaire_30
WHERE Not IsNull(Aff_Id_Gerant_2) AND Aff_Id_Gerant_2<>'';

// Les gérants 3
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Aff_Id AS #Cle_Pivot_Gerant,
	Aff_Id_Gerant_3 AS #Cle_Gerant,
	Aff_Lib_Gerant_3_Name AS Gerant,
	'$(vGerantTypeAffaire)' AS Gerant_Type,
    '$(vGerantNiveau3)' AS Gerant_Niveau
// Resident Dim_Affaire
Resident Dim_Affaire_30
WHERE Not IsNull(Aff_Id_Gerant_3) AND Aff_Id_Gerant_3<>'';

// Les gérants 4 Analystes
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Aff_Id AS #Cle_Pivot_Gerant,
	Aff_Id_Analyste AS #Cle_Gerant,
	Aff_Lib_Analyste_Name AS Gerant,
	'$(vGerantTypeAffaire)' AS Gerant_Type,
    '$(vGerantNiveauAnalyste)' AS Gerant_Niveau
// Resident Dim_Affaire
Resident Dim_Affaire_30
WHERE Not IsNull(Aff_Id_Analyste) AND Aff_Id_Analyste<>'';

// Les gérants Contact

// Les gérants 1
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Con_Id AS #Cle_Pivot_Gerant,
	Con_Id_Gerant1 AS #Cle_Gerant,
	Con_Lib_Gerant_1_Name AS Gerant,
	'$(vGerantTypeContact)' AS Gerant_Type,
    '$(vGerantNiveau1)' AS Gerant_Niveau
// Resident Dim_Contact
Resident Dim_Contact_30
WHERE Not IsNull(Con_Id_Gerant1) AND Con_Id_Gerant1<>''; 

// Les gérants 2
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Con_Id AS #Cle_Pivot_Gerant,
	Con_Id_Gerant2 AS #Cle_Gerant,
	Con_Lib_Gerant_2_Name AS Gerant,
	'$(vGerantTypeContact)' AS Gerant_Type,
    '$(vGerantNiveau2)' AS Gerant_Niveau
// Resident Dim_Contact
Resident Dim_Contact_30
WHERE Not IsNull(Con_Id_Gerant2) AND Con_Id_Gerant2<>'';

// Les gérants 3
Concatenate(Dim_Pivot_Gerant)
LOAD DISTINCT
	// Clé Accosiative 
	Con_Id AS #Cle_Pivot_Gerant,
	Con_Id_Gerant3 AS #Cle_Gerant,
	Con_Lib_Gerant_3_Name AS Gerant,
	'$(vGerantTypeContact)' AS Gerant_Type,
    '$(vGerantNiveau3)' AS Gerant_Niveau
// Resident Dim_Contact
Resident Dim_Contact_30
WHERE Not IsNull(Con_Id_Gerant3) AND Con_Id_Gerant3<>'';


// Pour gérer l'ordre des gérants vs. liste manuelle
LEFT JOIN (Dim_Pivot_Gerant)
Load * Inline [
	Gerant, Ordre
	Laurent FOATA, 1
	Antoine LACOUR, 2
	Alexis SAADA, 3
	Geoffroy DE LA GRANDIERE, 4
	Romain CHIUDINI, 5
];


// LOAD 
//      Gerant,
//      Ordre
// FROM [$(v_LocalSourcePath)liste_ordre_gerant.csv]
// (txt, codepage is 1252, embedded labels, delimiter is ',', msq);
	

// A compléter si besoin avec les Gérants 4 et analystes
	
//=======================
// Dimension des gérants
//=======================

_Temp_Dim_Gerant:
LOAD Distinct
	#Cle_Gerant,
	Gerant,
	if(isnull(Ordre) or Ordre = '',999999, Ordre) AS Ordre
RESIDENT Dim_Pivot_Gerant;
	
	
// tri les gérant suivant la liste de nom en entrée
Dim_Gerant:
NoConcatenate
LOAD
	#Cle_Gerant,
	Gerant
RESIDENT _Temp_Dim_Gerant
ORDER BY Ordre ASC;

DROP TABLE _Temp_Dim_Gerant;


Fac_Societe:
NoConcatenate
LOAD Distinct
    Soc_Id,
    Soc_Con_Id,
    Soc_Aff_Id
FROM [$(v_FolderQVD_Path_Store)Fact_Societe.qvd]
(qvd);

Concatenate(Fac_Societe)
Load Distinct
	Interm_Id_Societe		as Soc_Id,
    Interm_Id_Affaire		as Soc_Aff_Id,
    Interm_Id				as Soc_Con_Id
FROM [$(v_FolderQVD_Path)Dim_Affaire_Contact_Intermediaire.qvd]
(qvd);

Dim_Pivot_Gerant_Fact:
Load Distinct
	Soc_Id & '/' & Soc_Aff_Id & '/' & Soc_Con_Id	as #Cle_Pivot_Gerant_Fact,
	Soc_Id											as #Cle_Pivot_Gerant
Resident Fac_Societe;

Concatenate(Dim_Pivot_Gerant_Fact)
Load Distinct
	Soc_Id & '/' & Soc_Aff_Id & '/' & Soc_Con_Id	as #Cle_Pivot_Gerant_Fact,
	Soc_Aff_Id										as #Cle_Pivot_Gerant
Resident Fac_Societe;

Concatenate(Dim_Pivot_Gerant_Fact)
Load Distinct
	Soc_Id & '/' & Soc_Aff_Id & '/' & Soc_Con_Id	as #Cle_Pivot_Gerant_Fact,
	Soc_Con_Id										as #Cle_Pivot_Gerant
Resident Fac_Societe;

Left Join(Dim_Pivot_Gerant)
Load Distinct
	*
Resident Dim_Pivot_Gerant_Fact;

Drop Table Dim_Pivot_Gerant_Fact;
Drop Table Fac_Societe;


///$tab Gérant Email et pivot
Dim_Gerant_Activity:
LOAD
	Act_Id,
    if(Act_Id_Participation_Mask = 1
    	,'$(vGerantActivitySender)'
        , if(Act_Id_Participation_Mask = 2
        	,'$(vGerantActivityReceiver)'
        	, if(Act_Id_Participation_Mask = 5
            	, '$(vGerantActivityMandatory)'
                , if(Act_Id_Participation_Mask = 6
                	, '$(vGerantActivityOptional)'
                )
            )
        )
    ) as Gerant_Activity_Type,
    Act_Lib_Partie_Name													as Gerant_Activity,
    ApplyMap('Map_Gerant_Short',Act_Lib_Partie_Name,'$(vLibAutres)')	as Gerant_Activity_Short
FROM [$(v_FolderQVD_Path_Store)Dim_Email_Detail.qvd]
(qvd)
where Act_Id_Participation_Mask = 1
or Act_Id_Participation_Mask = 2
or Act_Id_Participation_Mask = 5
or Act_Id_Participation_Mask = 6;

STORE Dim_Pivot_Gerant INTO [$(v_FolderQVD_Path_Store)Dim_Pivot_Gerant.qvd] (qvd);
STORE Dim_Gerant INTO [$(v_FolderQVD_Path_Store)Dim_Gerant.qvd] (qvd);
STORE Dim_Gerant_Activity INTO [$(v_FolderQVD_Path_Store)Dim_Gerant_Activity.qvd] (qvd);

Drop table Dim_Pivot_Gerant;
Drop table Dim_Gerant;
Drop table Dim_Gerant_Activity;

End If

///$tab -- Debut 30 Pays

///$tab Pays
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityContact)*','*$(sEntityStringMap)*')>0 then

Dim_Pays:
LOAD
	value				as Pays_Lib_Name,
	attributevalue		as Pays_Id
FROM [$(v_FolderQVD_Path)StringMap.qvd]
(qvd)
Where attributename = 'ard_address1_country'
and langid='1036';


//=================
// Table pivot
//=================

NoConcatenate
Dim_Pivot_Pays:
LOAD DISTINCT
    Soc_Id					as #Cle_Pivot_Pays,
    Soc_Lib_Adresse1_Pays	as Pays,
    Soc_Address1_City		as City,
    '$(vTypePaysSociete)'	as Pays_Type
// Resident Dim_Societe
Resident Dim_Societe_30
WHERE Not IsNull(Soc_Lib_Adresse1_Pays)
and Soc_Lib_Adresse1_Pays<>'';

Concatenate(Dim_Pivot_Pays)
LOAD DISTINCT
    Con_Id					as #Cle_Pivot_Pays,
    Con_Lib_Country			as Pays,
    Con_Lib_Address_City	as City,
    '$(vTypePaysContact)'	as Pays_Type
// Resident Dim_Contact
Resident Dim_Contact_30
WHERE Not IsNull(Con_Lib_Country)
and Con_Lib_Country<>'';

Dim_Contact_Prep:
LOAD Distinct
    Con_Id_Societe,   
    Con_Id
// Resident Dim_Contact;
Resident Dim_Contact_30;

Concatenate(Dim_Contact_Prep)
Load
	Soc_Id	as Con_Id_Societe
// Resident Dim_Societe
Resident Dim_Societe_30
Where not Exists(Con_Id_Societe,Soc_Id);

Dim_Pivot_Pays_Fact:
Load
	Con_Id_Societe & '/' & Con_Id	as #Cle_Pivot_Pays_Fact,
	Con_Id_Societe					as #Cle_Pivot_Pays
Resident Dim_Contact_Prep;

Concatenate(Dim_Pivot_Pays_Fact)
Load
	Con_Id_Societe & '/' & Con_Id	as #Cle_Pivot_Pays_Fact,
	Con_Id							as #Cle_Pivot_Pays
Resident Dim_Contact_Prep;

Concatenate(Dim_Pivot_Pays_Fact)
Load
	Con_Id_Societe & '/'					as #Cle_Pivot_Pays_Fact,
	Con_Id_Societe							as #Cle_Pivot_Pays
Resident Dim_Contact_Prep;

Concatenate(Dim_Pivot_Pays_Fact)
Load
	'/' & Con_Id					as #Cle_Pivot_Pays_Fact,
	Con_Id							as #Cle_Pivot_Pays
Resident Dim_Contact_Prep;

Left Join(Dim_Pivot_Pays)
Load Distinct
	*
Resident Dim_Pivot_Pays_Fact;

Drop Table Dim_Pivot_Pays_Fact;
Drop Table Dim_Contact_Prep;

// STORE Dim_Pays INTO [$(v_FolderQVD_Path_Store)Dim_Pays.qvd] (qvd);
DROP table Dim_Pays;

STORE Dim_Pivot_Pays INTO [$(v_FolderQVD_Path_Store)Dim_Pivot_Pays.qvd] (qvd);
DROP table Dim_Pivot_Pays;

End If


///$tab -- Debut 30 Societe Plus

///$tab Last Activity Societe 
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActivite)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntitySystemUser)*')>0 then

Tmp:
LOAD
//     Soc_Address1_Country,
    Soc_Id,
//     Soc_Num_Number,
    Soc_Lib_Name,
//     Soc_Lib_Diane_Name,
    Soc_Dtm_Created_On,
    Soc_Lib_Description,
//     Soc_Id_Categorie,
    Soc_Lib_Categorie,
	Soc_Is_Target,
	Soc_Is_Advisor,
    Soc_Is_Portfolio,
    Soc_Is_Diane,
	Soc_Is_Big_Fish,
	Soc_Is_Chase,
    Soc_Lib_Population,
//     Soc_Id_Status_Code,
//     Soc_Lib_Status_Code,
//     Soc_Dtm_Statut,
//     Soc_Year_Statut,
    Soc_Date_Creation,
    Soc_Date_Incorporation,
//     Soc_Id_Gerant_1,
    Soc_Lib_Gerant_1_Name,
//     Soc_Id_Gerant_2,
    Soc_Lib_Gerant_2_Name,
//     Soc_Id_Gerant_3,
    Soc_Lib_Gerant_3_Name,
// //     Soc_Id_Gerant_4,
// //     Soc_Lib_Gerant_4_Name,
//     Soc_Id_Analyste,
    Soc_Lib_Analyste_Name,
//     Soc_Id_Code_Naf,				// Commenté par CLE le 26/07/2022
    Soc_Lib_Statut_Com,
//     Soc_Lib_Naf,					// Commenté par CLE le 26/07/2022
//     Soc_Lib_Transaction_Currency_Name,
    Soc_Address1_City,
//     Soc_Address1_Line1,
// //     Soc_Address1_Line2,
//     Soc_Address1_PostalCode,
    Soc_Address1_StateOrProvince,
//     Soc_Is_Fiche_A_Traiter,
//     Soc_Is_Fiche_Analyse,
//     Soc_Is_Cotation,
    Soc_Lib_Secteur,
//     Soc_Lib_Cotation,
    Soc_Lib_Objet,
//     Soc_Num_Counter,
    Soc_Lien,
//     Soc_Num_Address1_Latitude,
//     Soc_Num_strAddress1Longitude,
//     Soc_Geo_strAddress1PrecisionGeo,
    Soc_Geo_Position,
//     Soc_Is_Position_GPS_Renseignee,
//     Soc_Date_Categorie,
//     Soc_Is_Top_League,
//     Soc_Lib_Sigle,
//     Soc_Lib_Siret,
// //     Soc_Lib_Dossier_Reseau,
// //     Soc_Lib_Source,
    Soc_Dtm_Modified_On,
//     Soc_Is_IsAvoir,
//     Soc_Lib_Avoir_Utilisateur_Name,
//     Soc_Date_Avoir,
//     Soc_Lib_Avoir_Gerant1_Name,
// //     Soc_Lib_Avoir_Gerant2_Name,
// //     Soc_Lib_AVoirGerant3_Name,
// //     Soc_Lib_Avoir_Analyste_Name,
//     Soc_Is_Digital,
    #Soc_Lib_Gerant_Union,
//     Soc_Color_Categorie,
//     Soc_Id_Taille,
//     Soc_Id_Type,
    Soc_Lib_Modified_By_Name,
    Soc_Dtm_Form_Modified_On,
    Soc_Lib_Gerant1_Short,
    Soc_Lib_Gerant2_Short,
    Soc_Lib_Gerant3_Short,
    Soc_Lib_Analyste_Short,
    Soc_Lib_Form_Modified_By_Name,
    Soc_Lib_Created_By_Name,
    Soc_Num_Positionnement,
    Soc_Mon_TicketMax_M,
    Soc_Mon_TicketMax_M_Client,
    Soc_Mon_TicketMin,
//     Soc_Mon_TicketMin_M_Client,
    Soc_Mon_Ticket_Potentiel_M_Client,
    Soc_Lib_Parent_Categorie,
    Soc_Lib_Secteur_Short,
    Soc_Lien_Photo,
    Soc_Lib_Adresse1_Pays,
//     Soc_Num_Positionnement_FI,
    Soc_Num_Last_AUM,
//     Soc_Lib_Footprint,
    Soc_Flag_Gerant_Analyste,
    Soc_Flag_Analyste_Gerant,
    Soc_Flag_Gerant_Requis,
    Soc_Flag_Clean_Gerant,
    Soc_Flag_Gerant_Redondant,
    Soc_Flag_Affaire_Requise,
    Soc_Flag_Concernant_Email,
    Soc_Flag_Concernant_Rdv_Call,
    Soc_Is_Datafeed
FROM [$(v_FolderQVD_Path_Store)Dim_Societe.qvd]
(qvd);


Left Join(Tmp)
LOAD
    Soc_Id,
    Act_Dtm_Scheduled_Start as Soc_Dtm_Last_Mail,
    Act_Lien as Soc_Lien_Last_Mail
//     Act_Is_Societe_Last as Soc_Is_Last_Mail
FROM [$(v_FolderQVD_Path_Store)Dim_Last_Societe_Activity.qvd]
(qvd)
where Act_Is_Societe_Last=1
and Act_Lib_Type_Name='$(vActivityTypeNameMail)';

Left Join(Tmp)
LOAD
    Soc_Id,
    Act_Dtm_Scheduled_Start as Soc_Dtm_Last_RDVCALL,
    Act_Lien as Soc_Lien_Last_RDVCALL
//     Act_Lib_Type_Name as Soc_Lib_Last_RDVCALL_Type_Name
//     Act_Is_Societe_Last as Soc_Is_Last_RDVCALL
FROM [$(v_FolderQVD_Path_Store)Dim_Last_Societe_Activity.qvd]
(qvd)
where Act_Is_Societe_Last=1
and (Act_Lib_Type_Name='$(vActivityTypeNameRDV)');


Left Join(Tmp)
LOAD
	Aff_Id_Societe as Soc_Id,
	Aff_Date_Statut as Soc_Date_Last_Aff_Statut,
	Aff_Date_Etape_Process as Soc_Date_Last_Aff_Etape_Process,
// 	Aff_Lib_Etape_Process as Soc_Lib_Last_Aff_Etape_Process,
// 	Aff_Lib_Statut as Soc_Lib_Last_Aff_Statut,
	Aff_Is_Last
// Resident Dim_Affaire
Resident Dim_Affaire_30
where Aff_Is_Last=1;


///$tab Societe
Dim_Societe_Plus:
NoConcatenate
Load
	 *,
// 	 interval(today() - rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process),'DD') as Soc_Interval_Last_Exchange,
     if(
     	rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process) > today(),'$(vClasseSocExchange0)',
	 	if(
        	rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process) >= addmonths(today(), -3),'$(vClasseSocExchange3)',    
     		if(
            	rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process) >= addmonths(today(), -6),'$(vClasseSocExchange6)',
     			if(
                	rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process) >= addmonths(today(), -9),'$(vClasseSocExchange9)',
     				if(
                    	rangemax(Soc_Dtm_Last_RDVCALL,Soc_Dtm_Last_Mail,Soc_Date_Last_Aff_Statut,Soc_Date_Last_Aff_Etape_Process) >= addmonths(today(), -12),'$(vClasseSocExchange12)',
                        '$(vClasseSocExchangeSup12)'))))) as Soc_Classe_Date_Last_Exchange
resident Tmp;

drop table Tmp;

STORE Dim_Societe_Plus INTO [$(v_FolderQVD_Path_Store)Dim_Societe_Plus.qvd] (qvd);
Drop Table Dim_Societe_Plus;

End If

///$tab -- Debut 30 Fact Affaire Contact

///$tab Dim Apporteur d'Affaires
// Fact_Affaire_Contact_Intermediaire:
// LOAD
//     Interm_Id_Affaire,
//     Interm_Id,
// //     Interm_Lib_Type,
//     Interm_Id_Societe,
//     Interm_Lib_Societe,
//     Interm_Lib_Cible_Name,
// //     Interm_Id_Cible,
// //     Interm_Lib_Modified_By,
// //  	Interm_Dtm_Modified_On,
//     Interm_Lib_Categorie,
//     Interm_Lib_Pays,
//     Interm_Lib_Ville,
//     Interm_Lib_Secteur,
//     Interm_Lib_Secteur_Short,
//     Interm_Lib_Commentaire,
//     Interm_Geo_Position,
//     Interm_Lien,
//     Interm_Lib_Objet
// //     Interm_Lib_Description,
// //     Interm_Lib_Gerant1_Name,
// //     Interm_Lib_Gerant2_Name,
// //     Interm_Lib_Gerant3_Name,
// //     Interm_Lib_Analyste_Name,
// // //     Interm_Lib_Modified_By_Name,
// // // 	Interm_Lib_Modified_On,
// // 	Interm_Mon_Ticket_Max_M,
// // 	Interm_Mon_Ticket_Max_M_Client,
// // 	Interm_Mon_Ticket_Min,
// // 	Interm_Mon_Ticket_Min_Client,
// // 	Interm_Mon_Ticket_Potentiel_M_Client,
// //     ApplyMap('Map_HasTag',Interm_Id_Affaire,0)		as Interm_Aff_TopHasTag,
// //     ApplyMap('Map_HasTag',Interm_Id,0)				as Interm_Id_TopHasTag,
// //     ApplyMap('Map_HasTag',Interm_Id_Societe,0)		as Interm_Soc_TopHasTag,
// //     ApplyMap('Map_HasTag',Interm_Id_Cible,0)		as Interm_Cible_TopHasTag
// Resident Dim_Affaire_Contact_Intermediaire;

// // left Join(Fact_Affaire_Contact_Intermediaire)
// // LOAD
// //     Aff_Id as Interm_Id_Affaire,
// //     date(if(Aff_Lib_Origine='Marché',date(Daystart(Aff_Date_Deal_Marche),'DD/MM/YYYY'),
// //      DayStart(rangemax(  Aff_Dtm_Created_On,   
// // //     Aff_Date_Overriden_Created_On,    
// //     Aff_Date_2Pager,
// //     Aff_Date_Comite,
// //     Aff_Date_Demande_Contact_Effectuee,
// //     Aff_Date_Exclusivite,
// //     Aff_Date_Loi,
// //     Aff_Date_Management_Presentation,
// //     Aff_Date_NdaIm,
// //     Aff_Dtm_Ouverture,  
// //     Aff_Date_Relance_Effectuee,
// //     Aff_Date_Reponse_Recue,
// //     Aff_Date_Shortlisted,
// //     Aff_Date_Statut,
// //     Aff_Date_Teaser_Recu,    
// //     Aff_Date_Cession,
// //     Aff_Date_Teaser_Envoye,    
// //     Aff_Date_Etape_Process,    
// //     Aff_Date_RDV_Call_Dirigeant,    
// //     Aff_Date_Closing,    
// //     Aff_Date_Pre_Qualification,
// //     if(Aff_Id_Statut_Affaire=173090005,0,today()+1)))) ,'DD/MM/YYYY') as Interm_Date_Periode_Max,
// //      date(if(Aff_Lib_Origine='Marché',Daystart(Aff_Date_Deal_Marche), DayStart(rangemin(Aff_Dtm_Created_On, 
// // //     Aff_Date_Overriden_Created_On,    
// //     Aff_Date_2Pager,
// //     Aff_Date_Comite,
// //     Aff_Date_Demande_Contact_Effectuee,
// //     Aff_Date_Exclusivite,
// //     Aff_Date_Loi,
// //     Aff_Date_Management_Presentation,
// //     Aff_Date_NdaIm,
// //     Aff_Dtm_Ouverture,  
// //     Aff_Date_Relance_Effectuee,
// //     Aff_Date_Reponse_Recue,
// //     Aff_Date_Shortlisted,
// //     Aff_Date_Statut,
// //     Aff_Date_Teaser_Recu,    
// //     Aff_Date_Cession,
// //     Aff_Date_Teaser_Envoye,    
// //     Aff_Date_Etape_Process,    
// //     Aff_Date_RDV_Call_Dirigeant,    
// //     Aff_Date_Closing,    
// //     Aff_Date_Pre_Qualification))),'DD/MM/YYYY')   as Interm_Date_Periode_Min
// // Resident Dim_Affaire;

// STORE Fact_Affaire_Contact_Intermediaire INTO [$(v_FolderQVD_Path_Store)Fact_Affaire_Contact_Intermediaire.qvd] (qvd);
// Drop table Fact_Affaire_Contact_Intermediaire;


///$tab -- Debut 30 Link Tag

///$tab Prep.
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityActionnariat)*','*$(sEntityAffaire)*','*$(sEntityAffaire_Contact_Intermediaire)*','*$(sEntityContact)*','*$(sEntityConnectionAllObjects)*')>0 then

Dim_Actionnariat:
LOAD
    _new_actionnairecorrespondancedianeid_value as Part_Id_Fonds,
	_new_accountid_value as Soc_Id
FROM [$(v_FolderQVD_Path)Actionnariat.qvd]
(qvd);

outer Join(Dim_Actionnariat)
LOAD
    accountid as Part_Id_Fonds
Resident Account
where accountcategorycode=173090005;

left Join(Dim_Actionnariat)
LOAD
	_parentcustomerid_value as Part_Id_Fonds,
	contactid as Part_Id_Contact
Resident Contact
where not isnull(_parentcustomerid_value);


Dim_Contact_Pre:
LOAD
    Con_Id_Societe,
    Con_Id,
    Con_Aff_Id
// Resident Dim_Contact;
Resident Dim_Contact_30;


left Join(Dim_Contact_Pre)
LOAD
	Soc_Id as Con_Id_Societe,
	Soc_Lib_Categorie as Con_Lib_Societe_Categorie
// Resident Dim_Societe;
Resident Dim_Societe_30;

//new LPs definition
left Join(Dim_Contact_Pre)
LOAD
//     name as Con_Lib_Societe_LP,
    _record2id_value as Con_Id_Societe_LP,
    _record1id_value as Con_Id,
	1 as Con_Is_2nd_LP_Definition
FROM [$(v_FolderQVD_Path)Dim_Connection_AllObjects.qvd]
(qvd)
where _record2roleid_value_FormattedValue = '$(vRecordRoleLP)';


Dim_Contact_Prep:
NoConcatenate
LOAD distinct
	Con_Id,
    Con_Aff_Id,
    Con_Id_Societe_LP,
	if(Con_Lib_Societe_Categorie='$(vCategorieSocieteClient)'  or Con_Is_2nd_LP_Definition=1,1,0) as Con_Is_LP
Resident Dim_Contact_Pre;

Drop Table Dim_Contact_Pre;


///$tab Fact
Fact_List:
Load Distinct
    Soc_Id as #Cle_Societe,
    Soc_Aff_Id as Aff_Id,
    Soc_Con_Id as Con.Con_Id
FROM [$(v_FolderQVD_Path_Store)Fact_Societe.qvd]
(qvd);

Concatenate(Fact_List)
Load Distinct
    Con_Id_Societe_LP as #Cle_Societe,
    Con_Aff_Id as Aff_Id,
    Con_Id as Con.Con_Id
Resident Dim_Contact_Prep
Where Con_Is_LP=1;


Concatenate(Fact_List)
Load Distinct
    Interm_Id_Societe 		as #Cle_Societe,
    Interm_Id				as Con.Con_Id,
    Interm_Id_Affaire		as Aff_Id
// Resident Dim_Affaire_Contact_Intermediaire;
Resident Dim_Affaire_Contact_Intermediaire_30;

Concatenate(Fact_List)
Load Distinct
    Interm_Id_Societe 		as #Cle_Societe,
    Interm_Id_Affaire		as Aff_Id
// Resident Dim_Affaire_Contact_Intermediaire;
Resident Dim_Affaire_Contact_Intermediaire_30;

Concatenate(Fact_List)
Load Distinct
    Interm_Id_Cible 		as #Cle_Societe,
    Interm_Id				as Con.Con_Id,
    Interm_Id_Affaire		as Aff_Id
// Resident Dim_Affaire_Contact_Intermediaire;
Resident Dim_Affaire_Contact_Intermediaire_30;

Concatenate(Fact_List)
Load Distinct
    Interm_Id_Cible 		as #Cle_Societe,
    Interm_Id_Affaire		as Aff_Id
// Resident Dim_Affaire_Contact_Intermediaire;
Resident Dim_Affaire_Contact_Intermediaire_30;

Concatenate(Fact_List)
LOAD Distinct
    Soc_Id 					as #Cle_Societe,
    Part_Id_Contact 		as Con.Con_Id
Resident Dim_Actionnariat;


///$tab Link Table Tag
Link_Table_Tags:
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List;

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List;

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List;



Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/'								as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
or not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/'								as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
or not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '//' &	Con.Con_Id								as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
or not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '//' &	Con.Con_Id								as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
or not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	'/'& Aff_Id & '/' &	Con.Con_Id									as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Aff_Id)
or not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	'/'& Aff_Id & '/' &	Con.Con_Id									as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Aff_Id)
or not IsNull(Con.Con_Id);



Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '//'												as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe);

Concatenate(Link_Table_Tags)
Load Distinct
	'/' & Aff_Id & '/'												as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	'//' & Con.Con_Id												as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelDirect)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Con.Con_Id);


// Tags Hérités :
Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where (not IsNull(#Cle_Societe)
or not IsNull(Aff_Id))
and not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where (not IsNull(#Cle_Societe)
or not IsNull(Con.Con_Id))
and not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/' & Con.Con_Id					as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where (not IsNull(Aff_Id)
or not IsNull(Con.Con_Id))
and not IsNull(#Cle_Societe);



Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/'								as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
and not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '//' & Con.Con_Id								as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
and not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '/' & Aff_Id & '/'								as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
and not IsNull(Aff_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	'/' & Aff_Id & '/' & Con.Con_Id									as #Cle_Tag_Fact,
	Con.Con_Id														as #Cle_Tag,
    '$(vTagLinkCon)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Aff_Id)
and not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	#Cle_Societe & '//' & Con.Con_Id								as #Cle_Tag_Fact,
	#Cle_Societe													as #Cle_Tag,
    '$(vTagLinkSoc)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(#Cle_Societe)
and not IsNull(Con.Con_Id);

Concatenate(Link_Table_Tags)
Load Distinct
	'/' & Aff_Id & '/' & Con.Con_Id									as #Cle_Tag_Fact,
	Aff_Id															as #Cle_Tag,
    '$(vTagLinkAff)'												as Tag_Link_Type,
    '$(vTagLevelHerite)'											as Tag_Level_Type
Resident Fact_List
Where not IsNull(Aff_Id)
and not IsNull(Con.Con_Id);


DROP TABLE Fact_List;
DROP TABLE Dim_Actionnariat;
DROP TABLE Dim_Contact_Prep;

STORE Link_Table_Tags INTO [$(v_FolderQVD_Path_Store)Link_Table_Tags.qvd] (qvd);
DROP TABLE Link_Table_Tags;

End If

///$tab -- Debut 30 Operation Pivot

///$tab Prep
If WildMatch('$(sListEntities)','*$(sEntityALL)*','*$(sEntityAccount)*','*$(sEntityAffaire)*','*$(sEntityContact)*','*$(sEntityOperation)*')>0 then

Tmp_Affaire:
LOAD
    Aff_Id,
    Aff_Id_Societe as Ope_Id_Societe
// Resident Dim_Affaire;
Resident Dim_Affaire_30;

inner Join(Tmp_Affaire)
LOAD
    Ope_Id_Societe,
    Ope_Id
// Resident Dim_Operation;
Resident Dim_Operation_30;

// drop fields Ope_Id_Societe;


Tmp_Contact:
NoConcatenate
LOAD
    Con_Id_Societe as Ope_Id_Societe,    
    Con_Id
// Resident Dim_Contact;
Resident Dim_Contact_30;

inner Join(Tmp_Contact)
LOAD
    Ope_Id_Societe,
    Ope_Id
// Resident Dim_Operation;
Resident Dim_Operation_30;

// drop fields Ope_Id_Societe;


///$tab Treatment
Dim_Pivot_Operation:
//Operation Société
LOAD
	Ope_Id_Societe as #Cle_Operation,
	Ope_Id
// Resident Dim_Operation;
Resident Dim_Operation_30;

// Concatenate(Dim_Pivot_Operation)
// //Affaire
// Load
// 	Aff_Id as #Cle_Operation,
// 	Ope_Id
// Resident Tmp_Affaire;

// Concatenate(Dim_Pivot_Operation)
// //Contact
// Load
// 	Con_Id as #Cle_Operation,
// 	Ope_Id
// Resident Tmp_Contact;


Fac_Societe:
NoConcatenate
LOAD Distinct
    Soc_Id,
    Soc_Con_Id,
    Soc_Aff_Id
FROM [$(v_FolderQVD_Path_Store)Fact_Societe.qvd]
(qvd);

Concatenate(Fac_Societe)
LOAD Distinct
    _record2id_value as Soc_Id,
    _record1id_value as Soc_Con_Id
FROM [$(v_FolderQVD_Path)Dim_Connection_AllObjects.qvd](qvd)
where _record2roleid_value_FormattedValue = '$(vRecordRoleLP)';

Dim_Pivot_Operation_Fact:
Load
	Soc_Id & '/' & Soc_Aff_Id & '/' & Soc_Con_Id	as #Cle_Operation_Fact,
	Soc_Id											as #Cle_Operation
Resident Fac_Societe;

Left Join(Dim_Pivot_Operation)
Load Distinct
	*
Resident Dim_Pivot_Operation_Fact;

Drop Table Dim_Pivot_Operation_Fact;
Drop Table Fac_Societe;

Drop Table Tmp_Affaire;
Drop Table Tmp_Contact;

STORE Dim_Pivot_Operation INTO [$(v_FolderQVD_Path_Store)Dim_Pivot_Operation.qvd] (qvd);
Drop Table Dim_Pivot_Operation;

End If


///$tab Drop table
Store ReloadTimeTransfo into [$(v_FolderQVD_Path_Store)ReloadTimeTransfo.qvd] (qvd);
Drop Table ReloadTimeTransfo;


DO WHILE NoOfTables() > 0
	LET tableName = TableName(0);
	Trace Suppression de la table [$(tableName)];
	DROP TABLE [$(tableName)];
LOOP 
